{% extends "base2.html" %}
{% block title %}Word Scramble · LexiTale{% endblock %}

{% block content %}

<link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&family=Baloo+2:wght@700;800&display=swap" rel="stylesheet">

<div class="row justify-content-center mt-4">
  <div class="col-lg-7">
    <div class="card border-0 rounded-4 game-bg-v7">
      <div class="card-body p-4 p-md-5">

        <div class="d-flex justify-content-between align-items-center flex-wrap gap-3 mb-4 pb-3 border-bottom-soft">
          <div>
            <h3 class="fw-bolder mb-1 game-title-v7">Word Unscrambler Challenge!</h3>
            <p class="text-muted small mb-0 game-text-body">
              Unjumble the letters to reveal the secret word. Good luck!
            </p>
          </div>
          <div class="text-end score-box-v7">
            <div class="small text-muted game-text-body">Progress</div>
            <div class="score-number-v7">
              <span id="scoreCorrect">0</span>/<span id="scoreTotal">{{ puzzles|length }}</span>
            </div>
          </div>
        </div>

        {% if puzzles %}
        <div class="game-area-v7">

          <!-- LEVEL INDICATOR -->
          <div class="level-indicator-v7 mb-2">
            <span id="levelBadge" class="level-chip-v7">
              Level 1 · Easy (4 letters)
            </span>
            <div class="level-steps-v7">
              <span class="level-step-dot active" data-level="1"></span>
              <span class="level-step-dot" data-level="2"></span>
              <span class="level-step-dot" data-level="3"></span>
            </div>
          </div>

          <div id="puzzleDisplay" class="puzzle-display-v7 mb-4">
          </div>

          <div class="input-feedback-area text-center">
            <form id="scrambleForm" class="d-flex justify-content-center gap-3">
              <input type="text"
                     class="form-control form-control-lg scramble-input-v7"
                     placeholder="Type your guess here"
                     autocomplete="off"
                     autocapitalize="off"
                     id="scrambleInput">
              <button class="btn btn-lg btn-coral-v7" type="submit" id="checkButton">Check</button>
            </form>

            <div id="feedbackContainer" class="feedback-container-v7">
            </div>

            <button id="nextButton" class="btn btn-lg btn-success-v7 mt-4 px-5" style="display: none;">
              Next Puzzle <i class="bi bi-arrow-right"></i>
            </button>
            <button id="restartButton" class="btn btn-outline-secondary btn-sm rounded-pill mt-4" style="display: none;">
              Play Again from Level 1
            </button>
          </div>
        </div>

        {% else %}
        <div class="py-4 text-center text-muted small game-text-body">
          No words yet. Read a story or wait for your teacher to assign.
        </div>
        {% endif %}

      </div>
    </div>
  </div>
</div>


<script>
(function () {
  const puzzles = {{ puzzles | tojson }}; // Puzzles array from Flask
  const puzzleDisplay = document.getElementById('puzzleDisplay');
  const scrambleForm = document.getElementById('scrambleForm');
  const scrambleInput = document.getElementById('scrambleInput');
  const checkButton = document.getElementById('checkButton');
  const nextButton = document.getElementById('nextButton');
  const restartButton = document.getElementById('restartButton');
  const scoreCorrectEl = document.getElementById('scoreCorrect');
  const scoreTotalEl = document.getElementById('scoreTotal');
  const feedbackContainer = document.getElementById('feedbackContainer');

  const levelBadge = document.getElementById('levelBadge');
  const levelDots = document.querySelectorAll('.level-step-dot');

  let currentPuzzleIndex = 0;
  let correctCount = 0;
  let currentPuzzle = null;
  let currentLevel = 1; // 1: easy, 2: medium, 3: hard

  // --- Helpers: Level detection & UI ---

  function getLevelFromWord(word) {
    const len = (word || '').length;
    if (len === 4) return 1;      // Easy
    if (len === 5) return 2;      // Medium
    return 3;                     // Hard
  }

  function updateLevelUI(level) {
    if (levelBadge) {
      let label = '';
      if (level === 1) {
        label = 'Level 1 · Easy (4 letters)';
      } else if (level === 2) {
        label = 'Level 2 · Medium (5 letters)';
      } else {
        label = 'Level 3 · Hard (6+ letters)';
      }
      levelBadge.textContent = label;
    }
    if (levelDots && levelDots.length) {
      levelDots.forEach(dot => {
        const lvl = Number(dot.dataset.level);
        dot.classList.toggle('active', lvl === level);
      });
    }
  }

  function showLevelUp(level) {
    let text = '';
    if (level === 2) {
      text = "Great job! You have unlocked Level 2 – 5-letter words.";
    } else if (level === 3) {
      text = "Amazing. You are now on Level 3 – challenge words (6+ letters).";
    } else {
      return;
    }

    feedbackContainer.innerHTML = '';
    const msgElement = document.createElement('div');
    msgElement.className = 'feedback-message levelup-message active';
    msgElement.textContent = text;
    feedbackContainer.appendChild(msgElement);
  }

  // --- HTML Rendering Functions ---

  function renderLetters(scrambledText) {
    let html = '<div class="scramble-letters-v7">';
    for (const ch of scrambledText) {
      if (ch === ' ') {
        html += '<span class="scramble-letter-space-v7">&nbsp;</span>';
      } else {
        html += `<span class="scramble-letter-v7">${ch}</span>`;
      }
    }
    html += '</div>';
    return html;
  }

  function renderPuzzle(puzzle) {
    if (!puzzle) return;

    // Render the puzzle content
    puzzleDisplay.innerHTML = `
      <div class="scramble-number-circle mb-3">${currentPuzzleIndex + 1}</div>
      ${renderLetters(puzzle.scrambled)}
      ${puzzle.definition ? `<div class="small text-muted mt-3 game-text-body">Hint: ${puzzle.definition}</div>` : ''}
    `;

    // Reset any success styles on letters
    puzzleDisplay.querySelectorAll('.scramble-letter-v7').forEach(el => {
      el.classList.remove('correct');
      el.style.backgroundColor = '';
      el.style.color = '';
      el.style.borderColor = '';
      el.style.boxShadow = '';
      el.style.transform = '';
    });

    scrambleInput.value = '';
    scrambleInput.disabled = false;
    checkButton.disabled = false;
    nextButton.style.display = 'none';
    scrambleInput.focus();
  }

  // --- Game Flow Control ---

  function loadNextPuzzle() {
    if (currentPuzzleIndex < puzzles.length) {
      const upcoming = puzzles[currentPuzzleIndex];
      const newLevel = getLevelFromWord(upcoming.word);

      // If we are entering a new level (but not on the very first question),
      // show a "congrats" / level-up message.
      if (currentPuzzleIndex > 0 && newLevel > currentLevel) {
        showLevelUp(newLevel);
      } else {
        // Normal case: clear previous feedback when going to next puzzle
        feedbackContainer.innerHTML = '';
      }

      currentLevel = newLevel;
      updateLevelUI(currentLevel);

      currentPuzzle = upcoming;
      renderPuzzle(currentPuzzle);
    } else {
      showFinalScore();
    }
  }

  function showFinalScore() {
    feedbackContainer.innerHTML = '';

    puzzleDisplay.innerHTML = `
      <h4 class="fw-bold game-title-v7 mb-2">Game Complete</h4>
      <p class="score-number-v7 mb-1">${correctCount} out of ${puzzles.length} correct.</p>
      <p class="text-muted game-text-body mb-0">
        You have cleared all 3 levels. Select “Play Again from Level 1” to try a fresh mix of words.
      </p>
    `;

    if (levelBadge) {
      levelBadge.textContent = 'All levels complete';
    }
    if (levelDots && levelDots.length) {
      levelDots.forEach(dot => dot.classList.add('active'));
    }

    checkButton.style.display = 'none';
    scrambleInput.style.display = 'none';
    nextButton.style.display = 'none';   // hide Next on final screen
    restartButton.style.display = 'inline-block';
  }

  // --- Animated Feedback ---

  function showFeedback(isCorrect, message) {
    feedbackContainer.innerHTML = '';
    const msgElement = document.createElement('div');
    msgElement.className = 'feedback-message';

    if (isCorrect) {
      // Use Bootstrap Check Icon
      msgElement.innerHTML = `<span class="feedback-icon text-success-v7"><i class="bi bi-check-circle-fill"></i></span> ${message}`;
      msgElement.style.color = 'var(--success-color)';

      // Success animation for letters
      puzzleDisplay.querySelectorAll('.scramble-letter-v7').forEach(el => {
        el.classList.add('correct');
        el.style.backgroundColor = 'var(--success-color)';
        el.style.color = 'white';
        el.style.borderColor = 'var(--success-dark-color)';
        el.style.boxShadow = '0 5px 0 var(--success-dark-color-light)';
        el.style.transform = 'translateY(-2px)';
      });

    } else {
      // Use Bootstrap X Icon
      msgElement.innerHTML = `<span class="feedback-icon text-danger"><i class="bi bi-x-circle-fill"></i></span> ${message}`;
      msgElement.style.color = 'var(--coral-main)';

      // Animate the input field red and shake
      scrambleForm.classList.add('shake');
      setTimeout(() => scrambleForm.classList.remove('shake'), 500);
    }

    feedbackContainer.appendChild(msgElement);
    // Trigger CSS transition
    setTimeout(() => msgElement.classList.add('active'), 10);
  }

  // --- Event Handlers ---

  scrambleForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const guess = scrambleInput.value.trim().toLowerCase();
    const answer = (currentPuzzle.word || '').toLowerCase();

    if (!guess) return;

    // Clear any previous feedback
    feedbackContainer.innerHTML = '';

    if (guess === answer) {
      // Correct Answer
      correctCount++;
      scoreCorrectEl.textContent = correctCount;

      showFeedback(true, "Great work. You got it right.");

      scrambleInput.disabled = true;
      checkButton.disabled = true;
      nextButton.style.display = 'inline-block';

    } else {
      // Incorrect Answer
      showFeedback(false, "Not quite. Try one more time.");

      scrambleInput.value = '';
      scrambleInput.focus();
    }
  });

  nextButton.addEventListener('click', () => {
    currentPuzzleIndex++;
    loadNextPuzzle();
  });

  restartButton.addEventListener('click', () => {
    // Simple reload – backend will choose a fresh random set of words
    window.location.reload();
  });

  // --- Initialization ---
  if (puzzles.length > 0) {
    // Initial level indicator for first puzzle
    currentLevel = getLevelFromWord(puzzles[0].word);
    updateLevelUI(currentLevel);
  }
  loadNextPuzzle();
})();
</script>

<style>
:root {
    --coral-main: #ff6b6b;
    --coral-light: #ffd7cc;
    --ink: #111827;
    --muted: #6b7280;
    --paper: #ffffff;
    --success-color: #10b981;
    --success-dark-color: #047857;
    --success-light-color: #a7f3d0;
    --success-dark-color-light: #4ade80;
}

/* Fonts */
.game-title-v7, .score-number-v7, .btn, .feedback-message {
    font-family: 'Baloo 2', cursive;
    font-weight: 700;
}
.game-text-body, .scramble-input-v7, .scramble-letter-v7 {
    font-family: 'Fredoka', 'Nunito', sans-serif;
}
.score-box-v7, .game-title-v7 {
    color: var(--ink);
}

/* --- Layout & Container Styles --- */
.game-bg-v7 {
    background: linear-gradient(145deg, #fff7e5 0%, #fff2f2 50%, #fefcfb 100%) !important;
    border: 3px solid var(--coral-light);
    border-radius: 30px !important;
    box-shadow: 0 10px 30px rgba(255, 107, 107, 0.15);
}
.game-title-v7 {
    color: var(--coral-main);
    font-size: 2rem;
}
.score-number-v7 {
    font-size: 2.25rem;
    color: var(--ink);
}
.border-bottom-soft {
    border-bottom: 2px solid rgba(255, 107, 107, 0.15) !important;
}

/* --- Level Indicator --- */
.level-indicator-v7 {
    display: flex;
    align-items: center;
    justify-content: space-between;
}
.level-chip-v7 {
    padding: 0.3rem 1rem;
    border-radius: 999px;
    background: #fff4f4;
    color: var(--coral-main);
    font-size: 0.9rem;
    font-weight: 600;
    border: 1px solid rgba(255, 107, 107, 0.5);
    white-space: nowrap;
}
.level-steps-v7 {
    display: flex;
    align-items: center;
    gap: 0.4rem;
}
.level-step-dot {
    width: 10px;
    height: 10px;
    border-radius: 999px;
    background: #ffe0e0;
    opacity: 0.5;
}
.level-step-dot.active {
    background: var(--coral-main);
    opacity: 1;
}

/* --- Puzzle Display --- */
.puzzle-display-v7 {
    min-height: 150px;
    padding: 2rem 1.5rem;
    border-radius: 20px;
    background: var(--paper);
    border: 2px solid var(--coral-light);
    box-shadow: 0 4px 15px rgba(255, 107, 107, 0.12);

    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
}

/* Container for the letter tiles */
.scramble-letters-v7 {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    align-items: center;
    gap: 0.75rem;
    margin-top: 0.75rem;
}

/* Individual letter tiles */
.scramble-letter-v7 {
    width: 60px;
    height: 60px;
    border-radius: 12px;
    background: transparent;
    color: var(--ink);
    border: 3px solid var(--coral-light);
    font-size: 1.8rem;
    font-weight: 800;
    text-transform: uppercase;

    display: flex;
    align-items: center;
    justify-content: center;

    box-shadow: none;
    transform: translateY(0);
    transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1),
                border-color 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}
.scramble-letter-v7:hover {
    transform: translateY(-2px);
    border-color: var(--coral-main);
    cursor: grab;
}

/* Question number */
.scramble-number-circle {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--coral-main);
    color: white;
    font-size: 1.25rem;
    font-weight: 700;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 3px 8px rgba(255, 107, 107, 0.3);
}

/* --- Input & Button --- */
.scramble-input-v7 {
  max-width: 350px;
  height: 60px;
  text-align: center;
  font-size: 1.5rem;
  border: 2px solid var(--coral-light);
  border-radius: 999px !important;
}
.scramble-input-v7:focus {
  border-color: var(--coral-main) !important;
  box-shadow: 0 0 0 .3rem rgba(255,107,107,.35) !important;
}
.btn-coral-v7 {
  height: 60px;
  background: var(--coral-main);
  border-radius: 999px !important;
  box-shadow: 0 5px 12px rgba(255,107,107,.4);
  font-size: 1.25rem;
}
.btn-coral-v7:hover {
  background: #e86060;
  box-shadow: 0 7px 14px rgba(255,107,107,.5);
  transform: translateY(-1px);
}
.btn-success-v7 {
    background-color: var(--success-color);
    border-color: var(--success-color);
    border-radius: 999px !important;
    box-shadow: 0 5px 12px rgba(16, 185, 129, 0.4);
    font-size: 1.25rem;
}
.btn-success-v7:hover {
    background-color: #0e9f6e;
    box-shadow: 0 7px 14px rgba(16, 185, 129, 0.5);
    transform: translateY(-1px);
}

/* ----- Animated Feedback ----- */
.feedback-container-v7 {
    margin-top: 1.5rem;
    min-height: 40px;
}
.feedback-message {
    font-size: 1.75rem;
    opacity: 0;
    transform: translateY(10px);
    transition: opacity 0.3s, transform 0.3s;
}
.feedback-message.active {
    opacity: 1;
    transform: translateY(0);
}
.feedback-icon {
    font-size: 3rem;
    margin-right: 10px;
    vertical-align: middle;
}
.levelup-message {
    font-size: 1.3rem;
    color: var(--coral-main);
}

/* generic colors */
.text-success-v7 { color: var(--success-color); }
.text-danger { color: var(--coral-main) !important; }

@keyframes shake {
  0%, 100% { transform: translateX(0); }
  20%, 60% { transform: translateX(-10px); }
  40%, 80% { transform: translateX(10px); }
}
.shake {
    animation: shake 0.5s ease-in-out;
}
</style>

{% endblock %}
