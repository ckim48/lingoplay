{% extends "base.html" %}
{% block title %}Library · LingoPlay{% endblock %}
{% block content %}

<div class="card border-0 lp-card-modern overflow-hidden mt-4">
  <div class="card-body p-4 p-lg-5">
    <!-- Top bar -->
    <div class="d-flex flex-wrap gap-3 justify-content-between align-items-center mb-4">
      <h3 class="mb-0 fw-semibold">Library</h3>
      <a href="{{ url_for('story_new') }}" class="btn btn-lime-light">
        <i class="bi bi-magic me-1"></i> New Story
      </a>
    </div>

    <!-- Controls (no language select) -->
    <div class="row g-3 align-items-end mb-3">
      <div class="col-md-8">
        <label class="form-label small text-uppercase fw-bold text-muted">Search</label>
        <div class="input-group input-group-lg lp-input">
          <span class="input-group-text"><i class="bi bi-search"></i></span>
          <input id="libSearch" class="form-control" placeholder="Search by title, author, or keywords">
          <button class="btn btn-outline-secondary only-md" id="libClear" type="button" title="Clear">
            <i class="bi bi-x-circle"></i>
          </button>
        </div>
      </div>
      <div class="col-md-4">
        <label class="form-label small text-uppercase fw-bold text-muted">Sort</label>
        <select id="libSort" class="form-select form-select-lg lp-input">
          <option value="newest">Newest first</option>
          <option value="oldest">Oldest first</option>
          <option value="title">Title (A–Z)</option>
          <option value="author">Author (A–Z)</option>
        </select>
      </div>
    </div>



    <!-- Grid of cards -->
    <div id="libGrid" class="row g-4">
      {% for d in completes %}
        {% set title = d.story_title or 'Untitled Story' %}
        <div class="col-12 col-md-6 col-lg-4 lib-wrap"
             data-title="{{ title|lower }}"
             data-author="{{ (d.learner_name or 'guest')|lower }}"
             data-keywords="{{ (d.seed_prompt or '')|lower }}"
             data-created="{{ (d.created_at|string).strip() }}">
          <div class="card h-100 lp-story-card">
            <div class="card-body d-flex flex-column">
              <div class="d-flex align-items-start justify-content-between mb-2">
                <a href="{{ url_for('finish_view', draft_id=d.id) }}" class="stretched-link text-decoration-none">
                  <h5 class="card-title mb-0">{{ title }}</h5>
                </a>
                <span class="badge lp-badge-lang ms-2">{{ d.language|upper }}</span>
              </div>

              <div class="text-secondary small mb-2">
                <i class="bi bi-person"></i> {{ d.learner_name or 'guest' }}
              </div>

              <p class="card-text small flex-grow-1">
                <span class="fw-semibold">Keywords/Phonics:</span>
                {{ d.seed_prompt[:120] }}{% if d.seed_prompt|length > 120 %}…{% endif %}
              </p>
            </div>
            <div class="card-footer bg-transparent d-flex justify-content-between align-items-center">
              <span class="small text-secondary">
                <i class="bi bi-clock me-1"></i>{{ d.created_at|dt("%Y-%m-%d %H:%M") }}
              </span>
              <a href="{{ url_for('finish_view', draft_id=d.id) }}" class="btn btn-sm btn-outline-secondary">
                Read
              </a>
            </div>
          </div>
        </div>
      {% else %}
        <div class="col-12">
          <div class="text-secondary">No completed stories yet.</div>
        </div>
      {% endfor %}
    </div>
  </div>
</div>

<style>
  /* Lime palette */
  :root{
    --lp-lime-50:#f7fee7; --lp-lime-100:#ecfccb; --lp-lime-200:#d9f99d;
    --lp-lime-300:#bef264; --lp-lime-400:#a3e635; --lp-lime-500:#84cc16;
    --lp-lime-600:#65a30d; --lp-lime-700:#4d7c0f; --lp-border:#e5e7eb;
  }

  .lp-card-modern{ border-radius:18px; box-shadow:0 10px 30px rgba(2,6,23,.06), 0 2px 6px rgba(2,6,23,.04); }

  /* Inputs */
  .lp-input .input-group-text{ border-radius:.8rem 0 0 .8rem; border-right:0; background:#f8fafc; color:var(--lp-lime-700); }
  .lp-input .form-control{ border-left:0; border-radius:0 .8rem .8rem 0; }
  .lp-input .form-control:focus, .form-select.lp-input:focus{
    border-color:var(--lp-lime-400);
    box-shadow:0 0 0 .25rem rgba(132,204,22,.15);
  }
  .form-select.lp-input{ border-radius:.8rem; }

  /* Badges + buttons */
  .lp-badge-step{ background:var(--lp-lime-100); color:var(--lp-lime-700); border:1px solid var(--lp-lime-200); }
  .lp-badge-lang{ background:var(--lp-lime-50); color:var(--lp-lime-700); border:1px solid var(--lp-lime-200); font-weight:600; }
  .btn-lime-light{
    --bs-btn-color:var(--lp-lime-700);
    --bs-btn-bg:var(--lp-lime-100);
    --bs-btn-border-color:var(--lp-lime-200);
    --bs-btn-hover-color:var(--lp-lime-700);
    --bs-btn-hover-bg:var(--lp-lime-200);
    --bs-btn-hover-border-color:var(--lp-lime-300);
    --bs-btn-focus-shadow-rgb:132,204,22;
    --bs-btn-active-bg:var(--lp-lime-300);
    --bs-btn-active-border-color:var(--lp-lime-300);
  }

  /* Story cards */
  .lp-story-card{
    border:1px solid var(--lp-border);
    border-radius:14px;
    transition:transform .1s ease, box-shadow .2s ease, border-color .2s ease;
  }
  .lp-story-card:hover{
    transform:translateY(-2px);
    box-shadow:0 10px 24px rgba(2,6,23,.08);
    border-color:var(--lp-lime-200);
  }
  .lp-story-card .card-title{ font-weight:600; line-height:1.25; }

  /* Tweak the Read button */
  .lp-story-card .btn-outline-secondary{
    border-color:var(--lp-border);
  }
  .lp-story-card .btn-outline-secondary:hover{
    border-color:var(--lp-lime-300); color:var(--lp-lime-700); background:var(--lp-lime-100);
  }
  /* Greenish titles on story cards */
.lp-story-card .card-title{
  color: var(--lp-lime-700);        /* main green */
}

/* Slightly brighter on hover/focus for the whole card/link */
.lp-story-card:hover .card-title,
.lp-story-card a:focus-visible .card-title{
  color: var(--lp-lime-600);
}

/* Accessible focus ring on the clickable title area */
.lp-story-card a.stretched-link:focus-visible{
  outline: 3px solid rgba(132,204,22,.35); /* lime-500 ring */
  outline-offset: 2px;
  border-radius: 8px;
}

/* If links inside inherit Bootstrap's link color, neutralize it */
.lp-story-card a.text-decoration-none{
  color: inherit;
}

</style>

<script>
  (function(){
    const grid   = document.getElementById('libGrid');
    const wraps  = [...grid.querySelectorAll('.lib-wrap')];
    const search = document.getElementById('libSearch');
    const clear  = document.getElementById('libClear');
    const sort   = document.getElementById('libSort');
    const count  = document.getElementById('matchCount');

    const norm = s => (s||'').toLowerCase();

    function apply(){
      const q = norm(search.value);
      let visible = [];

      // Filter
      wraps.forEach(w => {
        const t = w.dataset.title;
        const a = w.dataset.author;
        const k = w.dataset.keywords;
        const show = !q || t.includes(q) || a.includes(q) || k.includes(q);
        w.style.display = show ? '' : 'none';
        if (show) visible.push(w);
      });

      // Sort (only visible)
      const sv = sort.value;
      visible.sort((A,B) => {
        if (sv === 'newest')  return new Date(B.dataset.created) - new Date(A.dataset.created);
        if (sv === 'oldest')  return new Date(A.dataset.created) - new Date(B.dataset.created);
        if (sv === 'title')   return A.dataset.title.localeCompare(B.dataset.title);
        if (sv === 'author')  return A.dataset.author.localeCompare(B.dataset.author);
        return 0;
      });

      // Re-append in new order
      visible.forEach(el => grid.appendChild(el));

      count.textContent = visible.length;
    }

    apply();
    search.addEventListener('input', apply);
    sort.addEventListener('change', apply);
    clear?.addEventListener('click', () => { search.value=''; search.focus(); apply(); });
  })();
</script>

{% endblock %}
