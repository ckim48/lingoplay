{% extends "base2.html" %}
{% block title %}Library Â· LexiTale{% endblock %}

{% block content %}
<link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&family=Baloo+2:wght@700;800&display=swap" rel="stylesheet">

<div class="container mt-4">

  {# --- Header --- #}
  <div class="d-flex flex-wrap justify-content-between align-items-center mb-4 pb-3 border-bottom border-v6-soft">
    <div class="d-flex align-items-center gap-4">
      <i class="bi bi-book-half display-4 library-header-icon"></i>
      <div>
        <h3 class="fw-bolder mb-1 v6-section-title">The Magic Bookshelf</h3>
        <p class="text-muted v6-section-p mb-0 library-text-body">
          Explore stories shared by your teacher. Tap any cover to begin reading!
        </p>
      </div>
    </div>
  </div>

  {# --- NAV TABS: All | By Class | Create Storybook (Everyone) --- #}
  <ul class="nav nav-tabs library-tabs mb-4" role="tablist">
    <li class="nav-item" role="presentation">
      <a
        class="nav-link {% if not selected_class_id %}active{% endif %}"
        href="{{ url_for('library') }}"
        role="tab"
        aria-selected="{% if not selected_class_id %}true{% else %}false{% endif %}"
      >
        <i class="bi bi-collection me-1"></i> All
      </a>
    </li>

    {% if my_classes %}
      {% for c in my_classes %}
      <li class="nav-item" role="presentation">
        <a
          class="nav-link {% if selected_class_id == c.id %}active{% endif %}"
          href="{{ url_for('library', class_id=c.id) }}"
          role="tab"
          aria-selected="{% if selected_class_id == c.id %}true{% else %}false{% endif %}"
        >
          <i class="bi bi-people me-1"></i> {{ c.name }}
        </a>
      </li>
      {% endfor %}
    {% endif %}

    {# Always visible: regular users can create too #}
    <li class="nav-item ms-auto" role="presentation">
      <a class="nav-link library-tabs-create" href="{{ url_for('story_new') }}">
        <i class="bi bi-magic me-1"></i> Create Storybook
      </a>
    </li>
  </ul>
  {# --- END NAV TABS --- #}

  {# --- Search Bar & Controls --- #}
  <div class="row mb-4 g-3 align-items-center">
    <div class="col-lg-8">
      <div class="input-group input-group-lg library-search-input">
        <span class="input-group-text"><i class="bi bi-search"></i></span>
        <input type="text" class="form-control" placeholder="Search by title, author, or vocabulary..." id="storySearch">
      </div>
    </div>
    <div class="col-lg-4 d-flex justify-content-end">
      <div class="input-group input-group-lg" style="max-width: 250px;">
        <label class="input-group-text library-sort-label" for="storySort">Sort By:</label>
        <select class="form-select form-select-lg" id="storySort">
          <option value="newest" selected>Newest</option>
          <option value="title_asc">Title (A-Z)</option>
          <option value="level_asc">Level (Easiest)</option>
        </select>
      </div>
    </div>
  </div>
  {# --- END Search Bar & Controls --- #}

  <div class="row g-4 g-lg-5">

    {# --- COLUMN 1: FILTER SIDEBAR --- #}
    <div class="col-lg-3">
      <h5 class="fw-bold mb-3 v6-section-title-small">
        <i class="bi bi-funnel me-2"></i>Filter Stories
      </h5>

      <div class="card library-filter-card mb-4">
        <div class="card-body">
          <h6 class="fw-bold v6-filter-heading">Reading Level</h6>
          <div class="form-check">
            <input class="form-check-input filter-checkbox" type="checkbox" value="beginner" id="filterBeginner" data-filter-group="level">
            <label class="form-check-label library-text-body" for="filterBeginner">Beginner</label>
          </div>
          <div class="form-check">
            <input class="form-check-input filter-checkbox" type="checkbox" value="intermediate" id="filterIntermediate" data-filter-group="level">
            <label class="form-check-label library-text-body" for="filterIntermediate">Intermediate</label>
          </div>
          <div class="form-check">
            <input class="form-check-input filter-checkbox" type="checkbox" value="advanced" id="filterAdvanced" data-filter-group="level">
            <label class="form-check-label library-text-body" for="filterAdvanced">Advanced</label>
          </div>
        </div>
      </div>

      {# optional language filters later #}
      {#
      <div class="card library-filter-card mb-4">
        <div class="card-body">
          <h6 class="fw-bold v6-filter-heading">Language</h6>
          <div class="form-check">
            <input class="form-check-input filter-checkbox" type="checkbox" value="en" id="filterEnglish" data-filter-group="language">
            <label class="form-check-label library-text-body" for="filterEnglish">English</label>
          </div>
          <div class="form-check">
            <input class="form-check-input filter-checkbox" type="checkbox" value="ko" id="filterKorean" data-filter-group="language">
            <label class="form-check-label library-text-body" for="filterKorean">Korean</label>
          </div>
        </div>
      </div>
      #}

    </div>
    {# --- END FILTER SIDEBAR --- #}

    {# --- COLUMN 2: STORY LIST --- #}
    <div class="col-lg-9">
      {% if stories %}

      <div class="row g-4 g-lg-5" id="storyListContainer">
        {% for s in stories %}
        <div class="col-sm-6 col-md-4 story-item"
             data-title="{{ s.title | lower | e }}"
             data-author="{{ s.author_name | lower | e }}"
             data-level-rank="{{ s.level | lower | e }}"
             data-language="{{ s.language | lower | e }}"
             data-date="{{ s.story_created_at | dt('%s') }}">
          <div class="book-wrap-v6">
            <div class="card border-0 library-card-v6 h-100 p-0 position-relative">

              {% if is_admin %}
              <form method="post" action="{{ url_for('admin_unshare_story', slug=s.slug) }}"
                    onsubmit="return confirm('Are you sure you want to remove \'{{ s.title }}\' from the Library?');"
                    class="admin-remove-form">
                <button type="submit" class="btn btn-sm library-remove-btn-v6">
                  <i class="bi bi-x-lg"></i>
                </button>
              </form>
              {% endif %}

              <a href="{{ url_for('book_view', draft_id=s.draft_id) }}"
                 class="text-decoration-none text-reset d-flex flex-column h-100">

                <div class="library-card-img-wrap-v6"
                     style="background-image: url('{{ s.visuals or url_for('static', filename='img/fallback_cover.png') }}');">
                </div>

                <div class="card-body p-4 d-flex flex-column flex-grow-1 card-details-area">

                  <div class="d-flex align-items-center mb-3 gap-2">
                    <span class="v6-tag-level v6-tag-level-accent">{{ s.level|title }}</span>
                  </div>

                  <h4 class="fw-bold mb-3 text-v6-title truncate-2-lines">
                    {{ s.title or "Box" }}
                  </h4>

                  <p class="small text-v6-muted mb-3 flex-grow-1 library-text-body">
                    By <span class="fw-semibold">{{ s.author_name or "EduWeaver AI" }}</span>
                  </p>

                  <div class="mt-auto pt-3 d-flex justify-content-between align-items-center border-top border-v6-soft">
                    <span class="badge tag-shared-v6">Shared</span>
                    <span class="small text-v6-link fw-bold library-cta-text">
                      Read Now <i class="bi bi-arrow-right-circle-fill ms-1"></i>
                    </span>
                  </div>
                </div>

              </a>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>

      <div class="py-5 text-center text-v6-muted" id="noResultsMessage" style="display: none;">
        <p class="mb-1 fw-semibold library-text-body">No stories match your current filters and search query.</p>
        <i class="bi bi-box-seam display-4 mt-4 d-block" style="color: var(--color-play-soft-border);"></i>
      </div>

      <div class="d-flex justify-content-center mt-5" id="paginationWrapper">
        <nav aria-label="Library Pagination">
          <ul class="pagination pagination-lg library-pagination-v6" id="paginationControls"></ul>
        </nav>
      </div>

      {% else %}
      <div class="py-5 text-center text-v6-muted">
        <p class="mb-1 fw-semibold library-text-body">No stories in the Library yet.</p>
        <p class="small mb-0 library-text-body">
          Your teacher can share stories from the <span class="fw-bold">Story Review</span> page.
        </p>
        <i class="bi bi-box-seam display-4 mt-4 d-block" style="color: var(--color-play-soft-border);"></i>
      </div>
      {% endif %}
    </div>
    {# --- END STORY LIST COLUMN --- #}

  </div>
</div>

<style>
body{
  font-family:'Fredoka','Nunito',sans-serif;
  background-color:#FCFCF5 !important;
}
:root{
  --color-play-coral:#f59e0b;
  --color-play-coral-light:#ffd7cc;
  --color-play-sun:#ffd569;
  --color-play-heading:#111827;
  --color-play-muted:#6b7280;
  --color-play-paper:#FFFFFF;
  --color-play-soft-border:#f8e8d5;

  --color-tag-lang-bg:#E0EFFF;
  --color-tag-lang-text:#1E40AF;
  --color-tag-level-bg:#FFFFAA;
  --color-tag-level-text:#535300;

  --color-play-shadow-light:rgba(255,107,107,0.2);
  --color-play-shadow-deep:rgba(17,24,39,0.1);
}
.text-v6-muted{ color: var(--color-play-muted) !important; }
.border-v6-soft{ border-color: var(--color-play-soft-border) !important; }
.text-v6-link{ color: var(--color-play-coral) !important; }
.library-text-body{ font-family:'Fredoka','Nunito',sans-serif; }

.truncate-2-lines{
  display:-webkit-box;
  -webkit-line-clamp:2;
  -webkit-box-orient:vertical;
  overflow:hidden;
  text-overflow:ellipsis;
}

/* Header */
.library-header-icon{ color:var(--color-play-coral) !important; font-size:3rem; }
.v6-section-title{
  font-family:'Baloo 2',cursive;
  font-size:2.2rem;
  color:#f59e0b;
  line-height:1.1;
  font-weight:800;
}
.v6-section-title-small{
  font-family:'Baloo 2',cursive;
  font-size:1.4rem;
  color:var(--color-play-heading);
  font-weight:700;
}
.v6-section-p{
  font-size:1rem;
  color:var(--color-play-muted) !important;
}

/* Tabs */
.library-tabs.nav-tabs{
  border-bottom:2px solid var(--color-play-soft-border);
  gap:.35rem;
}
.library-tabs .nav-link{
  border:2px solid transparent;
  border-top-left-radius:1.1rem;
  border-top-right-radius:1.1rem;
  font-family:'Fredoka',sans-serif;
  font-weight:700;
  color:var(--color-play-muted);
  background:#fffdfc;
}
.library-tabs .nav-link:hover{ color: var(--color-play-heading); }
.library-tabs .nav-link.active{
  color:var(--color-play-heading);
  border-color:var(--color-play-soft-border);
  border-bottom-color:#fffdfc;
  box-shadow:0 -6px 16px rgba(17,24,39,0.06);
}
.library-tabs-create{
  color:var(--color-play-heading) !important;
  background:var(--color-play-sun) !important;
  border-color:rgba(0,0,0,.06) !important;
}
.library-tabs-create:hover{ filter:brightness(0.98); }

/* Filter card */
.library-filter-card{
  border-radius:1rem !important;
  border:2px solid var(--color-play-soft-border) !important;
  background-color:#fffdfc;
}
.v6-filter-heading{
  font-family:'Baloo 2',cursive;
  color:var(--color-play-coral);
  font-size:1.1rem;
}
.form-check-input:checked{
  background-color:var(--color-play-coral);
  border-color:var(--color-play-coral);
}
.form-check-input{ border-radius:0.25rem; }

/* Search & sort */
.library-search-input .input-group-text,
.library-search-input .form-control{
  border-radius:1.25rem;
  font-family:'Fredoka',sans-serif;
  padding:0.6rem 1rem;
  font-size:1.1rem;
  transition:all 0.2s;
}
.library-search-input .input-group-text{
  border-radius:1.25rem 0 0 1.25rem;
  background:#f1f5f9;
  color:var(--color-play-coral);
  border-right:none;
}
.library-search-input .form-control{
  border-radius:0 1.25rem 1.25rem 0;
  border-left:none;
}
.library-search-input .form-control:focus{
  border-color:var(--color-play-coral);
  box-shadow:0 0 0 0.1rem var(--color-play-coral-light);
}
.library-sort-label{
  background:#f1f5f9;
  color:var(--color-play-muted);
  font-family:'Fredoka',sans-serif;
  border-radius:1.25rem 0 0 1.25rem;
  font-size:1.1rem;
}
.form-select-lg{ border-radius:0 1.25rem 1.25rem 0; }
.form-select-lg:focus{
  border-color:var(--color-play-coral);
  box-shadow:0 0 0 0.1rem var(--color-play-coral-light);
}

/* Cards */
.book-wrap-v6{
  perspective:1200px;
  transform-style:preserve-3d;
  transition:transform 0.3s cubic-bezier(0.4,0,0.2,1), box-shadow 0.3s ease;
}
.book-wrap-v6:hover{
  transform:translateY(-10px) rotateZ(-0.5deg);
  box-shadow:0 18px 40px -10px rgba(255,107,107,0.35);
}
.library-card-v6{
  background:var(--color-play-paper);
  border-radius:25px !important;
  border:3px solid var(--color-play-soft-border) !important;
  box-shadow:0 6px 15px var(--color-play-shadow-light);
  transition:all 0.3s ease;
  transform:translateZ(10px);
}
.library-card-img-wrap-v6{
  width:100%;
  padding-top:100%;
  background-size:cover;
  background-position:center;
  background-color:var(--color-play-soft-border);
  border-radius:22px 22px 0 0 !important;
  border-bottom:none;
  position:relative;
  box-shadow:0 6px 15px rgba(0,0,0,0.1);
}
.card-details-area{ padding:1.5rem !important; }

.v6-tag-level{
  padding:0.2rem 0.8rem;
  border-radius:8px;
  font-size:0.9rem;
  font-weight:700;
  background-color:var(--color-tag-lang-bg);
  color:var(--color-tag-lang-text);
}
.v6-tag-level-accent{
  background-color:var(--color-tag-level-bg);
  color:var(--color-tag-level-text);
}

.text-v6-title{
  font-family:'Baloo 2',cursive;
  font-size:2rem;
  line-height:1.1;
  color:var(--color-play-heading);
  font-weight:800;
  height:4.4rem;
}
.tag-shared-v6{
  background-color:var(--color-play-coral);
  font-size:0.9rem;
  padding:0.4rem 0.8rem;
  border-radius:12px;
}
.library-cta-text{ font-size:1rem !important; }

/* Admin remove */
.library-remove-btn-v6{
  position:absolute;
  top:15px;
  right:15px;
  z-index:20;
  width:36px;
  height:36px;
  font-size:1rem;
  background-color:#f59e0b !important;
  color:black;
  border:none;
  box-shadow:0 3px 6px rgba(0,0,0,0.25);
  border-radius:50% !important;
  transition:transform 0.2s, background-color 0.2s;
}
.library-remove-btn-v6:hover{
  transform:scale(1.1);
  background-color:#ff6b6b !important;
}

/* Pagination */
.library-pagination-v6 .page-link{
  font-family:'Fredoka',sans-serif;
  font-weight:500;
  border-radius:1.25rem !important;
  margin:0 0.25rem;
  padding:0.6rem 1rem;
  color:var(--color-play-muted);
  border:2px solid var(--color-play-soft-border);
  transition:all 0.2s ease;
}
.library-pagination-v6 .page-item.active .page-link{
  background-color:var(--color-play-coral);
  border-color:var(--color-play-coral);
  color:white;
  box-shadow:0 4px 8px rgba(255,107,107,0.3);
}
.library-pagination-v6 .page-item:not(.active):not(.disabled) .page-link:hover{
  color:var(--color-play-coral);
  border-color:var(--color-play-coral-light);
}
.bi-box-seam{ color: var(--color-play-soft-border) !important; }
</style>

<script>
(function() {
  const searchInput = document.getElementById('storySearch');
  const sortSelect = document.getElementById('storySort');
  const storyListContainer = document.getElementById('storyListContainer');
  const storyItems = Array.from(document.querySelectorAll('.story-item'));
  const filterCheckboxes = document.querySelectorAll('.filter-checkbox');
  const noResultsMessage = document.getElementById('noResultsMessage');
  const paginationControls = document.getElementById('paginationControls');

  const STORIES_PER_PAGE = 3;
  let currentPage = 1;

  const levelRankMap = { beginner: 1, intermediate: 2, advanced: 3 };

  function getSortValue(item, sortKey) {
    switch (sortKey) {
      case 'title_asc': return item.dataset.title;
      case 'level_asc': return levelRankMap[item.dataset.levelRank] || 99;
      case 'newest':
      default: return (parseInt(item.dataset.date || '0', 10) || 0) * -1;
    }
  }

  function isStoryVisible(item, lowerQuery, activeFilters) {
    const title = item.dataset.title || '';
    const author = item.dataset.author || '';
    const level = item.dataset.levelRank || '';
    const language = item.dataset.language || '';

    const passesSearch = lowerQuery === '' || title.includes(lowerQuery) || author.includes(lowerQuery);
    if (!passesSearch) return false;

    const passesLevel = activeFilters.level.length === 0 || activeFilters.level.includes(level);
    const passesLanguage = activeFilters.language.length === 0 || activeFilters.language.includes(language);

    return passesLevel && passesLanguage;
  }

  function setupPagination(visibleItems) {
    const wrapper = document.getElementById('paginationWrapper');
    const totalPages = Math.ceil(visibleItems.length / STORIES_PER_PAGE);
    if (!paginationControls || !wrapper) return;

    paginationControls.innerHTML = '';

    if (totalPages <= 1) {
      wrapper.style.display = 'none';
      return;
    }
    wrapper.style.display = 'flex';

    if (currentPage > totalPages) currentPage = totalPages;
    if (currentPage < 1) currentPage = 1;

    paginationControls.innerHTML += `
      <li class="page-item ${currentPage === 1 ? 'disabled' : ''}" data-page="${currentPage - 1}">
        <a class="page-link" href="#" tabindex="-1">Previous</a>
      </li>
    `;

    for (let i = 1; i <= totalPages; i++) {
      paginationControls.innerHTML += `
        <li class="page-item ${i === currentPage ? 'active' : ''}" data-page="${i}">
          <a class="page-link" href="#">${i}</a>
        </li>
      `;
    }

    paginationControls.innerHTML += `
      <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}" data-page="${currentPage + 1}">
        <a class="page-link" href="#">Next</a>
      </li>
    `;

    paginationControls.querySelectorAll('.page-item').forEach(item => {
      if (!item.classList.contains('disabled')) {
        item.addEventListener('click', (e) => {
          e.preventDefault();
          const newPage = parseInt(item.dataset.page, 10);
          if (newPage) {
            currentPage = newPage;
            updateView(false);
          }
        });
      }
    });
  }

  function displayPage(visibleItems) {
    const start = (currentPage - 1) * STORIES_PER_PAGE;
    const end = start + STORIES_PER_PAGE;

    storyItems.forEach(item => item.style.display = 'none');
    visibleItems.slice(start, end).forEach(item => { item.style.display = 'block'; });
  }

  function updateView(resetPage = true) {
    if (!storyListContainer || storyItems.length === 0) return;
    if (resetPage) currentPage = 1;

    const lowerQuery = (searchInput?.value || '').trim().toLowerCase();
    const sortKey = sortSelect?.value || 'newest';

    const activeFilters = { level: [], language: [] };
    filterCheckboxes.forEach(cb => {
      if (cb.checked) {
        const group = cb.dataset.filterGroup;
        if (activeFilters[group]) activeFilters[group].push(cb.value);
      }
    });

    const filteredItems = storyItems.filter(item => isStoryVisible(item, lowerQuery, activeFilters));

    filteredItems.sort((a, b) => {
      const valA = getSortValue(a, sortKey);
      const valB = getSortValue(b, sortKey);
      if (typeof valA === 'string' && typeof valB === 'string') return valA.localeCompare(valB);
      return valA - valB;
    });

    filteredItems.forEach(item => storyListContainer.appendChild(item));

    setupPagination(filteredItems);
    displayPage(filteredItems);

    if (noResultsMessage) noResultsMessage.style.display = filteredItems.length === 0 ? 'block' : 'none';
  }

  let searchTimeout;
  searchInput?.addEventListener('input', function() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => updateView(true), 300);
  });

  sortSelect?.addEventListener('change', () => updateView(true));
  filterCheckboxes.forEach(cb => cb.addEventListener('change', () => updateView(true)));

  updateView(true);
})();
</script>

{% endblock %}
