{% extends "base2.html" %}
{% block title %}{{ story.title }} Â· Book Reader{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-start flex-wrap gap-3 mt-3">
  <div>
    {# Applied v6 styling to the main title area #}
    <h3 class="fw-bolder mb-1 v6-section-title" style="font-size: 1.75rem;">{{ story.title }}</h3>
    <p class="text-muted v6-section-p mb-0">
      <i class="bi bi-person-fill"></i> {{ story.author_name or "EduWeaver AI" }}
    </p>
  </div>

  <a href="{{ url_for('library') }}" class="btn btn-outline-secondary rounded-pill">
    <i class="bi bi-book me-1"></i> Back to Library
  </a>
</div>

<div class="reader-shell mt-4">
  <div class="reader-container shadow rounded-4" id="reader-container">

    <button class="nav-btn prev-btn" id="prev-page" disabled>
      <i class="bi bi-caret-left-fill display-5"></i>
    </button>
    <button class="nav-btn next-btn" id="next-page">
      <i class="bi bi-caret-right-fill display-5"></i>
    </button>

    <div class="page-count-indicator">
        <span id="page-indicator">Page 1 of {{ pages|length + 1 }}</span>
    </div>

    <div class="reader-page active-page" data-page-index="0">
      <div class="reader-page-inner cover-page-v2"
           style="background-image: url('{{ story.visuals or url_for('static', filename='img/fallback_cover.png') }}');">
        <div class="cover-front-overlay-v2"></div>
        <div class="cover-front-inner-v2">
          <h1 class="book-title">{{ story.title }}</h1>
          <p class="book-author">By {{ story.author_name or "EduWeaver AI" }}</p>
          <div class="mt-3 d-flex justify-content-center gap-2">
            <span class="v6-tag-level">{{ story.language|upper }}</span>
            <span class="v6-tag-level v6-tag-level-accent">{{ story.level|title }}</span>
          </div>
        </div>
      </div>
    </div>

    {# CONTENT PAGES (1 to N) #}
    {% for page_content in pages %}
      <div class="reader-page" data-page-index="{{ loop.index }}">
        <div class="reader-page-inner content-page-v2 d-flex flex-column justify-content-center align-items-center">

          <p class="page-content text-center flex-grow-0">{{ page_content }}</p>
        </div>
      </div>
    {% endfor %}

    {# LAST PAGE: The End Page #}
    <div class="reader-page" data-page-index="{{ pages|length + 1 }}">
      <div class="reader-page-inner content-page-v2 text-center d-flex flex-column justify-content-center align-items-center">
        <h2 class="mb-3">The End</h2>
        <p class="mb-4">Thank you for reading!</p>
        <a href="{{ url_for('library') }}" class="btn btn-v6-primary-soft">
          <i class="bi bi-book me-2"></i> Back to Library
        </a>
      </div>
    </div>

  </div>
</div>


<style>
/* --- CORE SIZE FIXES AND BUTTON INTEGRATION --- */
:root{
  --reader-width: min(720px, 95vw);
  --reader-height: 480px;
  --nav-btn-size: 50px;
}

/* Re-defining V6-style classes here for consistency, though they should be in base2's style block */
.v6-section-title {
    font-size: 2rem;
    color: var(--color-v6-heading, #1A1D2B);
    line-height: 1.1;
    font-weight: 800;
}
.v6-section-p {
    font-size: 1rem;
    color: var(--color-v6-muted, #6C7383) !important;
}


.reader-shell{
  display:flex;
  justify-content:center;
  margin-top:1.5rem;
}

.reader-container{
  width:var(--reader-width);
  height:var(--reader-height);
  position:relative;
  background:#fff;
  overflow:hidden;
}

/* Navigation Buttons Integrated into Card */
.nav-btn {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    z-index: 10;
    width: var(--nav-btn-size);
    height: var(--nav-btn-size);
    border: none;
    background: none;
    color: rgba(0, 0, 0, 0.4);
    transition: color 0.2s;
    cursor: pointer;
    padding: 0;
}
.nav-btn:hover:not(:disabled) {
    color: var(--color-v4-primary, #3B82F6);
}
.nav-btn:disabled {
    cursor: default;
    color: rgba(0, 0, 0, 0.1);
}
.prev-btn { left: 10px; }
.next-btn { right: 10px; }

/* Page Indicator Positioned Inside */
.page-count-indicator {
    position: absolute;
    bottom: 15px; /* Moved to bottom right corner */
    right: 30px;
    z-index: 5;
    font-size: 0.9rem;
    color: #6b7280;
}

/* Base Page Styles (No change) */
.reader-page{
  position:absolute;
  inset:0;
  opacity:0;
  transition:opacity 0.5s ease-in-out;
  background:white;
  z-index:1;
}

.reader-page.active-page{
  opacity:1;
  z-index:2;
}

.reader-page-inner{
  width:100%;
  height:100%;
  overflow-y:auto;
  box-sizing:border-box;
}

/* Cover Styling (No change) */
.cover-page-v2{
  background-color:#111;
  background-size:cover;
  background-repeat:no-repeat;
  background-position:center;
  color:#fff;
  padding:0;
}
.cover-front-overlay-v2{
  position:absolute;
  inset:0;
  background:linear-gradient(to top, rgba(0,0,0,.7), rgba(0,0,0,.1));
}
.cover-front-inner-v2{
  position:relative;
  z-index:2;
  height:100%;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:flex-end;
  text-align:center;
  padding:2.5rem;
}

/* Content Pages (Vertical Centering Fix) */
.content-page-v2{
  padding:2rem 3rem;
  background:#fffaf1;
  height: 100%;

  /* FIX 1: Enforce Flexbox for vertical centering */
  display: flex;
  flex-direction: column;
  justify-content: center;
}
/* Centering and flow fix */
.content-page-v2 .page-content {
    /* flex-grow-0 ensures it doesn't take up excessive vertical space */
    font-size:1.25rem;
    line-height:1.7;
    white-space:pre-wrap;
    /* Center text horizontally within the allowed space */
    text-align: center;
    margin: 0 auto;
    max-width: 90%;
}

/* Tag styles reused from original request (No change) */
.v6-tag-level{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  padding:.2rem .7rem;
  border-radius:999px;
  font-size:.7rem;
  font-weight:600;
  background:#e5edff;
  color:#1d4ed8;
}
.v6-tag-level-accent{
  background:#ffe8cc;
  color:#c05621;
}

/* Responsive adjustments */
@media (max-width: 600px) {
  .content-page-v2 {
    padding: 1.5rem;
  }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const pages = Array.from(document.querySelectorAll('.reader-page'));
  const prevBtn = document.getElementById('prev-page');
  const nextBtn = document.getElementById('next-page');
  const pageIndicator = document.getElementById('page-indicator');

  const totalPages = pages.length;
  let currentPageIndex = 0; // 0 = Cover

  // Total content pages is the number of paragraphs in 'pages'.
  const totalContentPages = pages.length - 1;

  function updateDisplay(index) {
    pages.forEach(p => p.classList.remove('active-page'));

    if (pages[index]) {
      pages[index].classList.add('active-page');
    }

    // Update controls
    currentPageIndex = index;
    prevBtn.disabled = (currentPageIndex === 0);
    nextBtn.disabled = (currentPageIndex === totalPages - 1);

    // Update indicator (1-based for display)
    let displayPage = currentPageIndex; // Content pages start at index 1

    // If the index is the cover (0), display Page 1.
    if (currentPageIndex === 0) {
        displayPage = 1;
    }

    // Safety check for The End page
    if (currentPageIndex === totalPages - 1) {
        displayPage = totalContentPages; // Show the last page number
    } else if (currentPageIndex > 0) {
        displayPage = currentPageIndex; // Content pages are 1-based index
    }

    pageIndicator.textContent = `Page ${displayPage} of ${totalContentPages}`;

    // Manually trigger global bookmark render if available
    if (typeof window.renderBookmarks === 'function') {
        window.renderBookmarks();
    }
  }

  // Global hook for the sidebar jump functionality (defined in base2.html)
  window.turnPageByIndex = function(contentPageNum) {
      if (contentPageNum >= 0 && contentPageNum < totalPages) {
          updateDisplay(contentPageNum);
      }
  };

  function turn(direction) {
    const newIndex = currentPageIndex + direction;
    if (newIndex >= 0 && newIndex < totalPages) {
      updateDisplay(newIndex);
    }
  }

  nextBtn.addEventListener('click', () => turn(1));
  prevBtn.addEventListener('click', () => turn(-1));

  // Initialize display on the cover page (Index 0)
  updateDisplay(0);
});
</script>
{% endblock %}