{% extends "base2.html" %}
{% block title %}{{ story.title }} Â· Book Reader{% endblock %}

{% block content %}
<link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&family=Baloo+2:wght@700;800&display=swap" rel="stylesheet">

<!--<div class="d-flex justify-content-between align-items-start flex-wrap gap-3 mt-4">-->
<!--  <div>-->
<!--    <h3 class="fw-bolder mb-1 game-title-v7" style="font-size: 2rem;">{{ story.title }}</h3>-->
<!--    <p class="text-muted game-text-body mb-0">-->
<!--      <i class="bi bi-person-fill"></i> {{ story.author_name or "EduWeaver AI" }}-->
<!--    </p>-->
<!--  </div>-->

<!--  <a href="{{ url_for('library') }}" class="btn btn-outline-secondary rounded-pill game-text-body">-->
<!--    <i class="bi bi-book me-1"></i> Back to Library-->
<!--  </a>-->
<!--</div>-->

<!--<div class="mt-2 text-muted small">-->
<!--  <span class="v6-tag-level game-text-body me-1">{{ story.language|upper }}</span>-->
<!--  <span class="v6-tag-level v6-tag-level-accent game-text-body">{{ story.level|title }}</span>-->
<!--</div>-->

<div class="container px-0 px-md-2 px-lg-3 mt-4">
  <div class="book-wrap-v7" id="book">
    <div class="book-stage">
      <div class="spread" id="spread">
        <!-- LEFT PAGE -->
        <div class="sheet left" id="page-left" aria-live="polite">
          <div class="page-content" id="content-left"></div>
          <div class="page-number" id="pnum-left"></div>
          <button class="page-arrow page-arrow-v7 left" id="prev-btn" aria-label="Previous">
            <i class="bi bi-chevron-left"></i>
          </button>
        </div>

        <!-- SPINE -->
        <div class="spine" aria-hidden="true"></div>

        <!-- RIGHT PAGE -->
        <div class="sheet right" id="page-right" aria-live="polite">
          <div class="page-content" id="content-right"></div>
          <div class="page-number" id="pnum-right"></div>
          <button class="page-arrow page-arrow-v7 right" id="next-btn" aria-label="Next">
            <i class="bi bi-chevron-right"></i>
          </button>
        </div>

        <!-- FLIP OVERLAY -->
        <div class="flip-layer" id="flip-layer" aria-hidden="true"></div>
      </div>
    </div>
  </div>

  <div class="small text-muted mt-3 game-text-body">
    <i class="bi bi-info-circle"></i> Use left/right arrows or keyboard to flip pages.
  </div>
</div>

<style>
:root{
  /* V7 THEME COLORS */
  --coral-main: #ff6b6b;
  --coral-light: #ffd7cc;
  --ink: #111827;
  --muted: #6b7280;
  --paper: #fffcf8;
  --paper-edge: #fcece4;
  --paper-shadow: 0 10px 30px rgba(255, 107, 107, 0.15);
  --bg-game: linear-gradient(145deg, #fff7e5 0%, #fff2f2 50%, #fefcfb 100%);
  --gutter:20px; --flip-ms:460ms; --arrow-pad:56px;
}

/* V7 Typography */
.game-title-v7, .book-title, .book-author {
  font-family: 'Baloo 2', cursive;
  font-weight: 800;
  color: var(--coral-main);
}
.game-text-body, .page-content {
  font-family: 'Fredoka', 'Nunito', sans-serif;
  color: var(--ink);
}
.game-title-v7 {
  color: var(--coral-main);
}
.game-text-body {
  color: var(--muted) !important;
}

/* Book base */
.book-wrap-v7{
  position: relative;
  background: var(--bg-game) !important;
  border-radius: 30px;
  border: 3px solid var(--coral-light);
  box-shadow: 0 12px 40px rgba(255,107,107,.25);
  overflow: hidden;
  max-width: 1200px;
  margin-inline: auto;
}
.book-stage{
  position: relative;
  padding: 24px 18px 24px;
  perspective: 1600px;
  perspective-origin: 50% 40%;
  min-height: 64vh;
}
.spread{
  position: relative;
  display: grid;
  grid-template-columns: minmax(280px, 1fr) var(--gutter) minmax(280px, 1fr);
  align-items: center;
  justify-items: center;
  min-height: 56vh;
}
.spine{
  width: var(--gutter);
  border-radius: 12px;
  background: repeating-linear-gradient(180deg, #ffe7bb 0 6px, #ffdca8 6px 12px);
  border-left: 1px solid #ffd79b;
  border-right: 1px solid #ffe8c4;
  box-shadow: inset 0 0 18px rgba(255,174,53,.25);
  height: 100%;
}

/* Page sheet */
.sheet{
  position: relative;
  background: var(--paper);
  color: var(--ink);
  border-radius: 20px;
  border:2px solid var(--paper-edge);
  box-shadow: var(--paper-shadow);
  padding: 28px var(--arrow-pad) 44px var(--arrow-pad);
  line-height: 1.9;
  font-size: 1.06rem;
  overflow: hidden;
  height: clamp(520px, 70vh, 82vh);
  aspect-ratio: 3 / 4;
  display:flex;
  flex-direction:column;
}
.sheet.left{ transform: rotate(-.15deg); }
.sheet.right{ transform: rotate(.15deg); }

/* Content pages: big, vertically centered */
.page-content{
  position: relative;
  z-index: 1;
  margin: auto 0;
  font-size: 1.35rem;
  line-height: 1.8;
  text-align: center;
  max-width: 90%;
  align-self: center;
}
.page-content p{ margin-bottom: 1rem; }

.page-number{
  position:absolute;
  right:16px;
  bottom:14px;
  font-weight:700;
  font-size:.9rem;
  color:var(--muted);
  user-select:none;
}

/* ===== COVER: same size as pages, full-bleed image ===== */
.sheet.is-cover{
  background: transparent;
  padding: 0;
}

/* KEY FIX: let page-content fill the entire sheet when it's the cover */
.sheet.is-cover .page-content{
  margin: 0;
  padding: 0;
  max-width: 100%;
  align-self: stretch;
  height: 100%;
}

/* Hide page number on cover */
.sheet.is-cover .page-number{
  display:none;
}

/* Cover image fills page */
.cover-page-v2{
  position:relative;
  width:100%;
  height:100%;
  background-color:#111;
  background-size:cover;
  background-repeat:no-repeat;
  background-position:center;
  color:#fff;
  padding:0;
}
.cover-front-overlay-v2{
  position:absolute;
  inset:0;
  background:linear-gradient(to top, rgba(0,0,0,.7), rgba(0,0,0,.15));
}
.cover-front-inner-v2{
  position:relative;
  z-index:2;
  height:100%;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:flex-end;
  text-align:center;
  padding:2.5rem;
}
.book-title{
  font-family: 'Baloo 2', cursive;
  font-size: clamp(2.6rem, 4vw, 3.4rem);
  font-weight:900;
  line-height:1.1;
  margin-bottom:.5rem;
}
.book-author{
  font-size:1.1rem;
  opacity:.9;
  font-family: 'Fredoka', 'Nunito', sans-serif;
}

/* Language / level tags */
.v6-tag-level{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  padding:.3rem .8rem;
  border-radius:999px;
  font-size:.75rem;
  font-weight:700;
  background:var(--coral-light);
  color:var(--coral-main);
  font-family: 'Fredoka', 'Nunito', sans-serif;
}
.v6-tag-level-accent{
  background:#d1fae5;
  color:#065f46;
}

/* Arrows (V7 style) */
.page-arrow{
  position:absolute;
  top:50%;
  transform: translateY(-50%);
}
.page-arrow-v7{
  width: 50px;
  height: 50px;
  border-radius: 50%;
  background: var(--coral-main);
  color: white;
  border: none;
  z-index: 3;
  font-size: 1.25rem;
  box-shadow: 0 5px 12px rgba(255,107,107,.4);
  transition: all 0.2s;
}
.page-arrow-v7:hover{
  background: #e86060;
  box-shadow: 0 7px 14px rgba(255,107,107,.5);
  transform: translateY(-50%) scale(1.05);
}
.page-arrow-v7:disabled{
  opacity:.6;
  cursor:not-allowed;
  box-shadow: none;
  background: #ccc;
  color: #666;
  transform: translateY(-50%) scale(1);
}
.page-arrow.left{ left: 16px; }
.page-arrow.right{ right: 16px; }

/* Flip overlay */
.flip-layer{
  position:absolute;
  inset:24px 18px 24px 18px;
  pointer-events:none;
}
.flip-sheet{
  position:absolute;
  top:0;
  left:0;
  transform-style: preserve-3d;
  backface-visibility: hidden;
  will-change: transform;
  border-radius:20px;
  overflow:hidden;
  box-shadow: var(--paper-shadow);
}
.flip-face{
  position:absolute;
  inset:0;
  background: var(--paper);
  color: var(--ink);
  border:2px solid var(--paper-edge);
  padding:28px var(--arrow-pad) 44px var(--arrow-pad);
  backface-visibility: hidden;
  font-family: 'Fredoka', 'Nunito', sans-serif;
  font-size: 1.35rem;
}
.flip-face.back{ transform: rotateY(180deg); }
.shade{
  position:absolute;
  inset:0;
  border-radius:20px;
  pointer-events:none;
  opacity:.0;
  background: linear-gradient(90deg, rgba(255,107,107,.35), rgba(0,0,0,0));
}
.flip-sheet.turning .shade{
  opacity:.4;
  transition: opacity var(--flip-ms) ease;
}
@keyframes flip-forward {
  from { transform: rotateY(0deg); }
  to   { transform: rotateY(-180deg); }
}
@keyframes flip-back {
  from { transform: rotateY(0deg); }
  to   { transform: rotateY(180deg); }
}
.animate-forward{ animation: flip-forward var(--flip-ms) ease both; }
.animate-back{    animation: flip-back    var(--flip-ms) ease both; }

/* Responsive */
@media (max-width: 900px){
  .spread{ grid-template-columns: 1fr; }
  .spine{ display:none; }
  .sheet{
    height: clamp(520px, 72vh, 84vh);
    aspect-ratio: 3 / 4;
    transform: none;
  }
  .flip-layer{ display:none; }
  .page-arrow{
    top:auto;
    bottom:16px;
    transform:none;
  }
  .page-arrow.left{ left:16px; }
  .page-arrow.right{ right:16px; }
  .page-arrow-v7:hover {
    transform: scale(1.05);
  }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const storyTitle   = {{ (story.title or '')|tojson }};
  const storyLang    = {{ (story.language or 'EN')|tojson }};
  const storyLevel   = {{ (story.level or 'A1')|tojson }};
  const pageTexts    = {{ (pages or [])|tojson }};

  function escapeHTML(s){
    return (s||'').replace(/[&<>"'`=\/]/g, c => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',
      "'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'
    }[c]));
  }

  function buildPagesFromServerList() {
    const list = [];

    // COVER PAGE
    const coverHTML = `
      <div class="cover-page-v2"
           style="background-image: url('{{ story.visuals or url_for('static', filename='img/fallback_cover.png') }}');">
        <div class="cover-front-overlay-v2"></div>
        <div class="cover-front-inner-v2">
          <h1 class="book-title">${escapeHTML(storyTitle || 'Untitled Story')}</h1>
          <p class="book-author">By {{ story.author_name or "EduWeaver AI" }}</p>
          <div class="mt-3 d-flex justify-content-center gap-2">
            <span class="v6-tag-level">${escapeHTML((storyLang || '').toUpperCase())}</span>
            <span class="v6-tag-level v6-tag-level-accent">${escapeHTML(storyLevel || '')}</span>
          </div>
        </div>
      </div>
    `;
    list.push({ html: coverHTML, noFolio: true });

    // CONTENT PAGES
    pageTexts.forEach(function(text){
      const html = `<div>${escapeHTML(text).replace(/\n/g, '<br>')}</div>`;
      list.push({ html: html, noFolio: false });
    });

    // END PAGE
    list.push({
      html: `
        <div class="h-100 d-flex flex-column justify-content-center align-items-center text-center">
          <h2 class="mb-3 game-title-v7" style="font-family:'Baloo 2', cursive; font-size:2.5rem;">The End</h2>
          <p class="mb-3 game-text-body">Thank you for reading!</p>
          <a href="{{ url_for('library') }}" class="btn btn-outline-secondary rounded-pill game-text-body">
            <i class="bi bi-book me-1"></i> Back to Library
          </a>
        </div>
      `,
      noFolio: true
    });

    return list;
  }

  const pages = buildPagesFromServerList();
  const totalPages = pages.length;

  const spreadLeft   = document.getElementById('page-left');
  const spreadRight  = document.getElementById('page-right');
  const contentLeft  = document.getElementById('content-left');
  const contentRight = document.getElementById('content-right');
  const pnumLeft     = document.getElementById('pnum-left');
  const pnumRight    = document.getElementById('pnum-right');
  const flipLayer    = document.getElementById('flip-layer');
  const prevBtn      = document.getElementById('prev-btn');
  const nextBtn      = document.getElementById('next-btn');

  function storageKey(){ return `story:${storyTitle||''}:spread`; }
  function getSavedSpread(){
    try{
      const v = parseInt(sessionStorage.getItem(storageKey()));
      return isNaN(v) ? 1 : v;
    }catch(_){ return 1; }
  }
  function saveSpread(s){
    try{ sessionStorage.setItem(storageKey(), String(s)); }catch(_){}
  }

  function setPageNumber(el, pageIndex) {
    if (!el) return;
    const isEdge = (pageIndex === 1 || pageIndex === totalPages);
    el.textContent = isEdge ? '' : pageIndex;
  }

  function renderInto(side, pageIndex) {
    const isLeft   = (side === 'left');
    const pageObj  = pages[pageIndex - 1] || { html:'', noFolio:false };
    const contentEl= isLeft ? contentLeft : contentRight;
    const sheetEl  = isLeft ? spreadLeft  : spreadRight;
    const numEl    = isLeft ? pnumLeft    : pnumRight;

    const isCover  = (pageIndex === 1);

    sheetEl.classList.toggle('is-cover', isCover);
    contentEl.innerHTML = pageObj.html || '';
    setPageNumber(numEl, pageIndex);

    if (isCover) {
      prevBtn.setAttribute('disabled','disabled');
    } else {
      prevBtn.removeAttribute('disabled');
    }
  }

  let spread = Math.max(1, Math.min(Math.ceil(totalPages/2), getSavedSpread()));

  function showSpread(s) {
    const maxSpread = Math.ceil(totalPages/2);
    spread = Math.max(1, Math.min(maxSpread, s));

    const leftIndex  = (spread - 1) * 2 + 1;
    const rightIndex = leftIndex + 1;

    spreadLeft.style.visibility  = (leftIndex  <= totalPages) ? 'visible' : 'hidden';
    spreadRight.style.visibility = (rightIndex <= totalPages) ? 'visible' : 'hidden';

    if (leftIndex  <= totalPages) renderInto('left',  leftIndex);
    if (rightIndex <= totalPages) renderInto('right', rightIndex);

    nextBtn.disabled = (spread >= maxSpread);
    saveSpread(spread);
  }

  function rectWithin(el, ancestor){
    const r = el.getBoundingClientRect();
    const a = ancestor.getBoundingClientRect();
    return {
      left: r.left - a.left,
      top:  r.top  - a.top,
      width:  r.width,
      height: r.height
    };
  }

  function mkFlipOverlay(side, frontHTML, backHTML){
    const host = (side === 'right') ? spreadRight : spreadLeft;
    const box  = rectWithin(host, flipLayer);
    const wrap = document.createElement('div');
    wrap.className = 'flip-sheet turning';
    wrap.style.left = box.left + 'px';
    wrap.style.top  = box.top  + 'px';
    wrap.style.width  = box.width  + 'px';
    wrap.style.height = box.height + 'px';
    wrap.style.transformOrigin = (side === 'right') ? 'left center' : 'right center';

    const faceA = document.createElement('div');
    faceA.className = 'flip-face front';
    faceA.innerHTML = frontHTML;

    const faceB = document.createElement('div');
    faceB.className = 'flip-face back';
    faceB.innerHTML = backHTML;

    const shade = document.createElement('div');
    shade.className = 'shade';

    wrap.appendChild(faceA);
    wrap.appendChild(faceB);
    wrap.appendChild(shade);
    flipLayer.appendChild(wrap);
    return wrap;
  }

  function nextSpread() {
    const maxSpread = Math.ceil(totalPages/2);
    if (spread >= maxSpread) return;

    const leftIndexNow  = (spread - 1) * 2 + 1;
    const rightIndexNow = leftIndexNow + 1;
    const leftIndexNext = leftIndexNow + 2;

    const currentRightHTML = contentRight.innerHTML;
    const nextLeftHTML     = (pages[leftIndexNext - 1]?.html || '');

    const flip = mkFlipOverlay('right', currentRightHTML, nextLeftHTML);

    spread++;
    showSpread(spread);

    flip.classList.add('animate-forward');
    flip.addEventListener('animationend', function () {
      flipLayer.innerHTML = '';
    }, { once:true });
  }

  function prevSpread() {
    if (spread <= 1) return;

    const leftIndexNow   = (spread - 1) * 2 + 1;
    const rightIndexPrev = leftIndexNow - 1;

    const currentLeftHTML = contentLeft.innerHTML;
    const prevRightHTML   = (pages[rightIndexPrev - 1]?.html || '');

    const flip = mkFlipOverlay('left', currentLeftHTML, prevRightHTML);

    spread--;
    showSpread(spread);

    flip.classList.add('animate-back');
    flip.addEventListener('animationend', function () {
      flipLayer.innerHTML = '';
    }, { once:true });
  }

  // init
  showSpread(getSavedSpread());

  nextBtn.addEventListener('click', nextSpread);
  prevBtn.addEventListener('click', prevSpread);

  document.addEventListener('keydown', function (e) {
    if (e.key === 'ArrowRight') {
      e.preventDefault();
      nextSpread();
    }
    if (e.key === 'ArrowLeft') {
      e.preventDefault();
      prevSpread();
    }
  });
});
</script>
{% endblock %}
