{% extends "base2.html" %}
{% block title %}{{ story.title }} Â· Book Reader{% endblock %}

{% block content %}
<link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&family=Baloo+2:wght@700;800&display=swap" rel="stylesheet">

<div class="container px-0 px-md-2 px-lg-3 mt-4">

  <div class="d-flex justify-content-between align-items-center flex-wrap gap-3 p-3 mb-4 bg-white rounded-4 shadow-sm border border-light">
    <div>
      <h3 class="game-title-v7 mb-0" style="font-size: 1.6rem; color: var(--coral-main);">{{ story.title }}</h3>
      <p class="text-muted small mb-0"><i class="bi bi-person-circle"></i> {{ story.author_name or "EduWeaver AI" }}</p>
    </div>

    <div class="d-flex align-items-center gap-3">
      <div class="btn-group rounded-pill overflow-hidden shadow-sm border border-coral-light">
        <button id="tts-play" class="btn btn-coral-v7 tts-ctrl" title="Play/Resume">
          <i class="bi bi-play-fill"></i>
        </button>
        <button id="tts-pause" class="btn btn-coral-v7 tts-ctrl" title="Pause">
          <i class="bi bi-pause-fill"></i>
        </button>
        <button id="tts-stop" class="btn btn-coral-v7 tts-ctrl" title="Stop">
          <i class="bi bi-stop-fill"></i>
        </button>
      </div>

      <a href="{{ url_for('library') }}" class="btn btn-outline-secondary rounded-pill btn-sm game-text-body">
        <i class="bi bi-book"></i> Library
      </a>
    </div>
  </div>

  <div class="book-wrap-v7" id="book">
    <div class="book-stage">
      <div class="spread" id="spread">
        <div class="sheet left" id="page-left" aria-live="polite">
          <div class="page-content" id="content-left"></div>
          <div class="page-number" id="pnum-left"></div>
          <button class="page-arrow page-arrow-v7 left" id="prev-btn" aria-label="Previous">
            <i class="bi bi-chevron-left"></i>
          </button>
        </div>

        <div class="spine" aria-hidden="true"></div>

        <div class="sheet right" id="page-right" aria-live="polite">
          <div class="page-content" id="content-right"></div>
          <div class="page-number" id="pnum-right"></div>
          <button class="page-arrow page-arrow-v7 right" id="next-btn" aria-label="Next">
            <i class="bi bi-chevron-right"></i>
          </button>
        </div>

        <div class="flip-layer" id="flip-layer" aria-hidden="true"></div>
      </div>
    </div>
  </div>
</div>

<style>
:root {
  --coral-main: #ff6b6b;
  --coral-dark: #e85a5a;
  --coral-light: #ffd7cc;
  --ink: #111827;
  --muted: #6b7280;
  --paper: #fffcf8;
  --paper-edge: #fcece4;
  --paper-shadow: 0 10px 30px rgba(255, 107, 107, 0.15);
  --bg-game: linear-gradient(145deg, #fff7e5 0%, #fff2f2 50%, #fefcfb 100%);
  --gutter: 20px; --flip-ms: 460ms; --arrow-pad: 56px;
}
.page-image-box {
  width: 100%;
  height: 220px;
  background-size: cover;
  background-position: center;
  border-radius: 15px;
  margin-bottom: 1.5rem;
  border: 2px solid var(--paper-edge);
  box-shadow: 0 5px 15px rgba(0,0,0,0.05);
}
/* Ensure text adjusts when image is present */
.sheet.has-image .page-content {
  font-size: 1.2rem;
  line-height: 1.6;
}
.btn-coral-v7 { background-color: var(--coral-main); color: white !important; border: none; padding: 8px 16px; transition: all 0.2s ease; }
.btn-coral-v7:hover { background-color: #e86060; }
/* Active state for TTS buttons */
.btn-coral-v7.active { background-color: darkseagreen; box-shadow: inset 0 2px 5px rgba(0,0,0,0.2); }

.border-coral-light { border: 2px solid var(--coral-light) !important; }

.game-title-v7, .book-title, .book-author { font-family: 'Baloo 2', cursive; font-weight: 800; }
.game-text-body, .page-content { font-family: 'Fredoka', 'Nunito', sans-serif; color: var(--ink); }

.book-wrap-v7 {
  position: relative; background: var(--bg-game) !important; border-radius: 30px; border: 3px solid var(--coral-light);
  box-shadow: 0 12px 40px rgba(255,107,107,.25); overflow: hidden; max-width: 1200px; margin-inline: auto;
}
.book-stage { position: relative; padding: 24px 18px 24px; perspective: 1600px; perspective-origin: 50% 40%; min-height: 64vh; }
.spread { position: relative; display: grid; grid-template-columns: minmax(280px, 1fr) var(--gutter) minmax(280px, 1fr); align-items: center; justify-items: center; min-height: 56vh; }
.spine { width: var(--gutter); border-radius: 12px; background: repeating-linear-gradient(180deg, #ffe7bb 0 6px, #ffdca8 6px 12px); border-left: 1px solid #ffd79b; border-right: 1px solid #ffe8c4; box-shadow: inset 0 0 18px rgba(255,174,53,.25); height: 100%; }

.sheet { position: relative; background: var(--paper); border-radius: 20px; border: 2px solid var(--paper-edge); box-shadow: var(--paper-shadow); padding: 28px var(--arrow-pad) 44px var(--arrow-pad); line-height: 1.9; overflow: hidden; height: clamp(520px, 70vh, 82vh); aspect-ratio: 3 / 4; display: flex; flex-direction: column; }
.sheet.left { transform: rotate(-.15deg); }
.sheet.right { transform: rotate(.15deg); }

.page-content { margin: auto 0; font-size: 1.35rem; line-height: 1.8; text-align: center; max-width: 90%; align-self: center; }
.page-number { position: absolute; right: 16px; bottom: 14px; font-weight: 700; font-size: .9rem; color: var(--muted); }

.sheet.is-cover { background: transparent; padding: 0; }
.sheet.is-cover .page-content { margin: 0; padding: 0; max-width: 100%; align-self: stretch; height: 100%; }
.cover-page-v2 { position: relative; width: 100%; height: 100%; background-size: cover; background-position: center; color: #fff; }
.cover-front-overlay-v2 { position: absolute; inset: 0; background: linear-gradient(to top, rgba(0,0,0,.7), rgba(0,0,0,.15)); }
.cover-front-inner-v2 { position: relative; z-index: 2; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: flex-end; text-align: center; padding: 2.5rem; }
.book-title { font-size: clamp(2.6rem, 4vw, 3.4rem); line-height: 1.1; margin-bottom: .5rem; color: #fff; }

.page-arrow-v7 { position: absolute; top: 50%; transform: translateY(-50%); width: 50px; height: 50px; border-radius: 50%; background: var(--coral-main); color: white; border: none; z-index: 3; font-size: 1.25rem; box-shadow: 0 5px 12px rgba(255,107,107,.4); transition: all 0.2s; }
.page-arrow-v7.left { left: 16px; }
.page-arrow-v7.right { right: 16px; }
.page-arrow-v7:disabled { opacity: .6; background: #ccc; }

.flip-layer { position: absolute; inset: 24px 18px 24px 18px; pointer-events: none; }

@media (max-width: 900px) {
  .spread { grid-template-columns: 1fr; }
  .spine, .flip-layer { display: none; }
  .sheet { transform: none; }
  .page-arrow-v7 { top: auto; bottom: 16px; transform: none; }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const storyTitle = {{ (story.title or '')|tojson }};
  const pageTexts = {{ (pages or [])|tojson }};

  function escapeHTML(s){
    return (s||'').replace(/[&<>"'`=\/]/g, c => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',
      "'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'
    }[c]));
  }

  function buildPagesFromServerList() {
    const list = [];
    list.push({
      html: `<div class="cover-page-v2" style="background-image: url('{{ story.visuals or "" }}');">
              <div class="cover-front-overlay-v2"></div>
              <div class="cover-front-inner-v2">
                <h1 class="book-title">${escapeHTML(storyTitle)}</h1>
              </div>
            </div>`,
      isTechnical: true
    });

    pageTexts.forEach(text => {
      list.push({
        html: `<div>${escapeHTML(text).replace(/\\n/g, '<br>')}</div>`,
        isTechnical: false
      });
    });

    list.push({
      html: `<div class="h-100 d-flex flex-column justify-content-center align-items-center text-center">
              <h2 class="mb-3 game-title-v7" style="color:var(--coral-main); font-size:2.5rem;">The End</h2>
            </div>`,
      isTechnical: true
    });
    return list;
  }

  const pages = buildPagesFromServerList();
  const totalPages = pages.length;
  const contentLeft = document.getElementById('content-left');
  const contentRight = document.getElementById('content-right');
  const spreadLeft = document.getElementById('page-left');
  const spreadRight = document.getElementById('page-right');
  const nextBtn = document.getElementById('next-btn');
  const prevBtn = document.getElementById('prev-btn');

  // TTS LOGIC
  const synth = window.speechSynthesis;
  let chosenVoice = null;
  let lastTextSpoken = "";

  const btnPlay = document.getElementById('tts-play');
  const btnPause = document.getElementById('tts-pause');
  const btnStop = document.getElementById('tts-stop');

  function setActiveBtn(activeId) {
    document.querySelectorAll('.tts-ctrl').forEach(b => b.classList.remove('active'));
    if(activeId) document.getElementById(activeId).classList.add('active');
  }

  function voiceScore(v) {
    const name = (v.name || "").toLowerCase();
    const lang = (v.lang || "").toLowerCase();
    let score = 0;
    if (lang.startsWith("en-us")) score += 70;
    else if (lang.startsWith("en-")) score += 50;
    const good = ["neural", "natural", "premium", "google", "microsoft", "samantha", "aria"];
    good.forEach(k => { if (name.includes(k)) score += 10; });
    return score;
  }

  function pickBestVoice() {
    const vs = synth.getVoices() || [];
    return vs.slice().sort((a,b) => voiceScore(b) - voiceScore(a))[0] || null;
  }

  function ensureVoiceReady(cb) {
    chosenVoice = pickBestVoice();
    if (chosenVoice) { cb && cb(); return; }
    setTimeout(() => { chosenVoice = pickBestVoice(); cb && cb(); }, 200);
  }

  function getCurrentSpreadText() {
    const leftIdx = (spread - 1) * 2;
    const rightIdx = leftIdx + 1;
    let text = "";
    if (pages[leftIdx] && !pages[leftIdx].isTechnical) text += (contentLeft.innerText || "").trim() + " ";
    if (pages[rightIdx] && !pages[rightIdx].isTechnical) text += (contentRight.innerText || "").trim();
    return text.trim();
  }

  function speakOrResume() {
    if (synth.paused) {
      synth.resume();
      setActiveBtn('tts-play');
      return;
    }

    const text = getCurrentSpreadText();
    if (!text) return;

    ensureVoiceReady(() => {
      synth.cancel();
      const utter = new SpeechSynthesisUtterance(text);
      if (chosenVoice) utter.voice = chosenVoice;

      // SPEED ADJUSTMENT: 0.8 is slower and more natural for reading
      utter.rate = 0.80;
      utter.pitch = 1.0;

      utter.onstart = () => setActiveBtn('tts-play');
      utter.onend = () => setActiveBtn(null);
      utter.onerror = () => setActiveBtn(null);

      synth.speak(utter);
    });
  }

  btnPlay.addEventListener('click', speakOrResume);

  btnPause.addEventListener('click', () => {
    if (synth.speaking && !synth.paused) {
      synth.pause();
      setActiveBtn('tts-pause');
    }
  });

  btnStop.addEventListener('click', () => {
    synth.cancel();
    setActiveBtn('tts-stop');
    setTimeout(() => setActiveBtn(null), 500); // Flash stop then clear
  });

  // NAVIGATION
  let spread = 1;
  function showSpread(s) {
    spread = s;
    const leftIdx = (spread - 1) * 2;
    const rightIdx = leftIdx + 1;

    spreadLeft.classList.toggle('is-cover', leftIdx === 0);
    contentLeft.innerHTML = pages[leftIdx].html;

    if (rightIdx < totalPages) {
      spreadRight.style.visibility = "visible";
      contentRight.innerHTML = pages[rightIdx].html;
    } else {
      spreadRight.style.visibility = "hidden";
      contentRight.innerHTML = "";
    }

    prevBtn.disabled = (spread === 1);
    nextBtn.disabled = (spread >= Math.ceil(totalPages / 2));

    // Auto-update page numbers if they exist in your UI
    if(document.getElementById('pnum-left')) document.getElementById('pnum-left').innerText = leftIdx + 1;
    if(document.getElementById('pnum-right')) document.getElementById('pnum-right').innerText = rightIdx + 1;
  }

  nextBtn.addEventListener('click', () => { synth.cancel(); setActiveBtn(null); showSpread(spread + 1); });
  prevBtn.addEventListener('click', () => { synth.cancel(); setActiveBtn(null); showSpread(spread - 1); });

  showSpread(1);
});
</script>
{% endblock %}