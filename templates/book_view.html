{% extends "base2.html" %}
{% block title %}{{ story.title }} Â· Book Reader{% endblock %}

{% block content %}
<link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&family=Baloo+2:wght@700;800&display=swap" rel="stylesheet">

<div class="container px-0 px-md-2 px-lg-3 mt-4">

  <div class="d-flex justify-content-between align-items-center flex-wrap gap-3 p-3 mb-4 bg-white rounded-4 shadow-sm border border-light">
    <div>
      <h3 class="game-title-v7 mb-0" style="font-size: 1.6rem; color: var(--coral-main);">{{ story.title }}</h3>
      <p class="text-muted small mb-0"><i class="bi bi-person-circle"></i> {{ story.author_name or "EduWeaver AI" }}</p>
    </div>

    <div class="d-flex align-items-center gap-3">
      <div class="btn-group rounded-pill overflow-hidden shadow-sm border border-coral-light">
        <button id="tts-play" class="btn btn-coral-v7 tts-ctrl" title="Play/Resume"><i class="bi bi-play-fill"></i></button>
        <button id="tts-pause" class="btn btn-coral-v7 tts-ctrl" title="Pause"><i class="bi bi-pause-fill"></i></button>
        <button id="tts-stop" class="btn btn-coral-v7 tts-ctrl" title="Stop"><i class="bi bi-stop-fill"></i></button>
      </div>
      <a href="{{ url_for('library') }}" class="btn btn-outline-secondary rounded-pill btn-sm game-text-body">
        <i class="bi bi-book"></i> Library
      </a>
    </div>
  </div>

  <div class="book-wrap-v7" id="book">
    <div class="book-stage">
      <div class="spread" id="spread">

        <div class="sheet left" id="page-left" aria-live="polite">
          <div class="page-content" id="content-left"></div>
          <div class="page-number" id="pnum-left"></div>
          <button class="page-arrow page-arrow-v7 left" id="prev-btn" aria-label="Previous">
            <i class="bi bi-chevron-left"></i>
          </button>
        </div>

        <div class="spine" aria-hidden="true"></div>

        <div class="sheet right" id="page-right" aria-live="polite">
          <div class="page-content" id="content-right"></div>
          <div class="page-number" id="pnum-right"></div>
          <button class="page-arrow page-arrow-v7 right" id="next-btn" aria-label="Next">
            <i class="bi bi-chevron-right"></i>
          </button>
        </div>

      </div>
    </div>
  </div>
</div>

<style>
:root {
  --coral-main: #ff6b6b;
  --coral-light: #ffd7cc;
  --ink: #111827;
  --muted: #6b7280;
  --paper: #fffcf8;
  --paper-edge: #fcece4;
  --bg-game: linear-gradient(145deg, #fff7e5 0%, #fff2f2 50%, #fefcfb 100%);
  --gutter: 20px;
  --arrow-pad: 56px;

  /* Dynamic Reader Variables */
  --reader-font-size: {{ reader_cfg.font_size or '1.4rem' }};
  --reader-line-height: {{ reader_cfg.line_height or '1.9' }};
  --reader-max-width: {{ reader_cfg.max_width or '90%' }};
}

/* Base Buttons */
.btn-coral-v7 { background-color: var(--coral-main); color: white !important; border: none; padding: 8px 16px; }
.btn-coral-v7:hover { background-color: #e86060; }

/* Book Wrapper */
.book-wrap-v7 {
  position: relative; background: var(--bg-game) !important;
  border-radius: 30px; border: 3px solid var(--coral-light);
  box-shadow: 0 12px 40px rgba(255,107,107,.25); overflow: hidden;
  max-width: 1200px; margin-inline: auto;
}
.book-stage {
  position: relative; padding: 24px 18px;
  min-height: 64vh;
  display: flex; align-items: center; justify-content: center;
}
.spread {
  position: relative; display: grid;
  grid-template-columns: minmax(280px, 1fr) var(--gutter) minmax(280px, 1fr);
  align-items: center; justify-items: center;
  width: 100%;
}
.spine {
  width: var(--gutter); height: 100%; min-height: 500px;
  border-radius: 12px;
  background: repeating-linear-gradient(180deg, #ffe7bb 0 6px, #ffdca8 6px 12px);
  border-left: 1px solid #ffd79b; border-right: 1px solid #ffe8c4;
}

/* Sheets (Pages) */
.sheet {
  position: relative; background: var(--paper);
  border-radius: 20px; border: 2px solid var(--paper-edge);
  box-shadow: 0 5px 15px rgba(0,0,0,0.08);
  padding: 30px 40px; /* Reduced side padding */
  overflow: hidden;
  height: clamp(520px, 70vh, 82vh); width: 100%;
  display: flex; flex-direction: column;
}

/* Dynamic Page Content */
.page-content {
  margin: auto 0;
  width: 100%;
  align-self: center;

  /* Dynamic Styles Applied Here */
  font-size: var(--reader-font-size);
  line-height: var(--reader-line-height);
  max-width: var(--reader-max-width);

  text-align: center; /* Default center, can be changed for advanced */
  white-space: pre-wrap; /* Preserves paragraphs */
}

/* Advanced Level Tweaks: Left align if text is dense */
{% if story.level == 'advanced' %}
.page-content {
  text-align: left;
  padding-left: 10px;
  padding-right: 10px;
}
{% endif %}

.page-number {
  position: absolute; right: 24px; bottom: 18px;
  font-weight: 700; font-size: .9rem; color: var(--muted);
}

/* Full Image Page */
.sheet.is-full-image { padding: 0; border: none; background-color: #333; }
.sheet.is-full-image .page-content { width: 100%; height: 100%; margin: 0; max-width: 100%; }
.full-page-img {
  width: 100%; height: 100%;
  background-size: cover; background-position: center; background-repeat: no-repeat;
}

/* Cover Styling */
.cover-page-v2 { width: 100%; height: 100%; background-size: cover; background-position: center; }
.cover-title-text {
  font-family: 'Baloo 2', cursive; font-size: 3rem;
  color: var(--coral-main); margin-bottom: 1rem; line-height: 1.1;
}

/* Navigation Arrows */
.page-arrow-v7 {
  position: absolute; top: 50%; transform: translateY(-50%);
  width: 44px; height: 44px; border-radius: 50%;
  background: var(--coral-main); color: white; border: none;
  z-index: 10; font-size: 1.2rem;
  box-shadow: 0 4px 10px rgba(255,107,107,.4);
  transition: transform 0.2s;
}
.page-arrow-v7:hover { transform: translateY(-50%) scale(1.1); }
.page-arrow-v7.left { left: 10px; }
.page-arrow-v7.right { right: 10px; }
.page-arrow-v7:disabled { opacity: 0; pointer-events: none; }

@media (max-width: 900px) {
  .spread { grid-template-columns: 1fr; }
  .spine { display: none; }
  .sheet { height: auto; min-height: 550px; }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const storyTitle = {{ (story.title or '')|tojson }};
  const storyAuthor = {{ (story.author_name or 'AI')|tojson }};
  const pageTexts = {{ (pages or [])|tojson }};
  const pageImages = {{ (page_images or [])|tojson }};
  const coverImage = '{{ story.visuals or "" }}';

  function escapeHTML(s){
    return (s||'').replace(/[&<>"'`=\/]/g, c => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',
      "'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'
    }[c]));
  }

  function buildPages() {
    const list = [];
    const hasAnyImages = Array.isArray(pageImages) && pageImages.some(u => u && u.length > 5);

    // 1. Cover (Left)
    list.push({
      html: `<div class="cover-page-v2" style="background-image:url('${coverImage}');"></div>`,
      type: 'image-full'
    });

    // 2. Title Page (Right)
    list.push({
      html: `<div class="d-flex flex-column align-items-center justify-content-center h-100 p-4">
               <h1 class="cover-title-text text-center">${escapeHTML(storyTitle)}</h1>
               <div style="width:60px; height:4px; background:var(--coral-main); margin: 2rem 0; opacity:0.6;"></div>
               <p class="text-muted text-uppercase small fw-bold tracking-wide">Written by</p>
               <h4 class="fw-bold text-dark">${escapeHTML(storyAuthor)}</h4>
             </div>`,
      type: 'text',
      speakText: `${storyTitle}. Written by ${storyAuthor}.`
    });

    // 3. Story Pages
    pageTexts.forEach((text, i) => {
      const imgUrl = hasAnyImages && pageImages[i] ? String(pageImages[i]).trim() : "";

      if (imgUrl) {
        list.push({
          html: `<div class="full-page-img" style="background-image:url('${imgUrl}');"></div>`,
          type: 'image-full'
        });
      }

      list.push({
        html: `<div class="fade-in-text">${escapeHTML(text)}</div>`,
        type: 'text',
        speakText: text,
        pageDisplay: i + 1 // Fixed page numbering logic
      });
    });

    // 4. End Page
    list.push({
      html: `<div class="h-100 d-flex flex-column justify-content-center align-items-center text-center">
              <h2 class="mb-3" style="color:var(--coral-main); font-family:'Baloo 2'; font-size:2.5rem;">The End</h2>
              <i class="bi bi-star-fill text-warning fs-3"></i>
            </div>`,
      type: 'end'
    });

    return list;
  }

  const pages = buildPages();
  const totalPages = pages.length;

  // DOM Elements
  const spreadLeft = document.getElementById('page-left');
  const spreadRight = document.getElementById('page-right');
  const contentLeft = document.getElementById('content-left');
  const contentRight = document.getElementById('content-right');
  const nextBtn = document.getElementById('next-btn');
  const prevBtn = document.getElementById('prev-btn');

  // --- TTS SETUP (Voice Selection) ---
  const synth = window.speechSynthesis;
  let availableVoices = [];

  function loadVoices() {
    availableVoices = synth.getVoices();
  }

  // Chrome loads voices asynchronously
  if (speechSynthesis.onvoiceschanged !== undefined) {
    speechSynthesis.onvoiceschanged = loadVoices;
  }
  loadVoices(); // Initial try

  function getAmericanVoice() {
    if (!availableVoices.length) loadVoices();

    // 1. Try specific high-quality US voices (Google/Microsoft/Apple)
    const preferred = availableVoices.find(v =>
      v.name === "Google US English" ||
      v.name === "Microsoft David" ||
      v.name === "Samantha"
    );
    if (preferred) return preferred;

    // 2. Fallback: Any voice marked strictly as 'en-US'
    const anyUS = availableVoices.find(v => v.lang === 'en-US');
    if (anyUS) return anyUS;

    // 3. Last resort: First English voice
    return availableVoices.find(v => v.lang.startsWith('en'));
  }
  // --- END TTS SETUP ---

  let spread = 1;

  function showSpread(s) {
    const maxSpread = Math.ceil(totalPages / 2);
    spread = Math.max(1, Math.min(s, maxSpread));

    const leftIdx = (spread - 1) * 2;
    const rightIdx = leftIdx + 1;

    renderPage(spreadLeft, contentLeft, 'pnum-left', leftIdx);
    renderPage(spreadRight, contentRight, 'pnum-right', rightIdx);

    prevBtn.disabled = (spread <= 1);
    nextBtn.disabled = (spread >= maxSpread);
  }

  function renderPage(sheetEl, contentEl, pNumId, idx) {
    if (pages[idx]) {
      sheetEl.style.visibility = "visible";
      contentEl.innerHTML = pages[idx].html;

      if (pages[idx].type === 'image-full') {
        sheetEl.classList.add('is-full-image');
      } else {
        sheetEl.classList.remove('is-full-image');
      }

      const pNum = document.getElementById(pNumId);
      if (pNum) {
        pNum.innerText = pages[idx].pageDisplay ? pages[idx].pageDisplay : '';
      }
    } else {
      sheetEl.style.visibility = "hidden";
      sheetEl.classList.remove('is-full-image');
    }
  }

  // TTS Controls
  document.getElementById('tts-play').addEventListener('click', () => {
    synth.cancel(); // Stop any previous speech

    const leftIdx = (spread - 1) * 2;
    const rightIdx = leftIdx + 1;

    let textToSpeak = "";
    if (pages[leftIdx] && pages[leftIdx].speakText) textToSpeak += pages[leftIdx].speakText + " ";
    if (pages[rightIdx] && pages[rightIdx].speakText) textToSpeak += pages[rightIdx].speakText;

    if (textToSpeak.trim()) {
      const utter = new SpeechSynthesisUtterance(textToSpeak);

      // --- APPLY AMERICAN VOICE ---
      const usVoice = getAmericanVoice();
      if (usVoice) {
        utter.voice = usVoice;
      }
      utter.lang = 'en-US'; // Force locale
      utter.rate = 0.9;     // Slightly slower for reading

      synth.speak(utter);
    }
  });

  document.getElementById('tts-stop').addEventListener('click', () => synth.cancel());
  document.getElementById('tts-pause').addEventListener('click', () => synth.pause());

  // Nav
  nextBtn.addEventListener('click', () => { synth.cancel(); showSpread(spread + 1); });
  prevBtn.addEventListener('click', () => { synth.cancel(); showSpread(spread - 1); });

  // Init
  showSpread(1);
});
</script>
{% endblock %}