{% extends "base2.html" %}
{% block title %}Assignment Detail · {{ group_template.assignment_title }}{% endblock %}

{% block content %}
<link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&family=Baloo+2:wght@700;800&display=swap" rel="stylesheet">

<div class="container mt-4 mb-5">
    <div class="row justify-content-center">
        <div class="col-12">
            <div class="card border-0 finish-card-v8 p-4 p-md-5">

                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h1 class="mb-1 finish-main-title">{{ group_template.assignment_title }}</h1>
                        <p class="mb-1 finish-sub-text">
                            Source Story: <strong>{{ group_template.story_title }}</strong>
                        </p>
                        <p class="mb-4 finish-sub-text">
                            Type: <strong>{{ group_template.assignment_type|capitalize }} Assignment</strong>
                        </p>
                    </div>
                    <div>
                        <a href="{{ url_for('admin_stories', tab='assigned') }}" 
                           class="btn btn-sm btn-outline-secondary finish-text-button rounded-pill">
                            <i class="bi bi-arrow-left me-1"></i> Back to Assigned
                        </a>
                    </div>
                </div>

                <h5 class="fw-semibold mb-3 finish-section-title">Assignment Status Summary</h5>
                <div class="row g-3 mb-4">
                    <div class="col-md-4">
                        <div class="card text-center h-100 p-2 bg-light-blue">
                            <div class="card-body">
                                <h4 class="fw-bold text-deep-blue">{{ stats.total }}</h4>
                                <p class="mb-0 small text-muted">Total Assigned</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card text-center h-100 p-2 bg-light-yellow">
                            <div class="card-body">
                                <h4 class="fw-bold text-deep-blue">{{ stats.submitted }}</h4>
                                <p class="mb-0 small text-muted">Awaiting Grading (Submitted)</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card text-center h-100 p-2 bg-light-orange">
                            <div class="card-body">
                                <h4 class="fw-bold text-deep-blue">{{ stats.graded }}</h4>
                                <p class="mb-0 small text-muted">Graded/Reviewed</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="fw-semibold finish-section-title mb-0">Student Progress</h5>

                    {# --- NEW BUTTON TO VIEW WORKSHEET CONTENT --- #}
                    <button type="button"
                            class="btn btn-action-primary rounded-pill finish-text-button btn-sm"
                            data-bs-toggle="modal"
                            data-bs-target="#worksheetContentModal"
                            onclick="loadWorksheetContent({{ assignment_id }})">
                        <i class="bi bi-file-text me-1"></i> View Worksheet Content
                    </button>
                    {# --- END NEW BUTTON --- #}
                </div>

                {% if assignees %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover align-middle">
                        <thead>
                            <tr>
                                <th>Student</th>
                                <th>Status</th>
                                <th>Score</th>
                                <th>Attempts</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for assignee in assignees %}
                            <tr>
                                <td>{{ assignee.username }}</td>
                                <td>
                                    {% set status = assignee.status or 'assigned' %}
                                    {% if status == 'submitted' %}
                                        <span class="badge text-bg-warning">Submitted</span>
                                    {% elif status == 'graded' %}
                                        <span class="badge text-bg-success">Graded</span>
                                    {% else %}
                                        <span class="badge text-bg-secondary">Assigned</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if assignee.score is not none %}
                                        <strong>{{ assignee.score|int }}%</strong>
                                    {% else %}
                                        —
                                    {% endif %}
                                </td>
                                <td>{{ assignee.attempt_count or 0 }}</td>
                                <td>
                                    {# Direct link to grade_redirect route if submitted, or student's detail page otherwise #}
                                    {% if status == 'submitted' %}
                                        <a href="{{ url_for('admin_grade_redirect', assignment_id=assignee.assignment_id) }}"
                                           class="btn btn-sm btn-action-primary rounded-pill">
                                            Review/Grade
                                        </a>
                                    {% else %}
                                        <a href="{{ url_for('assignment_detail', assignment_id=assignee.assignment_id) }}"
                                           class="btn btn-sm btn-outline-secondary rounded-pill">
                                            View
                                        </a>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-info finish-alert-v8 small finish-text-body">
                    No students found matching this assignment template.
                </div>
                {% endif %}

            </div>
        </div>
    </div>
</div>

{# --- WORKSHEET CONTENT MODAL --- #}
<div class="modal fade" id="worksheetContentModal" tabindex="-1" aria-labelledby="worksheetContentLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title finish-section-title" id="worksheetContentLabel">Worksheet Content: <span id="modalAssignmentTitle"></span></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="modalWorksheetBody">
        <p class="text-muted small">Loading content...</p>
        <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary rounded-pill finish-text-button" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
{# --- END WORKSHEET CONTENT MODAL --- #}


{# --- JAVASCRIPT FOR DYNAMIC MODAL LOADING --- #}
<script>
    function loadWorksheetContent(assignmentId) {
        const modalBody = document.getElementById('modalWorksheetBody');
        const modalTitle = document.getElementById('modalAssignmentTitle');

        // Clear previous content and show loading spinner
        modalBody.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"></div><p class="text-muted small mt-2">Loading worksheet content...</p></div>';
        modalTitle.textContent = 'Loading...';

        fetch(`/admin/assignments/${assignmentId}/content`)
            .then(response => response.json())
            .then(data => {
                modalTitle.textContent = data.title || "Worksheet Details";

                let contentHtml = '';

                if (data.error) {
                    contentHtml = `<div class="alert alert-danger">${data.error}</div>`;
                } else if (data.sections || data.prompt_story) {

                    if (data.type === 'writing') {
                        // --- WRITING ASSIGNMENTS: Display story prompt if available ---
                        contentHtml += `<p class="small text-muted mb-3">Mode: <strong>${data.type_detail || 'Unknown'}</strong> (Linked to Story: ${data.story})</p>`;

                        if (data.prompt_story) {
                            // Basic markdown cleanup for display
                            let cleanPrompt = data.prompt_story.replace(/###/g, '<h6 class="mt-3 text-coral-main">').replace(/\n\n/g, '<br><br>').replace(/\n/g, ' ').replace(/<br><br><h6/g, '<br><br></h6><h6');
                            cleanPrompt = cleanPrompt.replace(/---/g, '<hr>');

                            contentHtml += `
                                <h5 class="mt-4 text-coral-main">The Story So Far / Prompt</h5>
                                <div class="bg-light p-3 border rounded-3 mb-4 small" style="white-space: pre-wrap;">
                                    ${cleanPrompt}
                                </div>
                                <hr/>
                            `;
                        }

                        // Display planning/completion sections
                        data.sections.forEach(section => {
                            contentHtml += `<h6 class="mt-3 text-deep-blue">${section.label}</h6>`;
                            if (section.instruction) {
                                contentHtml += `<p class="small text-muted">${section.instruction}</p>`;
                            }
                            if (section.guiding_questions && section.guiding_questions.length > 0) {
                                contentHtml += `<ul class="small list-unstyled">`;
                                section.guiding_questions.forEach(q => {
                                    contentHtml += `<li><i class="bi bi-dot me-1"></i>${q}</li>`;
                                });
                                contentHtml += `</ul>`;
                            }
                        });

                        // Add checklist if available
                        if (data.checklist && data.checklist.length > 0) {
                             contentHtml += `<h6 class="mt-4 text-deep-blue">Writing Checklist</h6><ul class="small">`;
                             data.checklist.forEach(item => {
                                 contentHtml += `<li>${item}</li>`;
                             });
                             contentHtml += `</ul>`;
                        }

                    } else if (data.type === 'reading') {
                        // --- READING ASSIGNMENTS: Display structured questions ---
                        contentHtml += `<p class="small text-muted mb-3">Source Story: ${data.story}</p>`;

                        data.sections.forEach(section => {
                            if (section.questions && section.questions.length > 0) {
                                contentHtml += `<h5 class="mt-4 text-coral-main">${section.label} (${section.questions.length})</h5>`;
                                section.questions.forEach((q, index) => {
                                    contentHtml += `<div class="mb-3 p-3 border rounded-3 small">`;

                                    if (section.label === 'MCQ Questions') {
                                        contentHtml += `<p class="fw-bold mb-1">Q${index + 1}. ${q.question}</p>`;
                                        q.options.forEach((opt, optIndex) => {
                                            const isCorrect = (q.correct_index === optIndex) ? 'fw-bold text-success' : 'text-muted';
                                            contentHtml += `<p class="mb-0 ${isCorrect}">[${String.fromCharCode(65 + optIndex)}] ${opt}</p>`;
                                        });
                                    } else if (section.label === 'Fill-in-the-Blank') {
                                        const sentence = q.sentence.replace('___', '(**___**)');
                                        contentHtml += `<p class="mb-1">${index + 1}. ${sentence}</p>`;
                                        contentHtml += `<p class="mb-0 text-success small">Answer: ${q.answer}</p>`;
                                    } else if (section.label === 'Short Answer') {
                                        contentHtml += `<p class="fw-bold mb-1">SA${index + 1}. ${q.question}</p>`;
                                        contentHtml += `<p class="mb-0 text-info small">Model Answer: ${q.model_answer}</p>`;
                                    }
                                    contentHtml += `</div>`;
                                });
                            }
                        });
                    }
                } else if (data.raw_text) {
                     contentHtml = `<h6 class="mt-3 text-deep-blue">Raw Assignment JSON:</h6><pre class="bg-light p-3 small">${data.raw_text}</pre>`;
                } else {
                    contentHtml = `<p class="text-muted">No specific question payload found for this assignment.</p>`;
                }

                modalBody.innerHTML = contentHtml;

            })
            .catch(error => {
                console.error('Error fetching worksheet content:', error);
                modalBody.innerHTML = `<div class="alert alert-danger">Failed to load content due to a network or server error.</div>`;
            });
    }
</script>
{# Define styles used in this template (copied from your assignment_finish.html) #}
<style>
:root {
    --coral-main: #ff6b6b;
    --coral-light: #ffd7cc;
    --ink: #111827;
    --muted: #6b7280;
    --deep-blue: #0A3D62;
    --shadow-soft: 0 10px 30px rgba(255, 107, 107, 0.1), 0 4px 8px rgba(0, 0, 0, 0.05);
}
.finish-main-title {
    font-family: 'Baloo 2', cursive;
    font-weight: 800;
    color: var(--coral-main);
    font-size: 2.2rem;
}
.finish-section-title {
    font-family: 'Baloo 2', cursive;
    font-weight: 700 !important;
    color: var(--ink);
    font-size: 1.4rem;
}
.finish-sub-text, .finish-text-button {
    font-family: 'Fredoka', 'Nunito', sans-serif;
}
.text-deep-blue {
    color: var(--deep-blue) !important;
}
.finish-card-v8 {
    border-radius: 1.75rem;
    background: #fffcf8;
    box-shadow: 0 1rem 3rem rgba(255, 107, 107, 0.15);
    border: 3px solid var(--coral-light) !important;
}
.bg-light-blue { background-color: #e6f0ff; }
.bg-light-yellow { background-color: #fffdf7; }
.bg-light-orange { background-color: #ffece5; }
.btn-action-primary {
    background-color: var(--coral-main);
    border-color: var(--coral-main);
    color: white;
}
.btn-action-primary:hover {
    background-color: #e86060;
    border-color: #e86060;
}
</style>

{% endblock %}