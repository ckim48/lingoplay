{% extends "base.html" %}
{% block title %}Library · EduWeaver{% endblock %}
{% block content %}

<div class="card border-0 lp-card-modern overflow-hidden mt-4">
  <div class="card-body p-4 p-lg-5">
    <!-- Top bar -->
    <div class="d-flex flex-wrap gap-3 justify-content-between align-items-center mb-4">
      <h3 class="mb-0 fw-semibold">Library</h3>
      <div class="d-flex align-items-center gap-3">
        <div class="small text-muted">Matches: <span id="matchCount">0</span></div>
        <a href="{{ url_for('story_new') }}" class="btn btn-sky-light">
          <i class="bi bi-magic me-1"></i> New Story
        </a>
      </div>
    </div>

    <!-- Controls -->
    <div class="row g-3 align-items-end mb-3">
      <div class="col-md-8">
        <label class="form-label small text-uppercase fw-bold text-muted">Search</label>
        <div class="input-group input-group-lg lp-input">
          <span class="input-group-text"><i class="bi bi-search"></i></span>
          <input id="libSearch" class="form-control" placeholder="Search by title, author, or keywords">
          <button class="btn btn-outline-secondary only-md" id="libClear" type="button" title="Clear">
            <i class="bi bi-x-circle"></i>
          </button>
        </div>
      </div>
      <div class="col-md-4">
        <label class="form-label small text-uppercase fw-bold text-muted">Sort</label>
        <select id="libSort" class="form-select form-select-lg lp-input">
          <option value="newest">Newest first</option>
          <option value="oldest">Oldest first</option>
          <option value="title">Title (A–Z)</option>
          <option value="author">Author (A–Z)</option>
        </select>
      </div>
    </div>

    <!-- Grid of cards -->
    <div id="libGrid" class="row g-4">
      {% for d in completes %}
        {% set title = d.story_title or 'Untitled Story' %}
        <div class="col-12 col-md-6 col-lg-4 lib-wrap"
             data-title="{{ title|lower }}"
             data-author="{{ (d.learner_name or 'guest')|lower }}"
             data-keywords="{{ (d.seed_prompt or '')|lower }}"
             data-created="{{ (d.created_at|string).strip() }}">
          <div class="card h-100 lp-story-card position-relative">
            <div class="card-body d-flex flex-column">
              <div class="d-flex align-items-start justify-content-between mb-2">
                <a href="{{ url_for('finish_view', draft_id=d.id) }}" class="stretched-link text-decoration-none">
                  <h5 class="card-title mb-0">{{ title }}</h5>
                </a>
                <span class="badge lp-badge-lang ms-2">{{ d.language|upper }}</span>
              </div>

              <div class="text-secondary small mb-2">
                <i class="bi bi-person"></i> {{ d.learner_name or 'guest' }}
              </div>

              <p class="card-text small flex-grow-1">
                <span class="fw-semibold">Keywords/Phonics:</span>
                {{ d.seed_prompt[:120] }}{% if d.seed_prompt|length > 120 %}…{% endif %}
              </p>
            </div>

            <div class="card-footer bg-transparent d-flex justify-content-between align-items-center">
              <span class="small text-secondary">
                <i class="bi bi-clock me-1"></i>{{ d.created_at|dt("%Y-%m-%d %H:%M") }}
              </span>

              <div class="d-flex gap-2">
                <a href="{{ url_for('finish_view', draft_id=d.id) }}" class="btn btn-sm btn-outline-secondary position-relative">
                  Read
                </a>

                {% if current_user and current_user.is_admin %}
                  <button type="button"
                          class="btn btn-sm btn-outline-danger position-relative"
                          data-delete
                          data-draft-id="{{ d.id }}"
                          data-title="{{ title|e }}"
                          title="Delete">
                    <i class="bi bi-trash"></i>
                  </button>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      {% else %}
        <div class="col-12">
          <div class="text-secondary">No completed stories yet.</div>
        </div>
      {% endfor %}
    </div>
  </div>
</div>

<!-- Delete confirmation modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4">
      <div class="modal-header border-0">
        <h5 class="modal-title" id="deleteModalLabel">Delete story?</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" data-cancel></button>
      </div>
      <div class="modal-body pt-0">
        <p class="mb-2">You're about to delete:</p>
        <div class="p-2 rounded border bg-light small" id="deleteStoryTitle"></div>
        <p class="text-danger small mb-0 mt-2">This cannot be undone.</p>
      </div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-sky-light" data-bs-dismiss="modal" data-cancel>Cancel</button>
        <form id="deleteForm" method="post" class="m-0">
          <button type="submit" class="btn btn-outline-danger">
            <i class="bi bi-trash me-1"></i> Delete
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

<style>
  :root{
    --ink:#0f1b33; --muted:#64748b; --bg:#f6f9ff; --paper:#ffffff;
    --sky-25:#f2f8ff; --sky-50:#e8f3ff; --sky-100:#d8ebff; --sky-200:#c2e0ff;
    --sky-300:#a5d1ff; --sky-400:#7fbaff; --sky-500:#4ea2ff; --sky-600:#2f8cea; --sky-700:#236fbb;
    --border:#e5eaf3;
  }

  body{ background:var(--bg); }
  .lp-card-modern{ border-radius:18px; box-shadow:0 10px 30px rgba(2,6,23,.06), 0 2px 6px rgba(2,6,23,.04); background:var(--paper); }

  /* Inputs (sky theme) */
  .lp-input .input-group-text{
    border-radius:.8rem 0 0 .8rem; border-right:0; background:#f8fafc; color:var(--sky-700);
  }
  .lp-input .form-control{ border-left:0; border-radius:0 .8rem .8rem 0; }
  .lp-input .form-control:focus, .form-select.lp-input:focus{
    border-color:var(--sky-400);
    box-shadow:0 0 0 .25rem rgba(47,140,234,.15);
  }
  .form-select.lp-input{ border-radius:.8rem; }

  /* Badges + buttons (sky) */
  .lp-badge-lang{
    background:var(--sky-50);
    color:var(--sky-700);
    border:1px solid var(--sky-200);
    font-weight:600;
  }
  .btn-sky{
    --bs-btn-color:#0b1224; --bs-btn-bg:var(--sky-200); --bs-btn-border-color:var(--sky-300);
    --bs-btn-hover-bg:var(--sky-300); --bs-btn-hover-border-color:var(--sky-400);
    --bs-btn-active-bg:var(--sky-400); --bs-btn-active-border-color:var(--sky-500);
  }
  .btn-sky-light{
    --bs-btn-color:#0b1224; --bs-btn-bg:var(--sky-50); --bs-btn-border-color:var(--sky-100);
    --bs-btn-hover-bg:var(--sky-100); --bs-btn-hover-border-color:var(--sky-200);
  }

  /* Story cards */
  .lp-story-card{
    border:1px solid var(--border);
    border-radius:14px;
    transition:transform .1s ease, box-shadow .2s ease, border-color .2s ease;
  }
  .lp-story-card:hover{
    transform:translateY(-2px);
    box-shadow:0 10px 24px rgba(2,6,23,.08);
    border-color:var(--sky-200);
  }
  .lp-story-card .card-title{ font-weight:600; line-height:1.25; color: var(--sky-700); }
  .lp-story-card:hover .card-title,
  .lp-story-card a:focus-visible .card-title{ color: var(--sky-600); }
  .lp-story-card a.stretched-link:focus-visible{
    outline: 3px solid rgba(47,140,234,.30);
    outline-offset: 2px; border-radius: 8px;
  }
  .lp-story-card a.text-decoration-none{ color: inherit; }
  .lp-story-card .btn-outline-secondary{ border-color:var(--border); }
  .lp-story-card .btn-outline-secondary:hover{
    border-color:var(--sky-300); color:var(--sky-700); background:var(--sky-50);
  }

  /* Footer controls above stretched-link */
  .lp-story-card .card-footer .btn,
  .lp-story-card .card-footer form { position: relative; z-index: 5; }

  /* Danger outline */
  .btn-outline-danger { border-color:#ef4444; }
  .btn-outline-danger:hover { background:#fee2e2; color:#b91c1c; border-color:#f87171; }
</style>

<script>
  (function(){
    const grid   = document.getElementById('libGrid');
    const wraps  = [...grid.querySelectorAll('.lib-wrap')];
    const search = document.getElementById('libSearch');
    const clear  = document.getElementById('libClear');
    const sort   = document.getElementById('libSort');
    const count  = document.getElementById('matchCount');

    const norm = s => (s||'').toLowerCase();

    function apply(){
      const q = norm(search.value);
      let visible = [];

      wraps.forEach(w => {
        const show = !q || w.dataset.title.includes(q) || w.dataset.author.includes(q) || w.dataset.keywords.includes(q);
        w.style.display = show ? '' : 'none';
        if (show) visible.push(w);
      });

      const sv = sort.value;
      visible.sort((A,B) => {
        if (sv === 'newest')  return new Date(B.dataset.created) - new Date(A.dataset.created);
        if (sv === 'oldest')  return new Date(A.dataset.created) - new Date(B.dataset.created);
        if (sv === 'title')   return A.dataset.title.localeCompare(B.dataset.title);
        if (sv === 'author')  return A.dataset.author.localeCompare(B.dataset.author);
        return 0;
      });

      visible.forEach(el => grid.appendChild(el));
      if (count) count.textContent = visible.length;
    }

    apply();
    search.addEventListener('input', apply);
    sort.addEventListener('change', apply);
    clear?.addEventListener('click', () => { search.value=''; search.focus(); apply(); });

    // Delete modal
    const deleteBtns = document.querySelectorAll('[data-delete]');
    const modalEl = document.getElementById('deleteModal');
    const titleEl = document.getElementById('deleteStoryTitle');
    const formEl  = document.getElementById('deleteForm');

    function stopAll(e){ e.preventDefault(); e.stopPropagation(); if (e.stopImmediatePropagation) e.stopImmediatePropagation(); }

    deleteBtns.forEach(btn => {
      btn.addEventListener('click', (e) => {
        stopAll(e);
        const id = btn.getAttribute('data-draft-id');
        const t  = btn.getAttribute('data-title') || 'This story';
        titleEl.textContent = t;
        formEl.setAttribute('action', "{{ url_for('library_delete_draft', draft_id=0) }}".replace('/0', '/' + id));
        if (window.bootstrap && window.bootstrap.Modal) {
          window.bootstrap.Modal.getOrCreateInstance(modalEl).show();
        }
      }, true);
    });

    modalEl?.querySelectorAll('[data-cancel]').forEach(el=> el.addEventListener('click', stopAll));
  })();
</script>

{% endblock %}
