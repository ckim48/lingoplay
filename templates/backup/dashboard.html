{% extends "base.html" %}
{% block title %}Dashboard · EduWeaver{% endblock %}
{% block content %}

<div class="row g-4">
  <div class="col-lg-6">
    <!-- Overview -->
    <div class="card border-0 shadow-sm rounded-4 lp-card-modern">
      <div class="card-body p-4">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 class="mb-0 lp-section-title">Overview</h5>
          <a class="btn btn-sm btn-sky-light" href="{{ url_for('dashboard_export') }}">
            <i class="bi bi-download me-1"></i> Export CSV
          </a>
        </div>
        <div class="row text-center">
          <div class="col-6">
            <div class="display-6 lp-metric">{{ story_count }}</div>
            <div class="text-secondary small">Stories</div>
          </div>
          <div class="col-6">
            <div class="display-6 lp-metric">{{ finish_count }}</div>
            <div class="text-secondary small">Completed Stories</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Quizzes Ready -->
    <div class="card border-0 shadow-sm rounded-4 mt-4 lp-card-modern">
      <div class="card-body p-4">
        <h6 class="mb-3 lp-section-title">Quizzes Ready</h6>
        <ul class="list-group list-group-flush">
          {% for q in quizzes_ready %}
            <li class="list-group-item d-flex justify-content-between align-items-center lp-list-item">
              <div class="me-3">
                <a class="text-decoration-none fw-semibold lp-link" href="{{ url_for('quiz_take', slug=q.slug) }}">
                  {{ q.title }}
                </a>
                <div class="small text-secondary mt-1">
                  <span class="badge rounded-pill lp-badge-soft me-2">{{ q.qcount }} Qs</span>
                  {% if q.last_score is not none and q.last_total is not none %}
                    Last: <strong>{{ q.last_score }}/{{ q.last_total }}</strong>
                    {% if q.last_when %} · {{ q.last_when|dt("%Y-%m-%d %H:%M") }}{% endif %}
                  {% else %}
                    Not taken yet
                  {% endif %}
                </div>
              </div>
              <a class="btn btn-sm btn-sky" href="{{ url_for('quiz_take', slug=q.slug) }}">
                {% if q.last_score is not none %}Retake{% else %}Take{% endif %} Quiz
              </a>
            </li>
          {% else %}
            <li class="list-group-item text-secondary">No quizzes yet. Generate a worksheet from a story.</li>
          {% endfor %}
        </ul>
      </div>
    </div>

    <!-- Recent Attempts -->
    <div class="card border-0 shadow-sm rounded-4 mt-4 lp-card-modern">
      <div class="card-body p-4">
        <h6 class="mb-3 lp-section-title">Recent Quiz Attempts</h6>
        <div class="table-responsive">
          <table class="table align-middle">
            <thead class="lp-table-head">
              <tr>
                <th>Name</th>
                <th>Story ID</th>
                <th>Score</th>
                <th>When</th>
              </tr>
            </thead>
            <tbody>
              {% for a in attempts %}
                <tr>
                  <td>{{ a.taker_name }}</td>
                  <td>{{ a.story_id }}</td>
                  <td><span class="badge rounded-pill lp-badge-soft">{{ a.score }}/{{ a.total }}</span></td>
                  <td class="small text-secondary">{{ a.created_at|dt("%Y-%m-%d %H:%M") }}</td>
                </tr>
              {% else %}
                <tr><td colspan="4" class="text-secondary">No attempts yet.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-6">
    <!-- Stories to Finish -->
    <div class="card border-0 shadow-sm rounded-4 lp-card-modern">
      <div class="card-body p-4">
        <h6 class="mb-3 lp-section-title">Stories to Finish</h6>
        <ul class="list-group list-group-flush">
          {% for d in unfinished_drafts %}
            <li class="list-group-item position-relative lp-list-item">
              <button type="button"
                      class="btn btn-sm btn-outline-danger position-absolute top-0 end-0 m-2"
                      data-del-finish
                      data-draft-id="{{ d.id }}"
                      data-title="{{ (d.story_title or 'Untitled Story')|e }}"
                      title="Delete this draft">
                <i class="bi bi-x-lg"></i>
              </button>
              <div class="me-3 pe-4">
                <a class="text-decoration-none fw-semibold lp-link" href="{{ url_for('finish_view', draft_id=d.id) }}">
                  {{ d.story_title or 'Untitled Story' }}
                </a>
                <div class="small text-secondary">
                  Keywords/Phonics: {{ d.seed_prompt[:60] }}{% if d.seed_prompt|length > 60 %}…{% endif %}
                  · <span class="badge rounded-pill lp-badge-lang align-text-bottom">{{ d.language|upper }}</span>
                  · {{ d.created_at|dt("%Y-%m-%d %H:%M") }}
                </div>
              </div>
            </li>
          {% else %}
            <li class="list-group-item text-secondary">Nothing to finish. Nice!</li>
          {% endfor %}
        </ul>
      </div>
    </div>

    <!-- Completed Stories -->
    <div class="card border-0 shadow-sm rounded-4 mt-4 lp-card-modern">
      <div class="card-body p-4">
        <h6 class="mb-3 lp-section-title">Your Completed Stories</h6>
        <ul class="list-group list-group-flush">
          {% for d in completed_drafts %}
            <li class="list-group-item d-flex justify-content-between align-items-center lp-list-item">
              <div class="me-3">
                <a class="text-decoration-none fw-semibold lp-link" href="{{ url_for('finish_view', draft_id=d.id) }}">
                  {{ d.story_title or 'Untitled Story' }}
                </a>
                <div class="small text-secondary">
                  Keywords/Phonics: {{ d.seed_prompt[:60] }}{% if d.seed_prompt|length > 60 %}…{% endif %}
                  · <span class="badge rounded-pill lp-badge-lang align-text-bottom">{{ d.language|upper }}</span>
                </div>
              </div>
              <span class="small text-secondary">{{ d.created_at|dt("%Y-%m-%d %H:%M") }}</span>
            </li>
          {% else %}
            <li class="list-group-item text-secondary">No completed stories yet.</li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="dashDeleteModal" tabindex="-1" aria-labelledby="dashDeleteLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4">
      <div class="modal-header border-0">
        <h5 class="modal-title" id="dashDeleteLabel">Delete draft?</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" data-cancel></button>
      </div>
      <div class="modal-body pt-0">
        <p class="mb-2">You're about to delete:</p>
        <div class="p-2 rounded border bg-light small" id="dashDeleteTitle"></div>
        <p class="text-danger small mb-0 mt-2">This cannot be undone.</p>
      </div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-sky-light" data-bs-dismiss="modal" data-cancel>Cancel</button>
        <form id="dashDeleteForm" method="post" class="m-0" action="#">
          <button type="submit" class="btn btn-outline-danger">
            <i class="bi bi-trash me-1"></i> Delete
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

<style>
  :root{
    --sky-25:#f2f8ff; --sky-50:#e8f3ff; --sky-100:#d8ebff; --sky-200:#c2e0ff;
    --sky-300:#a5d1ff; --sky-400:#7fbaff; --sky-500:#4ea2ff; --sky-600:#2f8cea; --sky-700:#236fbb;
    --border:#e5eaf3;
  }

  body{ background: #f6f9ff; }
  .lp-card-modern{ border-radius:18px; box-shadow:0 10px 30px rgba(2,6,23,.06), 0 2px 6px rgba(2,6,23,.04); }
  .lp-section-title{ color:var(--sky-700); font-weight:700; }
  .lp-metric{ color:var(--sky-700); }

  .lp-link{ color:var(--sky-700); text-decoration:none; }
  .lp-link:hover{ color:var(--sky-600); }

  .lp-badge-soft, .lp-badge-lang{
    background:var(--sky-50);
    color:var(--sky-700);
    border:1px solid var(--sky-200);
    font-weight:600;
  }

  .btn-sky{
    --bs-btn-color:#0b1224; --bs-btn-bg:var(--sky-200); --bs-btn-border-color:var(--sky-300);
    --bs-btn-hover-bg:var(--sky-300); --bs-btn-hover-border-color:var(--sky-400);
    --bs-btn-active-bg:var(--sky-400); --bs-btn-active-border-color:var(--sky-500);
  }
  .btn-sky-light{
    --bs-btn-color:#0b1224; --bs-btn-bg:var(--sky-50); --bs-btn-border-color:var(--sky-100);
    --bs-btn-hover-bg:var(--sky-100); --bs-btn-hover-border-color:var(--sky-200);
  }

  .list-group-item{ border-color:var(--border); transition:background .15s ease; }
  .lp-list-item:hover{ background:var(--sky-50); }

  .lp-table-head{ background:var(--sky-50); border-bottom:1px solid var(--border); }

  [data-del-finish]{ z-index:5; transition:background .15s ease, color .15s ease, border-color .15s ease; }
  [data-del-finish]:hover{ background:#fee2e2; color:#b91c1c; border-color:#f87171; }
</style>

<script>
(function(){
  const modalEl = document.getElementById('dashDeleteModal');
  const titleEl = document.getElementById('dashDeleteTitle');
  const formEl  = document.getElementById('dashDeleteForm');

  function stopAll(e){
    e.preventDefault();
    e.stopPropagation();
    if (e.stopImmediatePropagation) e.stopImmediatePropagation();
  }

  document.querySelectorAll('[data-del-finish]').forEach(btn=>{
    btn.addEventListener('click', (e)=>{
      stopAll(e);
      const id = btn.getAttribute('data-draft-id');
      const t  = btn.getAttribute('data-title') || 'This draft';
      titleEl.textContent = t;
      formEl.setAttribute('action', "{{ url_for('dashboard_delete_finish', draft_id=0) }}".replace('/0', '/' + id));
      if (window.bootstrap && window.bootstrap.Modal){
        window.bootstrap.Modal.getOrCreateInstance(modalEl).show();
      } else if(confirm(`Delete “${t}”? This cannot be undone.`)){ formEl.submit(); }
    }, true);
  });

  modalEl?.querySelectorAll('[data-cancel]').forEach(el=> el.addEventListener('click', stopAll));
})();
</script>

{% endblock %}
