{% extends "base2.html" %}
{% block title %}Finish the Story Â· {{ story.title }}{% endblock %}

{% block content %}

<link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&family=Baloo+2:wght@700;800&display=swap" rel="stylesheet">

{# -----------------------------
   Detect which part user writes: beginning / middle / end
   ----------------------------- #}
{% set part = 'middle' %}
{% set t = (assignment.assignment_title or '') | lower %}
{% set ins = (assignment.instructions or '') | lower %}
{% set blob = t ~ ' ' ~ ins %}
{% if 'beginning' in blob %}
  {% set part = 'beginning' %}
{% elif 'middle' in blob %}
  {% set part = 'middle' %}
{% elif 'ending' in blob or ' end ' in blob or blob.endswith(' end') %}
  {% set part = 'end' %}
{% endif %}

<div class="container mt-4 mb-5">
  <div class="row justify-content-center">
    <div class="col-12">
      <div class="card border-0 finish-card-v8">
        <div class="card-body p-4 p-md-5">

          <h1 class="mb-2 finish-main-title">
            {% if assignment.assignment_type == 'writing' %}
              Creative Writing Workshop
            {% else %}
              Finish the Story
            {% endif %}
          </h1>

          <p class="mb-4 finish-sub-text">
            Mission: <strong class="text-deep-blue">{{ assignment.assignment_title or story.title }}</strong>
          </p>

          {% if assignment.instructions %}
            <div class="alert alert-info finish-alert-v8 small finish-text-body">
              <strong class="fw-bold">Instructions:</strong><br>
              {{ assignment.instructions | nl2br }}
            </div>
          {% endif %}

          {# =========================
             Checklist & Idea Helper
             ========================= #}
          {% if assignment.assignment_type == 'writing' %}
            <div class="story-reminder mb-3">
              <div class="reminder-title">Story Grammar Reminder</div>
              <div class="small reminder-text">
                Check for: <strong>Character</strong>, <strong>Setting</strong>, <strong>Problem</strong>, <strong>Actions</strong>, <strong>Resolution</strong>.
              </div>
            </div>

            <div class="row g-3 mb-4">
              <div class="col-lg-7">
                <div class="check-card">
                  <div class="d-flex align-items-center justify-content-between mb-2">
                    <h6 class="mb-0 check-title">Did I include everything?</h6>
                    <span class="small text-muted" id="checkCountLabel">0 / 5</span>
                  </div>
                  <div class="progress check-progress mb-3" role="progressbar">
                    <div class="progress-bar" id="checkProgressBar" style="width: 0%"></div>
                  </div>
                  <ul class="finish-checklist-list">
                    <li class="d-flex align-items-start gap-2">
                      <input class="form-check-input checklist-checkbox mt-1 main-check" type="checkbox" id="c1" {% if assignment.user_status == 'submitted' %}disabled{% endif %}>
                      <label class="small finish-text-body" for="c1"><strong>Character</strong> I said who the story is about.</label>
                    </li>
                    <li class="d-flex align-items-start gap-2">
                      <input class="form-check-input checklist-checkbox mt-1 main-check" type="checkbox" id="c2" {% if assignment.user_status == 'submitted' %}disabled{% endif %}>
                      <label class="small finish-text-body" for="c2"><strong>Setting</strong> I said where/when it happens.</label>
                    </li>
                    <li class="d-flex align-items-start gap-2">
                      <input class="form-check-input checklist-checkbox mt-1 main-check" type="checkbox" id="c3" {% if assignment.user_status == 'submitted' %}disabled{% endif %}>
                      <label class="small finish-text-body" for="c3"><strong>Problem</strong> Something starts the problem.</label>
                    </li>
                    <li class="d-flex align-items-start gap-2">
                      <input class="form-check-input checklist-checkbox mt-1 main-check" type="checkbox" id="c4" {% if assignment.user_status == 'submitted' %}disabled{% endif %}>
                      <label class="small finish-text-body" for="c4"><strong>Actions</strong> The character tries to fix it.</label>
                    </li>
                    <li class="d-flex align-items-start gap-2">
                      <input class="form-check-input checklist-checkbox mt-1 main-check" type="checkbox" id="c5" {% if assignment.user_status == 'submitted' %}disabled{% endif %}>
                      <label class="small finish-text-body" for="c5"><strong>Resolution</strong> How the problem ends.</label>
                    </li>
                  </ul>
                  <div class="small text-muted mt-3 finish-text-body" style="color:#64748b!important;">
                    {% if part == 'beginning' %}Tip: Focus on Character + Setting.{% elif part == 'middle' %}Tip: Focus on Problem + Actions.{% else %}Tip: Focus on the Resolution.{% endif %}
                  </div>
                </div>
              </div>

              <div class="col-lg-5">
                <div class="idea-card h-100">
                  <div class="d-flex align-items-center justify-content-between mb-2">
                    <div class="idea-title">Need an idea?</div>
                    <button type="button" class="btn btn-sm btn-idea" id="getIdeaBtn" data-assignment-id="{{ assignment.id }}" {% if assignment.user_status == 'submitted' %}disabled{% endif %}>Get idea</button>
                  </div>
                  <div class="idea-one-line" id="ideaLine">Click to get one sentence idea.</div>
                  <div class="d-flex gap-2 mt-3">
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="insertIdeaBtn" disabled>Add to story</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="newIdeaBtn" disabled>New idea</button>
                  </div>
                </div>
              </div>
            </div>
          {% endif %}

          {# ---------- Story preview (The Fix is here) ---------- #}
          {% if assignment.assignment_type != 'writing' or (draft and draft.partial_text and draft.partial_text | length > 10) %}
            <h5 class="fw-semibold mb-3 finish-section-title">The Story So Far...</h5>
            <div class="border rounded-4 p-4 bg-story-preview finish-text-body mb-4 story-preview-box story-content-rendered">

              {% if draft and draft.partial_text and '###' in draft.partial_text %}
                {% set parts = draft.partial_text.split('###') %}
                {% for partx in parts %}
                  {% if loop.index > 1 %}
                    {% set split_content = partx.split('---', 1) %}
                    {% set section_name_full = split_content[0] | default('') | trim %}
                    {% set section_content = split_content[1] | default('') | replace('***', '') | trim %}
                    {% set section_name = section_name_full | replace('The', '') | trim %}

                    {% if section_name %}
                      <div class="story-section-header">
                        <span class="story-section-label">{{ section_name }}</span>
                      </div>
                      <hr class="story-section-underline">
                    {% endif %}

                    <div class="story-section-content">
                      {{ section_content | nl2br | safe }}
                    </div>

                    {# FIX: Removed "and not 'MISSING' in content_check" so spacer appears even after placeholders #}
                    {% if not loop.last %}
                      <hr class="story-section-divider">
                    {% endif %}

                  {% endif %}
                {% endfor %}
              {% elif draft and draft.partial_text %}
                <div class="story-section-content">
                  {{ draft.partial_text | nl2br | safe }}
                </div>
              {% endif %}

            </div>
          {% endif %}
          {# ---------- End story preview ---------- #}

          <form method="post" id="finishForm">
            <div class="mb-3">
              <label class="form-label fw-semibold finish-section-title">
                {% if assignment.assignment_type == 'writing' %}Write below{% else %}Write your ending below{% endif %}
              </label>
              <textarea name="completion_text" rows="8" class="form-control rounded-3 finish-textarea" id="completionText" placeholder="Write here..." {% if assignment.user_status == 'submitted' %}disabled{% endif %}>{{ submission.completion_text if submission else "" }}</textarea>
            </div>
            {% if assignment.user_status == 'submitted' %}
              <p class="small text-muted finish-text-body mt-3"><i class="bi bi-info-circle me-1"></i> Already submitted.</p>
            {% endif %}
            <div class="d-flex justify-content-between mt-4 pt-3 border-top-soft">
              <a href="{{ url_for('assignments_list') }}" class="btn btn-lg btn-outline-secondary finish-text-button rounded-pill">Back</a>
              <button type="submit" class="btn btn-lg btn-action-primary finish-text-button rounded-pill shadow-lg" {% if assignment.user_status == 'submitted' %}disabled{% endif %} id="submitButton">Submit <i class="bi bi-send-fill ms-1"></i></button>
            </div>
          </form>

        </div>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  function updateChecklist() {
    const checks = Array.from(document.querySelectorAll('.main-check'));
    if (!checks.length) return;
    const done = checks.filter(c => c.checked).length;
    const total = checks.length;
    const bar = document.getElementById('checkProgressBar');
    const lbl = document.getElementById('checkCountLabel');
    if (bar) bar.style.width = Math.round((done / total) * 100) + '%';
    if (lbl) lbl.textContent = done + ' / ' + total;
  }
  document.querySelectorAll('.main-check').forEach(c => c.addEventListener('change', updateChecklist));
  updateChecklist();

  const getBtn = document.getElementById('getIdeaBtn');
  const newBtn = document.getElementById('newIdeaBtn');
  const insertBtn = document.getElementById('insertIdeaBtn');
  const ideaLine = document.getElementById('ideaLine');
  const box = document.getElementById('completionText');
  let lastIdea = "";

  async function fetchIdea() {
    const aid = getBtn?.dataset?.assignmentId;
    if (!aid) return;
    ideaLine.textContent = "Thinking...";
    getBtn.disabled = true;
    try {
      const r = await fetch(`/assignments/${aid}/one_idea`, { method: "POST" });
      const data = await r.json();
      if (!data || !data.idea) throw new Error("No idea");
      lastIdea = data.idea;
      ideaLine.textContent = data.idea;
      insertBtn.disabled = false;
      newBtn.disabled = false;
    } catch (e) {
      ideaLine.textContent = "Try again.";
      insertBtn.disabled = true;
    } finally {
      getBtn.disabled = false;
    }
  }
  getBtn?.addEventListener("click", fetchIdea);
  newBtn?.addEventListener("click", fetchIdea);
  insertBtn?.addEventListener("click", () => {
    if (!lastIdea || !box) return;
    box.value += (box.value ? "\n" : "") + lastIdea;
  });
})();
</script>

<style>
:root{ --coral-main:#ff6b6b; --coral-light:#ffd7cc; --ink:#111827; --muted:#6b7280; --deep-blue:#0A3D62; }
.finish-main-title{font-family:'Baloo 2',cursive;font-weight:800;color:var(--coral-main);font-size:2.2rem;line-height:1.1;}
.finish-section-title{font-family:'Baloo 2',cursive;font-weight:700!important;color:var(--ink);font-size:1.4rem;}
.finish-sub-text,.finish-text-body,.finish-text-button{font-family:'Fredoka','Nunito',sans-serif;}
.finish-sub-text{font-size:1.15rem;color:var(--muted)!important;font-weight:500;}
.finish-text-body{font-weight:500;color:var(--muted)!important;}
.finish-text-button{font-weight:600!important;}
.text-deep-blue{color:var(--deep-blue)!important;}
.finish-card-v8{ border-radius:1.75rem; background:#fffcf8; box-shadow:0 1rem 3rem rgba(255,107,107,0.15); border:3px solid var(--coral-light)!important; }
.border-top-soft{border-top:1px solid rgba(255,107,107,0.2)!important;}
.story-reminder{ background:rgba(10,61,98,0.06); border:1px solid rgba(10,61,98,0.14); border-radius:1.25rem; padding:0.9rem 1rem; }
.reminder-title{ font-family:'Baloo 2',cursive; font-weight:800; color:var(--deep-blue); font-size:1.25rem; }
.reminder-text{color:#475569;}
.check-card{ background:#fffdf7; border-radius:1.25rem; border:2px dashed rgba(255,107,107,0.35); padding:1rem 1rem 1.1rem; box-shadow:0 6px 14px rgba(0,0,0,0.03); }
.check-title{ font-family:'Baloo 2',cursive; font-weight:800; color:var(--deep-blue); font-size:1.15rem; }
.finish-checklist-list{list-style:none;padding-left:0;margin-bottom:0;}
.finish-checklist-list li + li{margin-top:0.35rem;}
.checklist-checkbox{width:1rem;height:1rem;}
.check-progress{height:10px;border-radius:999px;background:rgba(10,61,98,0.08);overflow:hidden;}
.check-progress .progress-bar{background:var(--deep-blue);}
.idea-card{ background:#ffffff; border-radius:1.25rem; border:2px solid rgba(255,215,204,0.9); padding:1rem 1rem 1.1rem; box-shadow:0 10px 22px rgba(0,0,0,0.05); }
.idea-title{ font-family:'Baloo 2',cursive; font-weight:800; color:var(--deep-blue); font-size:1.15rem; }
.btn-idea{ background:rgba(10,61,98,0.10); border:1px solid rgba(10,61,98,0.18); color:var(--deep-blue); font-weight:800; border-radius:999px; padding:0.35rem 0.8rem; }
.btn-idea:hover{background:rgba(10,61,98,0.16);}
.idea-one-line{ margin-top:0.35rem; background:rgba(255,107,107,0.08); border:1px solid rgba(255,107,107,0.18); border-radius:1rem; padding:0.85rem 0.9rem; color:#0f172a; font-weight:700; line-height:1.4; min-height:64px; }
.story-preview-box{ font-size:1.1rem; line-height:1.6; background:#fefefe !important; border:2px solid rgba(135,206,250,0.2) !important; box-shadow:inset 0 2px 4px rgba(0,0,0,0.05); color:#475569; max-height:none !important; overflow:visible !important; }
.story-section-underline{ border:none; border-top:2px solid rgba(10,61,98,0.18); margin:0.35rem 0 0.85rem; }
.story-content-rendered .story-section-label{ font-family:'Baloo 2',cursive; font-size:1.25rem; color:var(--deep-blue); display:inline-block; }
.story-content-rendered .story-section-divider{ border:none; border-top:2px dashed #ccc; margin:1.6rem 0; }
.finish-textarea{ min-height:220px; padding:1rem; font-size:1.12rem; font-family:'Fredoka','Nunito',sans-serif; border:2px solid var(--coral-light); box-shadow:0 2px 5px rgba(0,0,0,0.05); transition:border-color 0.2s; }
.finish-textarea:focus{ border-color:var(--coral-main); box-shadow:0 0 0 .2rem rgba(255,107,107,.25); }
.finish-textarea[disabled]{background:#f7f7f7;cursor:not-allowed;}
</style>
{% endblock %}