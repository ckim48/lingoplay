{% extends "base2.html" %}
{% block title %}Story Review · EduWeaver Admin{% endblock %}

{% block content %}

<div class="admin-stories-wrap-v2 mt-3 mt-md-4">
  <div class="card admin-stories-card-v2 border-0 shadow-lg rounded-5 custom-card-glow">
    <div class="card-body p-3 p-md-4">
      <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3 mb-md-4">
        <div class="d-flex align-items-center gap-2">
          <div class="admin-pill-icon-v2">
            <i class="bi bi-stars"></i>
          </div>
          <div>
            <h4 class="mb-1 fw-bolder text-deep-blue">Generated Stories</h4>
            <p class="mb-0 text-muted small">
              Review AI stories, assign them to students, and manage Library sharing.
            </p>
          </div>
        </div>
        <div>
          <a href="{{ url_for('story_new') }}" class="btn btn-sm btn-action-primary rounded-pill shadow-sm">
            <i class="bi bi-plus-lg me-1"></i> New Story
          </a>
        </div>
      </div>

      {% if stories %}
      <div class="table-responsive admin-table-shell-v2 p-5">
        <table class="table align-middle mb-0 story-table-v2">
          <thead class="small text-muted">
            <tr>
              <th scope="col" class="table-th-padding">Title</th>
              <th scope="col" class="d-none d-md-table-cell table-th-padding">Prompt / Target words</th>
              <th scope="col" class="table-th-padding">Lang / Level</th>
              <th scope="col" class="d-none d-md-table-cell table-th-padding">Author</th>
              <th scope="col" class="table-th-padding">Created</th>
              <th scope="col" class="text-end table-th-padding">Actions / Status</th>
            </tr>
          </thead>
          <tbody>
          {% for s in stories %}
            {% set draft = draft_map.get(s.id) %}
            {% set can_finish = draft and not draft.completion_text %}
            {% set can_mcq = draft and draft.completion_text %}
            {% set assigned_cnt = (assign_map.get(s.id) if assign_map is defined else 0) or 0 %}
            {% set mcq_ready = s.mcq_questions_json is not none and (s.mcq_questions_json|string)|length > 2 %}
            <tr>
              <td onclick="window.location='{{ url_for('admin_story_detail', slug=s.slug) }}'" role="button" class="table-td-padding">
                <div class="fw-bold text-truncate text-deep-blue" title="{{ s.title }}">{{ s.title }}</div>
              </td>
              <td class="d-none d-md-table-cell table-td-padding" onclick="window.location='{{ url_for('admin_story_detail', slug=s.slug) }}'" role="button">
                <span class="text-secondary-light small">
                  {{ s.prompt[:64] }}{% if s.prompt|length > 64 %}…{% endif %}
                </span>
              </td>
              <td onclick="window.location='{{ url_for('admin_story_detail', slug=s.slug) }}'" role="button" class="table-td-padding">
                <div class="story-tag tag-lang">{{ s.language|upper }}</div>
                <div class="story-tag tag-level">{{ s.level }}</div>
              </td>
              <td class="d-none d-md-table-cell table-td-padding" onclick="window.location='{{ url_for('admin_story_detail', slug=s.slug) }}'" role="button">
                <span class="small text-secondary-light">{{ s.author_name }}</span>
              </td>
              <td onclick="window.location='{{ url_for('admin_story_detail', slug=s.slug) }}'" role="button" class="table-td-padding">
                <span class="small text-secondary-light">{{ s.created_at|dt("%Y-%m-%d %H:%M") }}</span>
              </td>

              <td class="text-end table-td-padding">
                <div class="d-flex flex-column align-items-end gap-2 mb-2">

                  {# MCQ generate button: only if story is fully completed and MCQs not yet ready #}
                  {% if can_mcq and not mcq_ready %}
                  <form method="post"
                        action="{{ url_for('admin_generate_mcq', slug=s.slug) }}"
                        class="mcq-gen-form">
                    <button type="submit"
                            class="btn btn-sm rounded-pill btn-action-secondary-outline btn-mcq-gen">
                      <i class="bi bi-question-circle me-1"></i>
                      Generate MCQ
                    </button>
                  </form>
                  {% endif %}

                  <button
                    type="button"
                    class="btn btn-sm rounded-pill btn-action-secondary-outline"
                    data-bs-toggle="modal"
                    data-bs-target="#assignModal"
                    data-story-title="{{ s.title }}"
                    data-assign-url="{{ url_for('admin_assign_story', slug=s.slug) }}"
                    data-can-finish="{{ 1 if can_finish else 0 }}"
                    data-can-mcq="{{ 1 if can_mcq else 0 }}"
                    data-mcq-ready="{{ 1 if mcq_ready else 0 }}"
                    {% if not draft %}disabled{% endif %}
                  >
                    <i class="bi bi-person-check me-1"></i>
                    Assign
                  </button>

                  {% if s.is_shared_library %}
                  <button
                    type="button"
                    class="btn btn-sm rounded-pill btn-action-danger-outline btn-share-library"
                    data-bs-toggle="modal"
                    data-bs-target="#shareModal"
                    data-story-title="{{ s.title }}"
                    data-share-url="{{ url_for('admin_unshare_story', slug=s.slug) }}"
                    data-share-mode="unshare"
                  >
                    <i class="bi bi-bookmark-dash me-1"></i>
                    Unshare
                  </button>
                  {% else %}
                  <button
                    type="button"
                    class="btn btn-sm rounded-pill btn-action-success-outline btn-share-library"
                    data-bs-toggle="modal"
                    data-bs-target="#shareModal"
                    data-story-title="{{ s.title }}"
                    data-share-url="{{ url_for('admin_share_story', slug=s.slug) }}"
                    data-share-mode="share"
                  >
                    <i class="bi bi-bookmark-plus me-1"></i>
                    Share
                  </button>
                  {% endif %}
                </div>

                <div class="small mt-1 d-flex flex-column align-items-end gap-1">
                  <span class="status-pill status-assigned-{{ 'yes' if assigned_cnt > 0 else 'no' }}">
                    {% if assigned_cnt > 0 %}
                      Assigned to {{ assigned_cnt }} student{% if assigned_cnt > 1 %}s{% endif %}
                    {% else %}
                      Not assigned
                    {% endif %}
                  </span>
                </div>
              </td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="py-4 text-center text-muted small">
        No stories yet. Try creating one from the <a href="{{ url_for('story_new') }}">AI Story Generator</a>.
      </div>
      {% endif %}
    </div>
  </div>
</div>

<div class="modal fade" id="assignModal" tabindex="-1" aria-labelledby="assignModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content rounded-5 modal-content-v2">
      <div class="modal-header border-0 pb-0">
        <h5 class="modal-title fw-semibold text-deep-blue" id="assignModalLabel">
          Assign Story
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <form id="assignForm" method="post">
        <div class="modal-body pt-2">

          <div class="mb-3">
            <label class="form-label small text-uppercase fw-bold text-secondary-light mb-1">
              Assignment Title
            </label>
            <input type="text"
                   class="form-control form-control-sm rounded-3"
                   name="assignment_title"
                   id="assignTitleInput"
                   placeholder="e.g. Week 2 · Reading Quiz">
            <div class="form-text small text-muted">
              Shown on the student's assignment page.
            </div>
          </div>

          <div class="mb-3 p-3 rounded-4 bg-light-soft-blue">
            <label class="form-label small text-uppercase fw-bold text-deep-blue mb-2">
              Assignment Type
            </label>
            <div class="d-flex flex-column gap-2">
              <div class="form-check">
                <input class="form-check-input" type="radio" name="assignment_type"
                       id="assignTypeFinish" value="finish">
                <label class="form-check-label fw-medium" for="assignTypeFinish">
                  Finish writing (students complete the ending)
                </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="assignment_type"
                       id="assignTypeMcq" value="mcq">
                <label class="form-check-label fw-medium" for="assignTypeMcq">
                  Reading comprehension MCQ (fully AI-completed story)
                </label>
              </div>
            </div>
            <div class="small text-warning-v2 mt-2" id="assignTypeHint"></div>
          </div>

          <div class="mb-2">
            <label class="form-label small text-uppercase fw-bold text-secondary-light mb-1">
              Select Students
            </label>

            {% if users %}
            <div class="border rounded-4 p-3 admin-student-list-v2">
              {% for u in users %}
              <div class="form-check small mb-1">
                <input class="form-check-input" type="checkbox"
                       name="user_ids" value="{{ u.id }}"
                       id="assign_user_{{ u.id }}">
                <label class="form-check-label fw-medium" for="assign_user_{{ u.id }}">
                  {{ u.username }}
                  <span class="text-secondary-light">· {{ u.email }}</span>
                </label>
              </div>
              {% endfor %}
            </div>
            <div class="form-text small text-muted mt-1">Assign this story to one or more students.</div>
            {% else %}
            <p class="small text-muted mb-0">No students found. Ask students to sign up first.</p>
            {% endif %}
          </div>
        </div>

        <div class="modal-footer border-0 d-flex justify-content-between pt-0">
          <button type="button" class="btn btn-outline-secondary rounded-pill" data-bs-dismiss="modal">
            Cancel
          </button>
          <button type="submit" class="btn btn-action-primary rounded-pill shadow-sm">
            <i class="bi bi-send me-1"></i> Assign Story
          </button>
        </div>
      </form>
    </div>
    <p class="small text-muted mt-2 mb-0 text-center">Story: <span class="fw-bold text-deep-blue" id="assignStoryTitle"></span></p>
  </div>
</div>

<div class="modal fade" id="shareModal" tabindex="-1" aria-labelledby="shareModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-5 modal-content-v2">
      <div class="modal-header border-0 pb-0">
        <h5 class="modal-title fw-semibold text-deep-blue" id="shareModalLabel">Share to Library</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="shareForm" method="post" class="share-gen-form">
        <div class="modal-body">
          <p class="small text-muted mb-2 pb-2">
            Story: <span class="fw-bold text-deep-blue" id="shareStoryTitle"></span>
          </p>
          <p class="small mb-0" id="shareBodyMain">
            This will add the story to the <span class="fw-bold text-success">Library</span> so students can read it anytime.
          </p>
          <p class="small text-muted mb-2" id="shareBodySub">
            If this story has **no cover image**, a simple book-style cover will be generated automatically.
            **This process may take a few seconds.**
          </p>
           <div class="d-flex align-items-center small text-secondary-light mt-2">
             <i class="bi bi-image me-1 text-deep-blue"></i>
             <span>All library stories must have a cover image.</span>
           </div>
        </div>
        <div class="modal-footer border-0 d-flex justify-content-between pt-0">
          <button type="button" class="btn btn-outline-secondary rounded-pill" data-bs-dismiss="modal">
            Cancel
          </button>
          <button type="submit" class="btn btn-success rounded-pill shadow-sm btn-share-submit" id="shareSubmitBtn">
            Share to Library
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

{# Loading overlay for MCQ generation #}
<div id="mcqLoadingOverlay"
     class="position-fixed top-0 start-0 w-100 h-100 d-none"
     style="background: rgba(15,23,42,0.65); z-index: 1055;">
  <div class="d-flex flex-column align-items-center justify-content-center h-100">
    <div class="spinner-grow text-white mb-3" role="status" style="width: 2.5rem; height: 2.5rem;">
      <span class="visually-hidden">Loading...</span>
    </div>
    <div class="text-white small fw-bold p-2 rounded-3" style="background: rgba(0,0,0,0.2);">
      <i class="bi bi-magic me-1"></i> Generating MCQ questions with AI…
    </div>
  </div>
</div>

{# Loading overlay for Image Generation/Share (NEW) #}
<div id="shareLoadingOverlay"
     class="position-fixed top-0 start-0 w-100 h-100 d-none"
     style="background: rgba(15,23,42,0.65); z-index: 1056;">
  <div class="d-flex flex-column align-items-center justify-content-center h-100">
    <div class="spinner-grow text-white mb-3" role="status" style="width: 2.5rem; height: 2.5rem;">
      <span class="visually-hidden">Loading...</span>
    </div>
    <div class="text-white small fw-bold p-2 rounded-3" style="background: rgba(0,0,0,0.2);">
      <i class="bi bi-book me-1"></i> Sharing to Library... Generating cover image if needed.
    </div>
  </div>
</div>

<style>
/* New Color Palette & Variables */
:root {
  --color-primary-light: #FFB347; /* Sunny Orange */
  --color-primary-dark: #FF8C00;  /* Deep Orange */
  --color-deep-blue: #0A3D62;    /* Dark Text/Headings */
  --color-secondary-light: #6C757D; /* Soft Gray */
  --color-success-v2: #4CAF50;
  --color-danger-v2: #F44336;
  --color-warning-v2: #FFC107;
  --color-light-blue: #E0F7FA; /* Light Blue background for table head/modal element */
  --color-soft-yellow: #FFFBEA; /* Soft Yellow hover */
  --table-padding-v2: 1.2rem; /* Consistent table cell padding */
}

/* Helper Classes */
.text-deep-blue { color: var(--color-deep-blue) !important; }
.text-secondary-light { color: var(--color-secondary-light) !important; }
.bg-light-soft-blue { background-color: var(--color-light-blue) !important; }
.text-warning-v2 { color: var(--color-warning-v2) !important; }
.border-dashed { border-style: dashed !important; }

/* Main Wrapper */
.admin-stories-wrap-v2 {
  max-width: 1300px;
  margin-inline: auto;
}

/* Card Shell */
.admin-stories-card-v2 {
  /* Soft, playful gradient background */
  background:
    radial-gradient(circle at 10% 10%, rgba(255, 179, 71, 0.1) 0, transparent 40%),
    radial-gradient(circle at 90% 90%, rgba(135, 206, 250, 0.1) 0, transparent 40%),
    #ffffff;
  overflow: hidden;
  position: relative;
  /* Lifted effect */
  box-shadow: 0 1rem 3rem rgba(0,0,0,0.08), 0 0 0 1px rgba(0,0,0,0.02);
}

/* Custom Card Glow */
.custom-card-glow::before {
  content: '';
  position: absolute;
  top: -2px;
  left: -2px;
  right: -2px;
  bottom: -2px;
  background: linear-gradient(45deg, var(--color-primary-light), #87CEFA);
  z-index: -1;
  filter: blur(8px);
  opacity: 0.3;
  border-radius: 1.5rem;
  transition: opacity 0.3s;
}

/* Header pill icon (v2) */
.admin-pill-icon-v2 {
  width: 48px;
  height: 48px;
  border-radius: 1rem;
  /* More vibrant gradient */
  background: linear-gradient(135deg, var(--color-primary-light), var(--color-primary-dark));
  display: inline-flex;
  align-items: center;
  justify-content: center;
  font-size: 1.5rem;
  color: #fff;
  /* Playful shadow */
  box-shadow: 0 0.5rem 1rem rgba(255, 140, 0, 0.35);
}

/* Action Primary Button (New Story / Assign) */
.btn-action-primary {
  background-color: var(--color-primary-dark);
  border-color: var(--color-primary-dark);
  color: #fff;
  font-weight: 600;
  padding: 0.4rem 1rem;
  transition: all 0.2s;
}
.btn-action-primary:hover {
  background-color: #ff9933;
  border-color: #ff9933;
  transform: translateY(-1px);
}

/* Table container (v2) */
.admin-table-shell-v2 {
  border-radius: 1.5rem;
  overflow: hidden;
  border: 1px solid rgba(135, 206, 250, 0.2); /* Soft blue border */
  background: #ffffff;
  box-shadow: 0 0.5rem 1.5rem rgba(0,0,0,0.04);
}

/* Table head (v2) */
.story-table-v2 thead {
  background: var(--color-light-blue); /* Light blue header */
}
.story-table-v2 thead th {
  border-bottom: 0;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  font-size: 0.65rem;
  color: var(--color-deep-blue);
  /* Use class for uniform padding */
}

/* Table padding helper classes */
.table-th-padding {
    padding-top: 1rem !important;
    padding-bottom: 1rem !important;
}

.table-td-padding {
    padding-top: var(--table-padding-v2) !important;
    padding-bottom: var(--table-padding-v2) !important;
}

/* Table body rows (v2) */
.story-table-v2 tbody tr td {
  border-top-color: rgba(0,0,0,0.08);
}
.story-table-v2 tbody tr {
  transition: background-color .15s ease, transform .15s ease;
}
.story-table-v2 tbody tr:hover {
  background-color: var(--color-soft-yellow); /* Soft yellow hover */
  transform: scale(1.005);
}

/* Status Pills (New) - ONLY ASSIGNED REMAINS */
.status-pill {
  display: inline-block;
  padding: 0.2rem 0.6rem;
  border-radius: 0.8rem;
  font-size: 0.65rem;
  font-weight: 700;
  letter-spacing: 0.03em;
  text-transform: uppercase;
  line-height: 1;
}

/* Assigned Status Colors */
.status-assigned-yes { background-color: #E0F2FE; color: #2563EB; } /* Blue */
.status-assigned-no { background-color: #F3F4F6; color: #6B7280; } /* Gray */


/* Action Button Outlines (New) */
.btn-action-secondary-outline {
  color: var(--color-deep-blue);
  border-color: #D9E3F1;
  background-color: #fff;
  transition: all 0.2s;
  font-weight: 500;
}
.btn-action-secondary-outline:hover {
  background-color: #F0F4F8;
  border-color: #c0cff0;
  color: var(--color-deep-blue);
}

.btn-action-success-outline {
  color: var(--color-success-v2);
  border-color: rgba(76, 175, 80, 0.5);
  background-color: #fff;
}
.btn-action-success-outline:hover {
  background-color: #E8F5E9;
  color: var(--color-success-v2);
}

.btn-action-danger-outline {
  color: var(--color-danger-v2);
  border-color: rgba(244, 67, 54, 0.5);
  background-color: #fff;
}
.btn-action-danger-outline:hover {
  background-color: #FFEBEE;
  color: var(--color-danger-v2);
}

/* Language/Level Tags */
.story-tag {
  display: inline-block;
  padding: 0.1rem 0.4rem;
  border-radius: 0.5rem;
  font-size: 0.65rem;
  font-weight: 600;
  margin-right: 0.25rem;
  margin-bottom: 0.25rem;
}
.tag-lang {
  background-color: #FAE5FF;
  color: #9333EA;
}
.tag-level {
  background-color: #E0F2FE;
  color: #2563EB;
}

/* Modal tweaks (v2) */
.modal-content-v2 {
  border: 0;
  border-radius: 1.5rem !important;
  box-shadow: 0 2rem 4rem rgba(0,0,0,0.2); /* Deep shadow for pop */
  background: #fff;
}
.admin-student-list-v2 {
  max-height: 200px;
  overflow-y: auto;
  background: #fcfcfc;
  border: 1px solid #eee;
  padding: 1rem !important;
}

/* Custom Checkbox/Radio for better child-like feel */
.form-check-input {
  border-radius: 0.35em; /* Slightly rounded squares */
  border-width: 2px;
}
.form-check-input:checked {
  background-color: var(--color-primary-dark);
  border-color: var(--color-primary-dark);
}
.form-check-input[type="radio"] {
  border-radius: 50%; /* Circles for radio buttons */
}

/* Small adjustments for inputs */
.form-control-sm {
  padding: 0.5rem 0.75rem;
}

/* Ensure the loading overlays are visually distinct and always on top */
#mcqLoadingOverlay { z-index: 1055; }
#shareLoadingOverlay { z-index: 1056; }
</style>

{% endblock %}

{% block scripts %}
<script>
(function(){
  // Assign modal logic
  const assignModal = document.getElementById('assignModal');
  const assignStoryTitleEl = document.getElementById('assignStoryTitle');
  const assignForm = document.getElementById('assignForm');
  const typeFinish = document.getElementById('assignTypeFinish');
  const typeMcq = document.getElementById('assignTypeMcq');
  const typeHint = document.getElementById('assignTypeHint');
  const assignTitleInput = document.getElementById('assignTitleInput');

  if (assignModal) {
    assignModal.addEventListener('show.bs.modal', function (event) {
      const button = event.relatedTarget;
      if (!button) return;

      const title = button.getAttribute('data-story-title') || '';
      const actionUrl = button.getAttribute('data-assign-url') || '';
      const canFinish = button.getAttribute('data-can-finish') === '1';
      const canMcq = button.getAttribute('data-can-mcq') === '1';
      const mcqReady = button.getAttribute('data-mcq-ready') === '1';

      assignStoryTitleEl.textContent = title;
      assignForm.action = actionUrl;

      // default assignment title
      if (assignTitleInput) {
        assignTitleInput.value = `Reading · ${title}`.trim();
      }

      // Reset checkboxes
      assignForm.querySelectorAll('input[name="user_ids"]').forEach(cb => {
        cb.checked = false;
      });

      // Enable/disable assignment types
      typeFinish.disabled = !canFinish;
      typeMcq.disabled = !canMcq || !mcqReady;

      // Reset selection and hint
      typeFinish.checked = false;
      typeMcq.checked = false;
      typeHint.textContent = '';

      // NOTE: Using innerHTML here allows for bolding text within the hint
      if (canFinish && (!canMcq || !mcqReady)) {
        typeFinish.checked = true;
        if (canMcq && !mcqReady) {
          typeHint.innerHTML =
            "This story is completed, but MCQ questions are not generated yet. Use the **Generate MCQ Questions** button first.";
        } else {
          typeHint.innerHTML =
            "This story has an unfinished draft, so you can only use the **finish-writing** assignment.";
        }
      } else if (!canFinish && canMcq && mcqReady) {
        typeMcq.checked = true;
        typeHint.innerHTML =
          "This story is fully completed with MCQ questions ready, so you can only use the **MCQ reading** assignment.";
      } else if (canFinish && canMcq && mcqReady) {
        typeFinish.checked = true;
        typeHint.innerHTML =
          "Choose whether students will finish the story or answer MCQ reading questions.";
      } else {
        typeHint.innerHTML =
          "This story is missing a usable draft; you may need to **regenerate** it.";
      }
    });
  }

  // Share / Unshare modal logic
  const shareModal = document.getElementById('shareModal');
  const shareStoryTitleEl = document.getElementById('shareStoryTitle');
  const shareForm = document.getElementById('shareForm');
  const shareModalLabel = document.getElementById('shareModalLabel');
  const shareBodyMain = document.getElementById('shareBodyMain');
  const shareBodySub = document.getElementById('shareBodySub');
  const shareSubmitBtn = document.getElementById('shareSubmitBtn');
  const shareLoadingOverlay = document.getElementById('shareLoadingOverlay'); // ADDED

  if (shareModal) {
    shareModal.addEventListener('show.bs.modal', function (event) {
      const button = event.relatedTarget;
      if (!button) return;

      const title = button.getAttribute('data-story-title') || '';
      const actionUrl = button.getAttribute('data-share-url') || '';
      const mode = button.getAttribute('data-share-mode') || 'share';

      shareStoryTitleEl.textContent = title;
      shareForm.action = actionUrl;

      if (mode === 'unshare') {
        shareModalLabel.textContent = 'Unshare from Library';
        shareBodyMain.innerHTML = 'This will <span class="fw-bold text-danger">remove</span> the story from the Library list for students.';
        shareBodySub.innerHTML = 'Assignments that already use this story will not be deleted.'; // Corrected: use innerHTML to remove bolding from previous context
        shareSubmitBtn.textContent = 'Unshare';
        // Use standard Bootstrap classes for color handling
        shareSubmitBtn.classList.remove('btn-success');
        shareSubmitBtn.classList.add('btn-danger');
      } else {
        shareModalLabel.textContent = 'Share to Library';
        shareBodyMain.innerHTML = 'This will add the story to the <span class="fw-bold text-success">Library</span> so students can read it anytime.';
        shareBodySub.innerHTML = 'If this story has <b>no cover image</b>, a simple book-style cover will be generated automatically. <b>This process may take a few seconds.</b>';
        shareSubmitBtn.textContent = 'Share to Library';
        // Use standard Bootstrap classes for color handling
        shareSubmitBtn.classList.remove('btn-danger');
        shareSubmitBtn.classList.add('btn-success');
      }
    });

    // Handle form submission for sharing/unsharing
    shareForm.addEventListener('submit', function (event) {
        // Only show loading for the 'share' action, not 'unshare'
        if (shareSubmitBtn.classList.contains('btn-success')) {
            shareSubmitBtn.disabled = true;
            if (shareLoadingOverlay) { // Ensure overlay exists
                shareLoadingOverlay.classList.remove('d-none');
            }
        }
        // Let the form submit normally
    });
  }

  // MCQ generation loading overlay
  const mcqLoadingOverlay = document.getElementById('mcqLoadingOverlay'); // RENAMED TO AVOID COLLISION
  const mcqButtons = document.querySelectorAll('.btn-mcq-gen');

  mcqButtons.forEach(btn => {
    btn.addEventListener('click', function () {
      // Prevent double-submission and show overlay
      btn.disabled = true;
      if (mcqLoadingOverlay) {
        mcqLoadingOverlay.classList.remove('d-none');
      }
      // Let the form submit normally; overlay will disappear on page reload
    });
  });
})();
</script>
{% endblock %}