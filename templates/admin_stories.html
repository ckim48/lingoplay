{% extends "base2.html" %}
{% block title %}Story Review · LexiTale{% endblock %}

{% block content %}
<link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;500;600&family=Baloo+2:wght@600;700;800&display=swap" rel="stylesheet">

{% set active_tab = request.args.get('tab') or active_tab or 'assign' %}
{% set fragment = request.args.get('fragment') or fragment or '' %}
{% set selected_class_id = request.args.get('class_id') or selected_class_id or '' %}

<div class="lexi-admin-wrapper mt-3 mt-md-5">
  <div class="container-fluid px-3 px-md-5">

    <div class="d-flex justify-content-between align-items-end flex-wrap gap-4 mb-5">
      <div class="d-flex align-items-center gap-3">
        <div class="lexi-icon-box">
          <i class="bi bi-stars"></i>
        </div>
        <div>
          <h1 class="lexi-page-title mb-1">Admin Dashboard</h1>
          <p class="lexi-text-muted mb-0">Assign worksheets, track progress, and grade submissions.</p>
        </div>
      </div>

      <div class="d-flex align-items-end gap-2 flex-wrap">
        <form method="get" action="{{ url_for('admin_stories') }}" class="d-flex flex-column">
          <label class="lexi-label-micro mb-1">Current Class</label>
          <div class="position-relative">
            <select name="class_id" class="lexi-select-pill pe-5" onchange="this.form.submit()">
              <option value="">All Classes</option>
              {% for c in classes or [] %}
                <option value="{{ c.id }}" {% if selected_class_id and (selected_class_id|string) == (c.id|string) %}selected{% endif %}>
                  {{ c.name }}
                </option>
              {% endfor %}
            </select>
            <i class="bi bi-chevron-down position-absolute top-50 end-0 translate-middle-y me-3 text-muted" style="pointer-events: none;"></i>
          </div>
          <input type="hidden" name="tab" value="{{ active_tab }}">
          {% if fragment %}<input type="hidden" name="fragment" value="{{ fragment }}">{% endif %}
        </form>

        <button type="button" class="btn lexi-btn-secondary" data-bs-toggle="modal" data-bs-target="#createClassModal">
          <i class="bi bi-plus-lg me-1"></i> New Class
        </button>

        <a href="/classes" class="btn lexi-btn-primary">
          <i class="bi bi-gear-fill me-1"></i> Manage
        </a>
      </div>
    </div>

    {% if selected_class and (selected_class.join_code or selected_class.code) %}
      {% set join_code = selected_class.join_code or selected_class.code %}
      <div class="lexi-card mb-4 p-4 border-start border-4 border-coral">
        <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
          <div>
            <h6 class="lexi-heading-sm mb-1">Join Code: <span class="text-coral">{{ selected_class.name }}</span></h6>
            <p class="lexi-text-muted mb-0">Share this code with your students to enroll them.</p>
          </div>
          <div class="d-flex align-items-center gap-2 bg-light rounded-pill p-1 pe-3">
            <div class="bg-white rounded-pill px-3 py-2 fw-bold font-monospace shadow-sm text-dark">
              {{ join_code }}
            </div>
            <button type="button" class="btn btn-sm btn-link text-decoration-none text-coral fw-bold"
                    id="copyJoinCodeBtn" data-copy-text="{{ join_code }}">
              <i class="bi bi-clipboard me-1"></i> Copy
            </button>
          </div>
        </div>
      </div>
    {% endif %}

    <ul class="nav nav-pills lexi-nav-pills mb-4 gap-2" role="tablist">
      <li class="nav-item">
        <a class="nav-link {% if active_tab == 'assign' %}active{% endif %}"
           href="{{ url_for('admin_stories', tab='assign', class_id=selected_class_id or None) }}">
          <i class="bi bi-magic me-2"></i>Create & Assign
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link {% if active_tab == 'assigned' %}active{% endif %}"
           href="{{ url_for('admin_stories', tab='assigned', class_id=selected_class_id or None) }}">
           <i class="bi bi-list-check me-2"></i>Active Worksheets
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link {% if active_tab == 'submitted' %}active{% endif %}"
           href="{{ url_for('admin_stories', tab='submitted', class_id=selected_class_id or None) }}">
           <i class="bi bi-inbox-fill me-2"></i>Submissions
        </a>
      </li>
    </ul>

    <div class="tab-content">

      <div class="tab-pane fade {% if active_tab == 'assign' %}show active{% endif %}">
        <div class="lexi-card p-4 p-md-5">

          <div class="text-center mb-5">
            <h2 class="lexi-section-title">Worksheet Wizard</h2>
            <p class="lexi-text-muted">Generate AI-powered content and assign it to your class in 3 steps.</p>

            {% if not selected_class_id %}
              <div class="d-inline-block bg-warning-subtle text-warning-emphasis px-4 py-2 rounded-pill mt-2 fw-medium">
                <i class="bi bi-exclamation-circle me-1"></i> Please select a class above to start.
              </div>
            {% endif %}
          </div>

          <div class="lexi-stepper mb-5">
            <div class="step active" data-step-indicator="1">
              <div class="circle">1</div>
              <div class="label">Details</div>
            </div>
            <div class="line"></div>
            <div class="step" data-step-indicator="2">
              <div class="circle">2</div>
              <div class="label">Type</div>
            </div>
            <div class="line"></div>
            <div class="step" data-step-indicator="3">
              <div class="circle">3</div>
              <div class="label">Students</div>
            </div>
          </div>

          <form id="worksheetForm" method="post" action="{{ url_for('admin_generate_worksheet') }}">
            <input type="hidden" name="class_id" value="{{ selected_class_id }}">
            <input type="hidden" name="include_story_grammar" value="1">

            <div class="worksheet-step active" data-step="1">
              <div class="row justify-content-center">
                <div class="col-md-8">
                  <div class="mb-4">
                    <label class="lexi-label mb-2">Worksheet Title</label>
                    <input type="text" name="worksheet_title" id="worksheetTitleInput"
                           class="form-control lexi-input"
                           placeholder="e.g. Space Adventure: Week 1" required
                           {% if not selected_class_id %}disabled{% endif %}>
                  </div>
                  <div class="mb-4">
                    <label class="lexi-label mb-2">Deadline (optional)</label>
                    <input type="datetime-local" name="due_at" id="dueAtInput"
                           class="form-control lexi-input"
                           {% if not selected_class_id %}disabled{% endif %}>
                    <div class="form-text text-muted">Students can still submit after the deadline, but you can show it as “late”.</div>
                  </div>
                  <div class="d-flex justify-content-end">
                    <button type="button" class="btn lexi-btn-primary btn-step-next" data-next-step="2" {% if not selected_class_id %}disabled{% endif %}>
                      Next Step <i class="bi bi-arrow-right ms-2"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <div class="worksheet-step" data-step="2">
              <div class="row justify-content-center">
                <div class="col-lg-9">

                  <label class="lexi-label mb-3 text-center d-block">Choose Worksheet Mode</label>

                  <div class="row g-3 mb-4">
                    <div class="col-md-6">
                      <label class="lexi-radio-card">
                        <input type="radio" name="worksheet_type" value="writing" required {% if not selected_class_id %}disabled{% endif %}>
                        <div class="card-content">
                          <div class="icon"><i class="bi bi-pencil-fill"></i></div>
                          <div class="text">
                            <h6>Writing & Creation</h6>
                            <p>Story grammar focus: Character, Setting, Problem & Resolution.</p>
                          </div>
                          <div class="check"><i class="bi bi-check-circle-fill"></i></div>
                        </div>
                      </label>
                    </div>
                    <div class="col-md-6">
                      <label class="lexi-radio-card">
                        <input type="radio" name="worksheet_type" value="reading" {% if not selected_class_id %}disabled{% endif %}>
                        <div class="card-content">
                          <div class="icon"><i class="bi bi-book-half"></i></div>
                          <div class="text">
                            <h6>Reading Comprehension</h6>
                            <p>AI generates a story + comprehension questions automatically.</p>
                          </div>
                          <div class="check"><i class="bi bi-check-circle-fill"></i></div>
                        </div>
                      </label>
                    </div>
                  </div>

                  <div id="step2-writing" class="d-none lexi-sub-settings fade-in">
                    <div class="row g-3">
                      <div class="col-md-6">
                        <label class="lexi-label-micro">Target Level</label>
                        <select name="writing_level" id="writingLevelSelect" class="form-select lexi-select">
                          <option value="level_1">Level 1: Beginner (50-80 words)</option>
                          <option value="level_2" selected>Level 2: Intermediate (100-150 words)</option>
                          <option value="level_3">Level 3: Advanced (180-250 words)</option>
                        </select>
                        <div class="form-text text-muted small mt-1">
                          <strong>L1:</strong> SVO sentences. <strong>L2:</strong> Compound sentences. <strong>L3:</strong> Paragraphs.
                        </div>
                      </div>
                      <div class="col-md-6">
                        <label class="lexi-label-micro">Task Type</label>
                        <select name="writing_mode" id="writingModeSelect" class="form-select lexi-select">
                           <option value="completion" selected>Story Completion (Finish the story)</option>
                           <option value="planning">Free Writing (Planning)</option>
                        </select>
                      </div>
                    </div>
                  </div>

                  <div id="step2-reading" class="d-none lexi-sub-settings fade-in">
                    <div class="mb-3">
                      <label class="lexi-label-micro text-coral">Topic / Theme (Required)</label>
                      <input type="text" name="reading_topic" id="readingTopicInput"
                             class="form-control lexi-input"
                             placeholder="e.g. Robots playing soccer, A lost puppy, Life on Mars">
                    </div>
                    <div class="row g-3">
                      <div class="col-md-4">
                        <label class="lexi-label-micro">Difficulty</label>
                        <select name="worksheet_level" id="readingLevelSelect" class="form-select lexi-select">
                          <option value="level_1">Level 1: Beginner</option>
                          <option value="level_2" selected>Level 2: Intermediate</option>
                          <option value="level_3">Level 3: Advanced</option>
                        </select>
                      </div>
                      <div class="col-md-4">
                        <label class="lexi-label-micro">Length</label>
                        <select name="reading_length" id="readingLengthSelect" class="form-select lexi-select">
                          <option value="short" selected>Short</option>
                          <option value="medium">Medium</option>
                          <option value="long">Long</option>
                        </select>
                      </div>
                      <div class="col-md-4">
                        <label class="lexi-label-micro">Genre</label>
                        <select name="reading_genre" id="readingGenreSelect" class="form-select lexi-select">
                          <option value="" selected>Auto-detect</option>
                          <option value="adventure">Adventure</option>
                          <option value="fantasy">Fantasy</option>
                          <option value="science">Sci-Fi</option>
                          <option value="realistic">Realistic</option>
                        </select>
                      </div>
                    </div>
                  </div>

                  <div class="d-flex justify-content-between mt-5">
                    <button type="button" class="btn lexi-btn-secondary btn-step-prev" data-prev-step="1">Back</button>
                    <button type="button" class="btn lexi-btn-primary btn-step-next" data-next-step="3">
                      Select Students <i class="bi bi-arrow-right ms-2"></i>
                    </button>
                  </div>

                </div>
              </div>
            </div>

            <div class="worksheet-step" data-step="3">
              <div class="row justify-content-center">
                <div class="col-md-8">
                  <label class="lexi-label mb-3">Assign to...</label>

                  <div class="lexi-student-list mb-4">
                    {% if users %}
                      <div class="list-group list-group-flush rounded-3">
                        {% for u in users %}
                        <label class="list-group-item d-flex gap-3 align-items-center p-3 cursor-pointer">
                          <input class="form-check-input flex-shrink-0 lexi-checkbox" type="checkbox" name="user_ids" value="{{ u.id }}" checked>
                          <span class="pt-1 form-checked-content">
                            <strong>{{ u.username }}</strong>
                            <span class="d-block text-muted small">{{ u.email }}</span>
                          </span>
                        </label>
                        {% endfor %}
                      </div>
                    {% else %}
                      <div class="text-center p-4 text-muted border rounded-3 bg-light">
                        No students found in this class.
                      </div>
                    {% endif %}
                  </div>

                  <div class="d-flex justify-content-between">
                    <button type="button" class="btn lexi-btn-secondary btn-step-prev" data-prev-step="2">Back</button>
                    <button type="submit" id="worksheetSubmitBtn" class="btn lexi-btn-primary w-50">
                      <i class="bi bi-stars me-2"></i> Generate & Assign
                    </button>
                  </div>
                </div>
              </div>
            </div>

          </form>
        </div>
      </div>

      <div class="tab-pane fade {% if active_tab == 'assigned' %}show active{% endif %}">
        <h2 class="lexi-section-title mb-4">Active Worksheets</h2>

        {% if assignments %}
          <div class="lexi-table-container">
            <table class="table lexi-table">
              <thead>
                <tr>
                  <th>Worksheet</th>
                  <th>Info</th>
                  <th class="d-none d-md-table-cell">Assigned To</th>
                  <th class="d-none d-md-table-cell">Progress</th>
                  <th class="text-end">Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for g in assignments %}
                <tr>
                  <td>
                    <div class="d-flex flex-column">
                      <a href="{{ url_for('admin_assignment_group_detail', assignment_id=g.primary_assignment_id) }}" class="fw-bold text-dark text-decoration-none fs-5">
                        {{ g.assignment_title or 'Untitled Worksheet' }}
                      </a>
                      <span class="badge rounded-pill bg-light text-dark border mt-2 w-auto align-self-start">
                        {% if g.assignment_type in ['writing', 'finish'] %}Writing{% else %}Reading{% endif %}
                      </span>
                    </div>
                  </td>
                  <td>
                    <div class="small text-muted">
                      {% if g.story_title %}
                        <i class="bi bi-book me-1"></i> {{ g.story_title }}<br>
                      {% endif %}
                      <i class="bi bi-calendar me-1"></i> {{ g.created_at|dt("%b %d") }}
                      {% if g.due_at %}<br><i class="bi bi-alarm me-1"></i> Due {{ g.due_at|dt("%b %d, %H:%M") }}{% endif %}
                    </div>
                  </td>
                  <td class="d-none d-md-table-cell">
                    <div class="d-flex align-items-center">
                      <div class="avatar-stack">
                        {% for stu in g.assignees[:4] %}
                          <span class="avatar-circle" title="{{ stu.username }}">{{ stu.username[0]|upper }}</span>
                        {% endfor %}
                        {% if g.assignees|length > 4 %}
                          <span class="avatar-circle more">+{{ g.assignees|length - 4 }}</span>
                        {% endif %}
                      </div>
                    </div>
                  </td>
                  <td class="d-none d-md-table-cell align-middle">
                     <div class="d-flex gap-3 small fw-medium">
                       <span class="text-muted">{{ g.count_assigned }} Assigned</span>
                       <span class="text-success">{{ g.count_submitted }} Done</span>
                     </div>
                     <div class="progress mt-1" style="height: 6px; width: 120px;">
                       {% set total = g.count_assigned + g.count_submitted + g.count_graded %}
                       {% set pct = 0 %}
                       {% if total > 0 %}{% set pct = ((g.count_submitted + g.count_graded) / total * 100) %}{% endif %}
                       <div class="progress-bar bg-success" style="width: {{ pct }}%"></div>
                     </div>
                  </td>
                  <td class="text-end">
                    <button class="btn btn-sm lexi-btn-secondary" data-bs-toggle="modal" data-bs-target="#editAssignmentGroupModal-{{ g.group_id }}">
                      <i class="bi bi-pencil"></i>
                    </button>
                  </td>
                </tr>

                <div class="modal fade" id="editAssignmentGroupModal-{{ g.group_id }}" tabindex="-1" aria-hidden="true">
                  <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content border-0 shadow rounded-4">
                      <div class="modal-header border-0 pb-0">
                        <h5 class="modal-title fw-bold font-heading">Edit Worksheet</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                      </div>
                      <form method="POST" action="{{ url_for('admin_edit_worksheet_assignment', assignment_id=g.primary_assignment_id) }}">
                        <div class="modal-body">
                          <div class="mb-3">
                            <label class="lexi-label-micro">Title</label>
                            <input type="text" name="worksheet_title" class="form-control lexi-input" value="{{ g.assignment_title }}" required>
                          </div>
                          <div class="mb-3">
                            <label class="lexi-label-micro">Deadline (optional)</label>
                            <input type="datetime-local" name="due_at" class="form-control lexi-input"
                                   value="{% if g.due_at %}{{ g.due_at[:16].replace(" ","T") }}{% endif %}">
                            <div class="form-text text-muted">Leave empty to clear the deadline.</div>
                          </div>
                          <div class="alert alert-light border small text-muted">
                            <i class="bi bi-info-circle me-1"></i> Currently assigned to {{ g.assignees|length }} students.
                          </div>
                        </div>
                        <div class="modal-footer border-0 pt-0">
                           <button type="submit" name="action" value="delete" class="btn btn-outline-danger btn-sm rounded-pill px-3 me-auto">
                             Unassign All
                           </button>
                           <button type="button" class="btn lexi-btn-secondary" data-bs-dismiss="modal">Close</button>
                           <button type="submit" name="action" value="save" class="btn lexi-btn-primary">Save</button>
                        </div>
                      </form>
                    </div>
                  </div>
                </div>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="text-center py-5">
            <img src="https://cdn-icons-png.flaticon.com/512/7486/7486744.png" width="80" class="mb-3 opacity-50" alt="Empty">
            <p class="text-muted fw-medium">No worksheets assigned yet.</p>
          </div>
        {% endif %}
      </div>

      <div class="tab-pane fade {% if active_tab == 'submitted' %}show active{% endif %}">
        <h2 class="lexi-section-title mb-4">Review Submissions</h2>

        {% if submissions_to_review %}
          <div class="row g-3">
            {% for sub in submissions_to_review %}
            <div class="col-12">
              <div class="lexi-card p-3 d-flex flex-column flex-md-row align-items-center justify-content-between gap-3 hover-lift">
                <div class="d-flex align-items-center gap-3 w-100">
                  <div class="bg-light rounded-circle d-flex align-items-center justify-content-center text-primary fw-bold" style="width:48px; height:48px; font-family:'Baloo 2'; font-size:1.2rem;">
                    {{ sub.assignee_username[0]|upper }}
                  </div>
                  <div>
                    <h6 class="mb-1 fw-bold text-dark">{{ sub.assignee_username }}</h6>
                    <p class="mb-0 text-muted small">
                      <span class="text-coral fw-bold">{{ sub.story_title }}</span> &bull; {{ sub.assignment_title }}
                    </p>
                  </div>
                </div>

                <div class="d-flex align-items-center gap-3 flex-shrink-0">
                   {% if sub.current_score is not none %}
                     <span class="badge bg-success-subtle text-success border border-success-subtle px-3 py-2 rounded-pill">
                       {{ sub.current_score|int }}% Score
                     </span>
                   {% endif %}

                   <span class="badge rounded-pill px-3 py-2 text-dark" style="background: {{ sub.review_status_color }}">
                     {{ sub.review_status_label }}
                   </span>

                   <a href="{{ url_for('admin_grading_page', submission_id=sub.submission_id) }}" class="btn lexi-btn-primary btn-sm px-4">
                     Review
                   </a>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="text-center py-5">
             <i class="bi bi-check-circle-fill text-success display-4 mb-3"></i>
             <h5 class="fw-bold">All caught up!</h5>
             <p class="text-muted">No pending submissions to review.</p>
          </div>
        {% endif %}
      </div>

    </div>
  </div>
</div>

<div id="worksheetLoadingOverlay" class="position-fixed top-0 start-0 w-100 h-100 d-none justify-content-center align-items-center flex-column"
     style="background: rgba(255,255,255,0.9); z-index: 9999; backdrop-filter: blur(5px);">
  <div class="spinner-border text-coral mb-3" role="status" style="width: 3rem; height: 3rem;"></div>
  <h5 class="fw-bold font-heading text-dark">Dreaming up</h5>
  <p class="text-muted small">This usually takes about 10-15 seconds.</p>
</div>

<div class="modal fade" id="createClassModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow rounded-4">
      <div class="modal-header border-0">
        <h5 class="modal-title fw-bold font-heading">New Class</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form method="POST" action="{{ url_for('admin_create_class') }}">
        <div class="modal-body">
          <label class="lexi-label-micro">Class Name</label>
          <input type="text" name="class_name" class="form-control lexi-input" placeholder="e.g. 5th Grade English" required>
        </div>
        <div class="modal-footer border-0 pt-0">
          <button type="button" class="btn lexi-btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn lexi-btn-primary">Create</button>
        </div>
      </form>
    </div>
  </div>
</div>

<style>
/* --- LEXI MODERN THEME VARIABLES --- */
:root {
  --lexi-primary: #ff6b6b;
  --lexi-primary-dark: #e05555;
  --lexi-primary-soft: #ffe5e5;
  --lexi-text-dark: #2c3e50;
  --lexi-text-muted: #7f8c8d;
  --lexi-bg: #f8f9fa;
  --lexi-card-shadow: 0 10px 30px rgba(0,0,0,0.05);
  --lexi-radius: 16px;
  --font-heading: 'Baloo 2', cursive;
  --font-body: 'Fredoka', sans-serif;
}

body { font-family: var(--font-body); background-color: #fffaf9; color: var(--lexi-text-dark); }
.text-coral { color: var(--lexi-primary) !important; }
.border-coral { border-color: var(--lexi-primary) !important; }
.font-heading { font-family: var(--font-heading); }

/* --- TYPOGRAPHY --- */
.lexi-page-title { font-family: var(--font-heading); font-weight: 800; color: var(--lexi-text-dark); font-size: 2.5rem; }
.lexi-section-title { font-family: var(--font-heading); font-weight: 700; color: var(--lexi-text-dark); }
.lexi-heading-sm { font-family: var(--font-heading); font-weight: 700; font-size: 1.1rem; }
.lexi-text-muted { color: var(--lexi-text-muted); font-size: 0.95rem; }
.lexi-label { font-weight: 600; color: var(--lexi-text-dark); display: block; }
.lexi-label-micro { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 700; color: #95a5a6; display: block; margin-bottom: 4px; }

/* --- ICON BOX --- */
.lexi-icon-box {
  width: 60px; height: 60px;
  background: linear-gradient(135deg, var(--lexi-primary), var(--lexi-primary-dark));
  color: white; border-radius: 18px;
  display: flex; align-items: center; justify-content: center;
  font-size: 1.8rem;
  box-shadow: 0 8px 16px rgba(255, 107, 107, 0.3);
}

/* --- BUTTONS --- */
.btn { font-family: var(--font-body); font-weight: 600; border-radius: 50px; padding: 0.6rem 1.4rem; transition: all 0.2s ease; }
.lexi-btn-primary {
  background-color: var(--lexi-primary); border: none; color: white;
  box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3);
}
.lexi-btn-primary:hover, .lexi-btn-primary:active {
  background-color: var(--lexi-primary-dark); color: white; transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(255, 107, 107, 0.4);
}
.lexi-btn-primary:disabled { background-color: #fab1b1; transform: none; box-shadow: none; }

.lexi-btn-secondary {
  background-color: white; border: 2px solid #eee; color: var(--lexi-text-dark);
}
.lexi-btn-secondary:hover {
  border-color: var(--lexi-primary); color: var(--lexi-primary); background-color: var(--lexi-primary-soft);
}

/* --- INPUTS --- */
.lexi-input, .lexi-select {
  background-color: #f4f6f8; border: 2px solid transparent; border-radius: 12px;
  padding: 0.7rem 1rem; font-weight: 500; color: var(--lexi-text-dark);
}
.lexi-input:focus, .lexi-select:focus {
  background-color: #fff; border-color: var(--lexi-primary); box-shadow: 0 0 0 4px var(--lexi-primary-soft);
}
.lexi-select-pill {
  appearance: none; background-color: white; border: 2px solid #eee;
  border-radius: 50px; padding: 0.5rem 1.2rem; font-weight: 600;
  color: var(--lexi-text-dark); cursor: pointer; min-width: 200px;
}
.lexi-select-pill:hover { border-color: var(--lexi-primary); }

/* --- CARDS & LAYOUT --- */
.lexi-card {
  background: white; border-radius: var(--lexi-radius);
  box-shadow: var(--lexi-card-shadow); border: 1px solid rgba(0,0,0,0.02);
}
.hover-lift { transition: transform 0.2s; }
.hover-lift:hover { transform: translateY(-3px); }

/* --- NAV TABS --- */
.lexi-nav-pills .nav-link {
  color: var(--lexi-text-muted); font-weight: 600; border-radius: 12px; padding: 0.7rem 1.2rem;
}
.lexi-nav-pills .nav-link.active {
  background-color: var(--lexi-primary-soft); color: var(--lexi-primary-dark);
}
.lexi-nav-pills .nav-link:hover:not(.active) { background-color: #fff; color: var(--lexi-primary); }

/* --- STEPPER --- */
.lexi-stepper { display: flex; align-items: center; justify-content: center; gap: 1rem; }
.lexi-stepper .step { display: flex; flex-direction: column; align-items: center; opacity: 0.5; transition: 0.3s; }
.lexi-stepper .step.active { opacity: 1; transform: scale(1.1); }
.lexi-stepper .circle {
  width: 36px; height: 36px; border-radius: 50%; background: #eee; color: #999;
  display: flex; align-items: center; justify-content: center; font-weight: 800; font-family: var(--font-heading); margin-bottom: 5px;
}
.lexi-stepper .step.active .circle { background: var(--lexi-primary); color: white; box-shadow: 0 4px 10px rgba(255,107,107,0.4); }
.lexi-stepper .label { font-size: 0.75rem; font-weight: 700; text-transform: uppercase; }
.lexi-stepper .line { width: 50px; height: 3px; background: #eee; border-radius: 2px; }

/* WIZARD STEP VISIBILITY */
.worksheet-step {
  display: none;
  animation: fadeIn 0.4s ease forwards;
}
.worksheet-step.active {
  display: block;
}


/* --- RADIO CARDS (THE BIG UPGRADE) --- */
.lexi-radio-card { display: block; cursor: pointer; position: relative; }
.lexi-radio-card input { position: absolute; opacity: 0; }
.lexi-radio-card .card-content {
  background: white; border: 2px solid #f0f0f0; border-radius: 16px; padding: 1.5rem;
  display: flex; gap: 1rem; align-items: flex-start; transition: all 0.2s;
}
.lexi-radio-card .icon {
  width: 44px; height: 44px; background: #fff5f5; color: var(--lexi-primary);
  border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; flex-shrink: 0;
}
.lexi-radio-card h6 { font-family: var(--font-heading); font-weight: 700; margin-bottom: 4px; color: var(--lexi-text-dark); }
.lexi-radio-card p { font-size: 0.85rem; color: #7f8c8d; margin: 0; line-height: 1.4; }
.lexi-radio-card .check {
  position: absolute; top: 10px; right: 10px; color: var(--lexi-primary); opacity: 0; transform: scale(0.5); transition: all 0.2s;
}
/* Selected State */
.lexi-radio-card input:checked + .card-content {
  border-color: var(--lexi-primary); background-color: #fffafa; box-shadow: 0 8px 20px rgba(255, 107, 107, 0.15);
}
.lexi-radio-card input:checked + .card-content .check { opacity: 1; transform: scale(1); }

/* --- STUDENT LIST --- */
.lexi-student-list { max-height: 250px; overflow-y: auto; border: 1px solid #eee; border-radius: 12px; }
.lexi-checkbox { width: 1.2em; height: 1.2em; border-radius: 6px; border: 2px solid #ddd; }
.lexi-checkbox:checked { background-color: var(--lexi-primary); border-color: var(--lexi-primary); }

/* --- TABLES --- */
.lexi-table-container { background: transparent; }
.lexi-table { border-collapse: separate; border-spacing: 0 10px; }
.lexi-table thead th {
  border: none; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: #95a5a6; padding: 0 1.5rem;
}
.lexi-table tbody tr {
  background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.02); transition: transform 0.2s;
}
.lexi-table tbody tr:hover { transform: scale(1.005); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
.lexi-table td { border: none; padding: 1.25rem 1.5rem; vertical-align: middle; }
.lexi-table td:first-child { border-top-left-radius: 12px; border-bottom-left-radius: 12px; }
.lexi-table td:last-child { border-top-right-radius: 12px; border-bottom-right-radius: 12px; }

/* Avatars */
.avatar-stack { display: flex; }
.avatar-circle {
  width: 32px; height: 32px; border-radius: 50%; background: #eee; border: 2px solid white;
  display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 700; color: #555; margin-left: -8px;
}
.avatar-circle:first-child { margin-left: 0; }
.avatar-circle.more { background: #333; color: white; }

/* Animation Utils */
.fade-in { animation: fadeIn 0.4s ease forwards; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

</style>

<script>
document.addEventListener('DOMContentLoaded', function() {

  // --- STATE MANAGEMENT ---
  const typeRadios = document.querySelectorAll('input[name="worksheet_type"]');
  const step2Writing = document.getElementById('step2-writing');
  const step2Reading = document.getElementById('step2-reading');
  const submitBtn = document.getElementById('worksheetSubmitBtn');
  const loader = document.getElementById('worksheetLoadingOverlay');

  // Reading Autocomplete Elements
  const readingInputs = ['readingTopicInput', 'readingGenreSelect', 'readingLevelSelect'];
  const titleInput = document.getElementById('worksheetTitleInput');

  // --- 1. TOGGLE WORKSHEET MODE (Reading vs Writing) ---
  function updateMode() {
    const selected = document.querySelector('input[name="worksheet_type"]:checked')?.value;

    if(selected === 'writing') {
       if(step2Writing) step2Writing.classList.remove('d-none');
       if(step2Reading) step2Reading.classList.add('d-none');
    } else if (selected === 'reading') {
       if(step2Writing) step2Writing.classList.add('d-none');
       if(step2Reading) step2Reading.classList.remove('d-none');
       updateReadingTitle(); // Trigger title update
    }
  }

  // Bind Listeners
  typeRadios.forEach(r => r.addEventListener('change', updateMode));

  // --- 2. AUTO-GENERATE TITLE FOR READING ---
  function updateReadingTitle() {
    const type = document.querySelector('input[name="worksheet_type"]:checked')?.value;
    if(type !== 'reading') return;

    const topic = document.getElementById('readingTopicInput').value;
    const genre = document.getElementById('readingGenreSelect').value;

    // Only update if title is empty, or if it looks like a generic auto-generated title
    const currentTitle = titleInput.value;
    if(!currentTitle || currentTitle.startsWith('Reading')) {
       let newTitle = "Reading Task";
       if(topic) newTitle = `Reading: ${topic.charAt(0).toUpperCase() + topic.slice(1)}`;
       else if(genre) newTitle = `Reading: ${genre.charAt(0).toUpperCase() + genre.slice(1)} Story`;

       titleInput.value = newTitle;
    }
  }

  readingInputs.forEach(id => {
    const el = document.getElementById(id);
    if(el) el.addEventListener('input', updateReadingTitle);
  });

  // --- 3. STEPPER WIZARD LOGIC ---
  const allSteps = document.querySelectorAll('.worksheet-step');
  const indicators = document.querySelectorAll('.lexi-stepper .step');

  function setStep(stepNum) {
    // 1. Manage Step Content visibility
    allSteps.forEach(s => {
       const sNum = parseInt(s.getAttribute('data-step'));
       if(sNum === stepNum) {
         s.classList.add('active');
       } else {
         s.classList.remove('active');
       }
    });

    // 2. Manage Top Indicators
    indicators.forEach(ind => {
      const i = parseInt(ind.getAttribute('data-step-indicator'));
      if(i === stepNum) ind.classList.add('active');
      else ind.classList.remove('active');
    });
  }

  // Next Button Logic (with Validation)
  document.querySelectorAll('.btn-step-next').forEach(btn => {
    btn.addEventListener('click', function() {
       const currentStepDiv = this.closest('.worksheet-step');

       // Simple HTML5 Validation
       const inputs = currentStepDiv.querySelectorAll('input[required], select[required]');
       let valid = true;
       inputs.forEach(i => {
         if(!i.checkValidity()) {
           i.reportValidity();
           valid = false;
         }
       });

       if(valid) {
         const nextStep = parseInt(this.getAttribute('data-next-step'));
         setStep(nextStep);
       }
    });
  });

  // Back Button Logic
  document.querySelectorAll('.btn-step-prev').forEach(btn => {
    btn.addEventListener('click', function() {
       const prevStep = parseInt(this.getAttribute('data-prev-step'));
       setStep(prevStep);
    });
  });

  // --- 4. FORM SUBMIT LOADER ---
  const form = document.getElementById('worksheetForm');
  if(form) {
    form.addEventListener('submit', function() {
       loader.classList.remove('d-none');
       loader.classList.add('d-flex');
       submitBtn.disabled = true;
    });
  }

  // --- 5. CLIPBOARD COPY ---
  const copyBtn = document.getElementById('copyJoinCodeBtn');
  if(copyBtn) {
    copyBtn.addEventListener('click', () => {
       const text = copyBtn.getAttribute('data-copy-text');
       navigator.clipboard.writeText(text).then(() => {
          const original = copyBtn.innerHTML;
          copyBtn.innerHTML = '<i class="bi bi-check2"></i> Copied!';
          setTimeout(() => copyBtn.innerHTML = original, 1500);
       });
    });
  }

  // --- INITIALIZATION ---
  updateMode();
  setStep(1);

});
</script>
{% endblock %}