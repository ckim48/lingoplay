{% extends "base2.html" %}
{% block title %}Story Review · LexiTale{% endblock %}

{% block content %}
<link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&family=Baloo+2:wght@700;800&display=swap" rel="stylesheet">

{% set active_tab = request.args.get('tab') or active_tab or 'assign' %}
{% set fragment = request.args.get('fragment') or fragment or '' %}
{% set selected_class_id = request.args.get('class_id') or selected_class_id or '' %}

<div class="admin-stories-wrap-v2 mt-3 mt-md-4">
  <div class="p-3 p-md-4">

    <!-- Header: Title + Class Switcher + Create Class -->
    <div class="d-flex justify-content-between align-items-start flex-wrap gap-3 mb-3 mb-md-4">
      <div class="d-flex align-items-center gap-3">
        <div class="admin-pill-icon-v7">
          <i class="bi bi-stars"></i>
        </div>
        <div>
          <h1 class="mb-1 fw-bolder admin-title-v7">Admin Dashboard</h1>
          <p class="mb-0 text-muted small admin-text-body">
            Assign worksheets, view assigned work, and grade student submissions.
          </p>
        </div>
      </div>

      <div class="d-flex align-items-center gap-2 flex-wrap">

        <!-- Class selector (changes dashboard scope) -->
        <form method="get" action="{{ url_for('admin_stories') }}" class="d-flex align-items-center gap-2">
          <input type="hidden" name="tab" value="{{ active_tab }}">
          {% if fragment %}
            <input type="hidden" name="fragment" value="{{ fragment }}">
          {% endif %}

          <div class="d-flex flex-column align-items-start">
            <label class="form-label small text-uppercase text-muted admin-text-label mb-1" for="classSelectTop">
              Select a class
            </label>
            <select id="classSelectTop"
                    name="class_id"
                    class="form-select rounded-pill admin-text-body class-select-v7"
                    onchange="this.form.submit()">
              <option value="">All classes</option>
              {% for c in classes or [] %}
                <option value="{{ c.id }}" {% if selected_class_id and (selected_class_id|string) == (c.id|string) %}selected{% endif %}>
                  {{ c.name }}
                </option>
              {% endfor %}
            </select>
          </div>
        </form>

        <!-- Create Class button (replaces New Story in header) -->
        <button type="button"
                class="btn d-none mt-4 btn-sm btn-action-primary-v7 rounded-pill shadow-sm admin-text-button"
                data-bs-toggle="modal"
                data-bs-target="#createClassModal">
          <i class="bi bi-people-fill me-1"></i> Create Class
        </button>
        <a href="/classes"
                class="btn mt-4 btn-sm btn-action-primary-v7 rounded-pill shadow-sm admin-text-button">

          Manage Class
        </a>

      </div>
    </div>

    <!-- Join code helper (shown when a class is selected and code is available) -->
    {% if selected_class and (selected_class.join_code or selected_class.code) %}
      {% set join_code = selected_class.join_code or selected_class.code %}
      <div class="card border-0 rounded-4 shadow-sm mb-4">
        <div class="card-body p-3 p-md-4">
          <div class="d-flex align-items-start justify-content-between flex-wrap gap-2">
            <div>
              <h6 class="fw-bold mb-1 admin-text-title" style="font-size:1.1rem;">
                Class Join Code · <span class="text-coral-dark">{{ selected_class.name }}</span>
              </h6>
              <div class="small text-muted admin-text-body">
                Share this code with students so they can join your class.
              </div>
            </div>

            <div class="d-flex align-items-center gap-2">
              <div class="joincode-pill">
                <span class="joincode-label">CODE</span>
                <span class="joincode-value" id="joinCodeValue">{{ join_code }}</span>
              </div>
              <button type="button"
                      class="btn btn-sm btn-action-outline-v7 rounded-pill admin-text-button"
                      id="copyJoinCodeBtn"
                      data-copy-text="{{ join_code }}">
                <i class="bi bi-clipboard me-1"></i> Copy
              </button>
            </div>
          </div>

          <div class="mt-3 small admin-text-body">
            Students can join at:
            <span class="text-muted">Classes → Join Class</span>
            (or whatever page you provide for joining).
          </div>
        </div>
      </div>
    {% endif %}

    <ul class="nav nav-pills mb-4 gap-2" id="adminTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <a class="nav-link {% if active_tab == 'assign' %}active{% endif %}"
           id="assign-tab"
           data-bs-toggle="pill"
           data-bs-target="#assign-pane"
           href="{{ url_for('admin_stories', tab='assign', class_id=selected_class_id or None) }}"
           role="tab"
           aria-controls="assign-pane"
           aria-selected="{{ 'true' if active_tab == 'assign' else 'false' }}">
          <i class="bi bi-book-fill me-1"></i> Assign Worksheets
        </a>
      </li>

      <li class="nav-item" role="presentation">
        <a class="nav-link {% if active_tab == 'assigned' %}active{% endif %}"
           id="assigned-tab"
           data-bs-toggle="pill"
           data-bs-target="#assigned-pane"
           href="{{ url_for('admin_stories', tab='assigned', class_id=selected_class_id or None) }}"
           role="tab"
           aria-controls="assigned-pane"
           aria-selected="{{ 'true' if active_tab == 'assigned' else 'false' }}">
          <i class="bi bi-clipboard-check me-1"></i> Assigned Worksheets
        </a>
      </li>

      <li class="nav-item" role="presentation">
        <a class="nav-link {% if active_tab == 'submitted' %}active{% endif %}"
           id="submitted-tab"
           data-bs-toggle="pill"
           data-bs-target="#review-pane"
           href="{{ url_for('admin_stories', tab='submitted', class_id=selected_class_id or None) }}"
           role="tab"
           aria-controls="review-pane"
           aria-selected="{{ 'true' if active_tab == 'submitted' else 'false' }}">
          <i class="bi bi-award-fill me-1"></i> Submitted Work
        </a>
      </li>
    </ul>

    <div class="tab-content" id="adminTabsContent">

      <!-- ASSIGN TAB -->
      <div class="tab-pane fade {% if active_tab == 'assign' %}show active{% endif %}"
           id="assign-pane" role="tabpanel" aria-labelledby="assign-tab">

        <div class="card border-0 rounded-4 shadow-sm mb-4">
          <div class="card-body p-3 p-md-4">
            <h2 class="fw-bold mb-2 admin-title-v7" style="font-size: 1.75rem;">
              Create & Assign Worksheet
            </h2>
            <p class="text-muted small admin-text-body mb-4">
              Choose a worksheet type, let GPT generate the tasks, and assign it to specific students.
              {% if selected_class %}
                <span class="d-block mt-1">Current class: <b class="text-coral-dark">{{ selected_class.name }}</b></span>
              {% elif selected_class_id %}
                <span class="d-block mt-1">Current class selected.</span>
              {% else %}
                <span class="d-block mt-1 text-warning-v7">Tip: Select a class to assign only to students in that class.</span>
              {% endif %}
            </p>

            {% if not selected_class_id %}
              <div class="alert bg-light-soft-blue-v7 small admin-text-body mb-4">
                <b>Please select a class</b> at the top to assign worksheets by class.
                (You can still create stories any time using “New Story”.)
              </div>
            {% endif %}

            <div class="worksheet-stepper d-flex align-items-center gap-3 mb-4">
              <div class="d-flex align-items-center gap-2">
                <div class="step-circle step-circle-active" data-step-circle="1">1</div>
                <span class="small admin-text-body d-none d-md-inline">Title</span>
              </div>
              <div class="step-line flex-grow-1 d-none d-md-block"></div>
              <div class="d-flex align-items-center gap-2">
                <div class="step-circle" data-step-circle="2">2</div>
                <span class="small admin-text-body d-none d-md-inline">Type & story</span>
              </div>
              <div class="step-line flex-grow-1 d-none d-md-block"></div>
              <div class="d-flex align-items-center gap-2">
                <div class="step-circle" data-step-circle="3">3</div>
                <span class="small admin-text-body d-none d-md-inline">Assign students</span>
              </div>
            </div>

            {% if stories %}
            <form id="worksheetForm"
                  method="post"
                  action="{{ url_for('admin_generate_worksheet') }}"
                  class="worksheet-gen-form">

              <!-- IMPORTANT: pass class_id so backend can assign by class -->
              <input type="hidden" name="class_id" value="{{ selected_class_id }}">

              <div class="worksheet-step active" data-step="1">
                <div class="row g-3 mb-3">
                  <div class="col-md-8">
                    <label for="worksheetTitleInput" class="form-label admin-text-label small text-uppercase text-muted mb-1">
                      Worksheet Title
                    </label>
                    <input type="text"
                           id="worksheetTitleInput"
                           name="worksheet_title"
                           class="form-control rounded-3 admin-text-body"
                           placeholder="e.g. Writing · My Adventure Story"
                           required
                           {% if not selected_class_id %}disabled{% endif %}>
                    <div class="form-text small text-muted admin-text-body">
                      This title appears on the student's assignment page.
                    </div>
                  </div>
                </div>

                <div class="d-flex justify-content-end mt-3">
                  <button type="button"
                          class="btn btn-action-primary-v7 rounded-pill shadow-sm admin-text-button btn-step-next"
                          data-next-step="2"
                          {% if not selected_class_id %}disabled{% endif %}>
                    Next: Choose type <i class="bi bi-arrow-right ms-1"></i>
                  </button>
                </div>
              </div>

              <div class="worksheet-step" data-step="2">
                <div class="mb-3 p-3 rounded-4 bg-light-soft-blue-v7">
                  <label class="form-label small text-uppercase fw-bold text-coral-dark mb-2 admin-text-label">
                    Worksheet Type
                  </label>
                  <div class="d-flex flex-column gap-2">
                    <div class="form-check">
                      <input class="form-check-input check-coral-v7"
                             type="radio"
                             name="worksheet_type"
                             id="worksheetTypeWriting"
                             value="writing"
                             required
                             {% if not selected_class_id %}disabled{% endif %}>
                      <label class="form-check-label fw-medium admin-text-body" for="worksheetTypeWriting">
                        Writing & Story Creation
                      </label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input check-coral-v7"
                             type="radio"
                             name="worksheet_type"
                             id="worksheetTypeReading"
                             value="reading"
                             {% if not selected_class_id %}disabled{% endif %}>
                      <label class="form-check-label fw-medium admin-text-body" for="worksheetTypeReading">
                        Reading comprehension – <b>MCQ + fill-in-the-blank + short answer</b> based on a selected story.
                      </label>
                    </div>
                  </div>
                  <div class="small text-warning-v7 mt-2 admin-text-body">
                    GPT will generate prompts tailored to the selected worksheet type.
                  </div>
                </div>

                <div id="step2-writing" class="mb-3 d-none">
                  <div class="p-3 rounded-4 border bg-white">
                    <h6 class="mb-3 small text-uppercase fw-bold text-coral-dark admin-text-label">Writing Mode</h6>
                    <div class="row g-3">
                      <div class="col-md-6 mb-3">
                        <label for="writingLevelSelect" class="form-label admin-text-label small text-uppercase text-muted mb-1">
                          Target Reading/Writing Level
                        </label>
                        <select id="writingLevelSelect"
                                name="writing_level"
                                class="form-select rounded-3 admin-text-body"
                                required
                                {% if not selected_class_id %}disabled{% endif %}>
                            <option value="beginner">Beginner</option>
                            <option value="intermediate">Intermediate</option>
                            <option value="advanced">Advanced</option>
                        </select>
                        <div class="form-text small text-muted admin-text-body">
                            Sets the complexity for the generated story content.
                        </div>
                      </div>

                      <div class="col-md-6 mb-3">
                        <label for="writingModeSelect" class="form-label admin-text-label small text-uppercase text-muted mb-1">
                          Task Type
                        </label>
                        <select id="writingModeSelect"
                                name="writing_mode"
                                class="form-select rounded-3 admin-text-body"
                                required
                                {% if not selected_class_id %}disabled{% endif %}>
                            <option value="planning">1. Free Writing (Planning Worksheet)</option>
                            <option value="completion" selected>2. Story Completion (Missing Part)</option>
                        </select>
                        <div class="form-text small text-muted admin-text-body">
                            Completion mode generates a full story with a random B/M/E section removed.
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <div id="step2-reading" class="mb-3 d-none">
                  <div class="p-3 rounded-4 border bg-white">
                    <p class="mb-2 small admin-text-body">
                      <strong>Reading comprehension:</strong> GPT will generate questions from a specific story.
                    </p>
                    <div class="row g-3">
                      <div class="col-md-8">
                        <label for="worksheetStorySelect" class="form-label admin-text-label small text-uppercase text-muted mb-1">
                          Story for reading worksheet
                        </label>
                        <select id="worksheetStorySelect"
                                name="story_id"
                                class="form-select rounded-3 admin-text-body"
                                {% if not selected_class_id %}disabled{% endif %}>
                          <option value="">Select a story…</option>
                          {% for s in stories %}
                            <option value="{{ s.id }}"
                                    data-story-title="{{ s.title|e }}">
                              {{ s.title }} ({{ s.language|upper }} · {{ s.level }})
                            </option>
                          {% endfor %}
                        </select>
                        <div class="form-text small text-muted admin-text-body">
                          Required only for reading worksheets. GPT will use this story to generate questions.
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="d-flex justify-content-between mt-3">
                  <button type="button"
                          class="btn btn-outline-secondary rounded-pill admin-text-button btn-step-prev"
                          data-prev-step="1"
                          {% if not selected_class_id %}disabled{% endif %}>
                    <i class="bi bi-arrow-left me-1"></i> Back
                  </button>
                  <button type="button"
                          class="btn btn-action-primary-v7 rounded-pill shadow-sm admin-text-button btn-step-next"
                          data-next-step="3"
                          {% if not selected_class_id %}disabled{% endif %}>
                    Next: Select students <i class="bi bi-arrow-right ms-1"></i>
                  </button>
                </div>
              </div>

              <div class="worksheet-step" data-step="3">
                <div class="mb-3">
                  <label class="form-label small text-uppercase fw-bold text-muted mb-1 admin-text-label">
                    Assign To Students
                  </label>

                  {% if users %}
                  <div class="border rounded-4 p-3 admin-student-list-v7">
                    {% for u in users %}
                    <div class="form-check small mb-1">
                      <input class="form-check-input check-coral-v7"
                             type="checkbox"
                             name="user_ids"
                             value="{{ u.id }}"
                             id="worksheet_user_{{ u.id }}"
                             {% if not selected_class_id %}disabled{% endif %}>
                      <label class="form-check-label fw-medium admin-text-body" for="worksheet_user_{{ u.id }}">
                        {{ u.username }}
                        <span class="text-muted">· {{ u.email }}</span>
                      </label>
                    </div>
                    {% endfor %}
                  </div>
                  <div class="form-text small text-muted mt-1 admin-text-body">
                    The generated worksheet will be assigned to all selected students.
                  </div>
                  {% else %}
                  <p class="small text-muted mb-0 admin-text-body">
                    No students found in this class.
                  </p>
                  {% endif %}
                </div>

                <div class="d-flex justify-content-between mt-3">
                  <button type="button"
                          class="btn btn-outline-secondary rounded-pill admin-text-button btn-step-prev"
                          data-prev-step="2"
                          {% if not selected_class_id %}disabled{% endif %}>
                    <i class="bi bi-arrow-left me-1"></i> Back
                  </button>
                  <button type="submit"
                          id="worksheetSubmitBtn"
                          class="btn btn-action-primary-v7 rounded-pill shadow-sm admin-text-button"
                          {% if not selected_class_id %}disabled{% endif %}>
                    <i class="bi bi-magic me-1"></i>
                    Generate & Assign Worksheet
                  </button>
                </div>
              </div>

            </form>
            {% else %}
              <div class="py-4 text-center text-muted small admin-text-body">
                No stories yet. Create a story first from the
                <a href="{{ url_for('story_new') }}">AI Story Generator</a>, then return here to build worksheets.
              </div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- ASSIGNED TAB -->
      <div class="tab-pane fade {% if active_tab == 'assigned' %}show active{% endif %}"
           id="assigned-pane" role="tabpanel" aria-labelledby="assigned-tab">

        <h2 class="fw-bold mb-3 admin-title-v7" style="font-size: 1.75rem;">
          Assigned Worksheets <i class="bi bi-clipboard-check"></i>
        </h2>

        {% if assignments %}
          <div class="admin-table-shell-v7">
            <div class="table-responsive p-0 table-padding-outer">
              <table class="table align-middle mb-0 story-table-v7">
                <thead class="small admin-text-body">
                  <tr>
                    <th scope="col" class="table-th-padding">Worksheet</th>
                    <th scope="col" class="table-th-padding">Story</th>
                    <th scope="col" class="d-none d-md-table-cell table-th-padding">Type</th>
                    <th scope="col" class="table-th-padding">Students</th>
                    <th scope="col" class="d-none d-md-table-cell table-th-padding">Status</th>
                    <th scope="col" class="d-none d-md-table-cell text-end table-th-padding">Assigned On</th>
                    <th scope="col" class="text-end table-th-padding">Actions</th>
                  </tr>
                </thead>
                <tbody>
                {% for g in assignments %}
                  {% set total = g.count_assigned + g.count_submitted + g.count_graded %}
                  <tr>
                    <td class="table-td-padding">
                      <a href="{{ url_for('admin_assignment_group_detail', assignment_id=g.primary_assignment_id) }}"
                         class="fw-bold text-coral-dark admin-text-body text-decoration-none">
                        {{ g.assignment_title or ('Writing Worksheet' if g.assignment_type == 'finish' else 'Reading Worksheet') }}
                      </a>
                      {% if g.class_name %}
                        <div class="small text-muted admin-text-body mt-1">
                          Class: {{ g.class_name }}
                        </div>
                      {% endif %}
                    </td>

                    <td class="table-td-padding">
                      <div class="small admin-text-body">
                        {% if g.story_title %}
                          {{ g.story_title }}
                          <span class="text-muted">
                            ({{ g.language|upper }} · {{ g.level }})
                          </span>
                        {% else %}
                          <span class="text-muted">—</span>
                        {% endif %}
                      </div>
                    </td>

                    <td class="d-none d-md-table-cell table-td-padding">
                      <span class="story-tag tag-level-v7 admin-text-tag">
                        {% if g.assignment_type == 'writing' or g.assignment_type == 'finish' %}
                          Writing
                        {% else %}
                          Reading
                        {% endif %}
                      </span>
                    </td>

                    <td class="table-td-padding">
                      {% if total == 0 %}
                        <span class="small text-muted admin-text-body">
                          No students assigned
                        </span>
                      {% else %}
                        <div class="d-flex flex-wrap gap-1">
                          {% for stu in g.assignees[:3] %}
                            <span class="badge rounded-pill text-bg-light admin-text-body">
                              {{ stu.username }}
                            </span>
                          {% endfor %}
                          {% if total > 3 %}
                            <span class="small text-muted admin-text-body">
                              +{{ total - 3 }} more
                            </span>
                          {% endif %}
                        </div>
                      {% endif %}
                    </td>

                    <td class="d-none d-md-table-cell table-td-padding">
                      <span class="small text-muted admin-text-body">
                        {{ g.count_assigned }} assigned ·
                        {{ g.count_submitted }} submitted ·
                        {{ g.count_graded }} graded
                      </span>
                    </td>

                    <td class="d-none d-md-table-cell text-end table-td-padding">
                      <span class="small admin-text-body text-muted">
                        {{ g.created_at|dt("%Y-%m-%d") }}
                      </span>
                    </td>

                    <td class="text-end table-td-padding">
                      <button type="button"
                              class="btn btn-sm btn-action-outline-v7 rounded-pill admin-text-button"
                              data-bs-toggle="modal"
                              data-bs-target="#editAssignmentGroupModal-{{ g.group_id }}">
                        <i class="bi bi-pencil-square me-1"></i>Edit
                      </button>
                    </td>
                  </tr>
                {% endfor %}
                </tbody>
              </table>
            </div>
          </div>

          {# Edit modals for each worksheet group #}
          {% for g in assignments %}
          <div class="modal fade"
               id="editAssignmentGroupModal-{{ g.group_id }}"
               tabindex="-1"
               aria-labelledby="editAssignmentGroupLabel-{{ g.group_id }}"
               aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered">
              <div class="modal-content rounded-4">
                <form method="POST"
                      action="{{ url_for('admin_edit_worksheet_assignment', assignment_id=g.primary_assignment_id) }}">
                  <div class="modal-header border-0">
                    <h5 class="modal-title fw-bold admin-text-title"
                        id="editAssignmentGroupLabel-{{ g.group_id }}">
                      Edit Worksheet – {{ g.assignment_title or ('Worksheet · ' ~ g.story_title) }}
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>

                  <div class="modal-body">
                    <div class="mb-3">
                      <label class="form-label small text-uppercase text-muted admin-text-label">
                        Worksheet Title
                      </label>
                      <input type="text"
                             name="worksheet_title"
                             class="form-control rounded-3 admin-text-body"
                             value="{{ g.assignment_title or ('Worksheet · ' ~ g.story_title) }}"
                             required>
                      <div class="form-text small text-muted admin-text-body">
                        This updates the worksheet title for all students assigned to this worksheet.
                      </div>
                    </div>

                    <div class="mb-3">
                      <label class="form-label small text-uppercase text-muted admin-text-label">
                        Currently assigned students
                      </label>
                      {% if g.assignees %}
                        <div class="border rounded-4 p-3 admin-student-list-v7">
                          <ul class="mb-0 small admin-text-body list-unstyled">
                            {% for stu in g.assignees %}
                              <li>
                                <strong>{{ stu.username }}</strong>
                                <span class="text-muted">· {{ stu.email }}</span>
                              </li>
                            {% endfor %}
                          </ul>
                        </div>
                      {% else %}
                        <p class="small text-muted admin-text-body mb-0">
                          No students are currently assigned to this worksheet.
                        </p>
                      {% endif %}
                    </div>

                    <div class="mb-3">
                      <label class="form-label small text-uppercase text-muted admin-text-label">
                        Assign to additional students
                      </label>

                      {% if users %}
                      {% set assigned_ids = g.assignees | map(attribute='id') | list %}
                      <div class="admin-student-list-v7 border rounded-4 p-3">
                        {% for u in users %}
                          {% if u.id in assigned_ids %}
                            <div class="form-check small mb-1">
                              <input class="form-check-input check-coral-v7"
                                     type="checkbox"
                                     disabled
                                     checked>
                              <label class="form-check-label admin-text-body">
                                {{ u.username }} <span class="text-muted">· already assigned</span>
                              </label>
                            </div>
                          {% else %}
                            <div class="form-check small mb-1">
                              <input class="form-check-input check-coral-v7"
                                     type="checkbox"
                                     name="extra_user_ids"
                                     value="{{ u.id }}"
                                     id="edit_assign_group{{ g.group_id }}_user_{{ u.id }}">
                              <label class="form-check-label admin-text-body"
                                     for="edit_assign_group{{ g.group_id }}_user_{{ u.id }}">
                                {{ u.username }} <span class="text-muted">· {{ u.email }}</span>
                              </label>
                            </div>
                          {% endif %}
                        {% endfor %}
                      </div>
                      <div class="form-text small text-muted admin-text-body">
                        Leave empty to keep the current student list. Checked students will be added as new assignees.
                      </div>
                      {% else %}
                      <p class="small text-muted mb-0 admin-text-body">
                        No students found to assign.
                      </p>
                      {% endif %}
                    </div>

                    <div class="alert bg-light-soft-blue-v7 small admin-text-body">
                      This worksheet is currently assigned to {{ g.assignees|length }} student(s).
                      Use "Unassign this worksheet" below to remove it from all of them.
                    </div>
                  </div>

                  <div class="modal-footer border-0 d-flex justify-content-between">
                    <button type="submit"
                            name="action"
                            value="delete"
                            class="btn btn-outline-danger rounded-pill admin-text-button">
                      <i class="bi bi-trash me-1"></i> Unassign this worksheet
                    </button>

                    <div class="d-flex gap-2">
                      <button type="button"
                              class="btn btn-outline-secondary rounded-pill admin-text-button"
                              data-bs-dismiss="modal">
                        Cancel
                      </button>
                      <button type="submit"
                              name="action"
                              value="save"
                              class="btn btn-action-primary-v7 rounded-pill admin-text-button">
                        <i class="bi bi-save me-1"></i> Save changes
                      </button>
                    </div>
                  </div>

                </form>
              </div>
            </div>
          </div>
          {% endfor %}

        {% else %}
          <div class="py-4 text-center text-muted small admin-text-body">
            No worksheets have been assigned yet.
          </div>
        {% endif %}
      </div>

      <!-- SUBMITTED TAB -->
      <div class="tab-pane fade {% if active_tab == 'submitted' %}show active{% endif %}"
           id="review-pane" role="tabpanel" aria-labelledby="submitted-tab">
        <h2 class="fw-bold mb-3 admin-title-v7" style="font-size: 1.75rem;">
          Submitted Work <i class="bi bi-award"></i>
        </h2>

        {% if submissions_to_review %}

          <div class="accordion accordion-flush admin-table-shell-v7" id="submissionsAccordion">
            {% for sub in submissions_to_review %}
            {% set submission_id = sub.submission_id %}
            {% set is_open = (fragment == 'submission-' ~ submission_id) %}
            <div class="accordion-item">
              <h2 class="accordion-header" id="heading-{{ submission_id }}">
                <button class="accordion-button {% if not is_open %}collapsed{% endif %} fw-bold admin-text-title" type="button" data-bs-toggle="collapse"
                        data-bs-target="#collapse-{{ submission_id }}" aria-expanded="{{ 'true' if is_open else 'false' }}" aria-controls="collapse-{{ submission_id }}">

                  <div class="d-flex align-items-center justify-content-between w-100 pe-3">
                    <span class="text-coral-dark">
                        {{ sub.assignee_username }}
                        <span class="text-muted fw-normal small"> · {{ sub.story_title }}</span>
                        {% if sub.class_name %}
                          <span class="text-muted fw-normal small"> · {{ sub.class_name }}</span>
                        {% endif %}
                    </span>

                    <div class="d-flex gap-2 align-items-center">
                        {% if sub.current_score is not none %}
                            <span class="badge bg-success-v7 admin-text-body" style="color: black">Score: {{ sub.current_score|int }}%</span>
                        {% endif %}
                        <span class="status-pill admin-text-body" style="background: {{ sub.review_status_color }}; color: black;">
                            {{ sub.review_status_label }}
                        </span>
                    </div>
                  </div>
                </button>
              </h2>

              <div id="collapse-{{ submission_id }}" class="accordion-collapse collapse {% if is_open %}show{% endif %}" aria-labelledby="heading-{{ submission_id }}" data-bs-parent="#submissionsAccordion">
                <div class="accordion-body p-4">
                  <div class="d-flex justify-content-between align-items-center mb-3">
                      <p class="small text-muted mb-0">Submitted: {{ sub.submitted_at|dt("%Y-%m-%d %H:%M") }} &bull; Assignment: {{ sub.assignment_title }}</p>

                      <a href="{{ url_for('admin_grading_page', submission_id=sub.submission_id) }}"
                         class="btn btn-action-primary-v7 rounded-pill shadow-sm admin-text-button btn-sm">
                          <i class="bi bi-pencil-fill me-1"></i> Review & Grade
                      </a>
                  </div>

                  <div class="small text-muted pt-2">
                    Click 'Review & Grade' to view the full assignment and student response.
                  </div>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>

        {% else %}
          <div class="py-4 text-center text-muted small admin-text-body">
            <i class="bi bi-check-circle-fill me-1"></i> All submitted worksheets have been reviewed!
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Loading overlay -->
<div id="worksheetLoadingOverlay"
     class="position-fixed top-0 start-0 w-100 h-100 d-none"
     style="background: rgba(15,23,42,0.65); z-index: 1057;">
  <div class="d-flex flex-column align-items-center justify-content-center h-100">
    <div class="spinner-grow text-coral-main mb-3" role="status" style="width: 2.5rem; height: 2.5rem;">
      <span class="visually-hidden">Loading...</span>
    </div>
    <div class="text-white small fw-bold p-2 rounded-3 admin-text-body" style="background: rgba(0,0,0,0.2);">
      <i class="bi bi-magic me-1"></i> Generating worksheet with AI…
    </div>
  </div>
</div>

<!-- Create Class Modal -->
<div class="modal fade" id="createClassModal" tabindex="-1" aria-labelledby="createClassLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content rounded-4">
      <form method="POST" action="{{ url_for('admin_create_class') }}">
        <div class="modal-header border-0">
          <h5 class="modal-title fw-bold admin-text-title" id="createClassLabel">
            Create a New Class
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label small text-uppercase text-muted admin-text-label">
              Class Name
            </label>
            <input type="text"
                   name="class_name"
                   class="form-control rounded-3 admin-text-body"
                   placeholder="e.g. Grade 5 · English A"
                   required>
            <div class="form-text small text-muted admin-text-body">
              A join code will be generated automatically so students can join.
            </div>
          </div>

          <div class="alert bg-light-soft-blue-v7 small admin-text-body">
            After creating the class, you can share the <b>join code</b> with students.
            Students will enter the code on the <b>Join Class</b> page to enroll.
          </div>
        </div>

        <div class="modal-footer border-0 d-flex justify-content-between">
          <button type="button"
                  class="btn btn-outline-secondary rounded-pill admin-text-button"
                  data-bs-dismiss="modal">
            Cancel
          </button>
          <button type="submit"
                  class="btn btn-action-primary-v7 rounded-pill admin-text-button">
            <i class="bi bi-plus-circle me-1"></i> Create Class
          </button>


        </div>
      </form>
    </div>
  </div>
</div>

<script>
(function(){
  const worksheetTitleInput = document.getElementById('worksheetTitleInput');
  const storySelect = document.getElementById('worksheetStorySelect');
  const typeRadios = document.querySelectorAll('input[name="worksheet_type"]');
  const step2Writing = document.getElementById('step2-writing');
  const step2Reading = document.getElementById('step2-reading');

  function updateStep2View() {
    const selected = document.querySelector('input[name="worksheet_type"]:checked');
    const type = selected ? selected.value : null;

    if (!step2Writing || !step2Reading) return;

    if (type === 'writing') {
      step2Writing.classList.remove('d-none');
      step2Reading.classList.add('d-none');
    } else if (type === 'reading') {
      step2Writing.classList.add('d-none');
      step2Reading.classList.remove('d-none');
    } else {
      step2Writing.classList.add('d-none');
      step2Reading.classList.add('d-none');
    }

    if (storySelect) {
      if (type === 'reading') {
        storySelect.disabled = false;
        storySelect.setAttribute('required', 'required');
      } else {
        storySelect.disabled = true;
        storySelect.removeAttribute('required');
      }
    }

    const writingLevelSelect = document.getElementById('writingLevelSelect');
    const writingModeSelect = document.getElementById('writingModeSelect');

    if (writingLevelSelect && writingModeSelect) {
      if (type === 'writing') {
        writingLevelSelect.setAttribute('required', 'required');
        writingModeSelect.setAttribute('required', 'required');
      } else {
        writingLevelSelect.removeAttribute('required');
        writingModeSelect.removeAttribute('required');
      }
    }
  }

  if (storySelect && worksheetTitleInput) {
    storySelect.addEventListener('change', function () {
      const selectedType = document.querySelector('input[name="worksheet_type"]:checked')?.value;
      if (selectedType !== 'reading') return;
      const opt = storySelect.selectedOptions[0];
      const title = opt ? opt.getAttribute('data-story-title') : '';
      if (title) {
        if (!worksheetTitleInput.value ||
            worksheetTitleInput.value.startsWith('Worksheet ·') ||
            worksheetTitleInput.value.startsWith('Reading ·')) {
          worksheetTitleInput.value = `Reading · ${title}`;
        }
      }
    });
  }

  typeRadios.forEach(r => r.addEventListener('change', updateStep2View));

  const steps = Array.from(document.querySelectorAll('.worksheet-step'));
  const stepCircles = Array.from(document.querySelectorAll('.step-circle'));
  let currentStep = 1;

  function setStepCircleActive(stepNum) {
    stepCircles.forEach(c => {
      const s = parseInt(c.getAttribute('data-step-circle'), 10);
      c.classList.toggle('step-circle-active', s === stepNum);
    });
  }

  function showStep(targetStep) {
    if (currentStep === 1 && targetStep === 2) {
      if (worksheetTitleInput && !worksheetTitleInput.value) {
        worksheetTitleInput.reportValidity();
        return;
      }
    }

    if (currentStep === 2 && targetStep === 3) {
      const selectedType = document.querySelector('input[name="worksheet_type"]:checked')?.value;
      if (selectedType === 'reading' && storySelect && !storySelect.value) {
        storySelect.reportValidity();
        return;
      }
    }

    if (targetStep === currentStep) return;

    const currentEl = steps.find(s => parseInt(s.getAttribute('data-step'), 10) === currentStep);
    const nextEl = steps.find(s => parseInt(s.getAttribute('data-step'), 10) === targetStep);
    if (!nextEl) return;

    if (currentEl) {
      currentEl.classList.remove('active');
      currentEl.classList.add('fading-out');
      setTimeout(() => {
        currentEl.classList.remove('fading-out');
        currentEl.style.display = 'none';
      }, 220);
    }

    nextEl.style.display = 'block';
    requestAnimationFrame(() => nextEl.classList.add('active'));

    currentStep = targetStep;
    setStepCircleActive(targetStep);
    updateStep2View();
  }

  steps.forEach(step => {
    const s = parseInt(step.getAttribute('data-step'), 10);
    if (s === 1) {
      step.style.display = 'block';
      step.classList.add('active');
    } else {
      step.style.display = 'none';
      step.classList.remove('active');
    }
  });
  setStepCircleActive(1);
  updateStep2View();

  document.querySelectorAll('.btn-step-next').forEach(btn => {
    btn.addEventListener('click', () => {
      const next = parseInt(btn.getAttribute('data-next-step'), 10);
      if (!isNaN(next)) showStep(next);
    });
  });
  document.querySelectorAll('.btn-step-prev').forEach(btn => {
    btn.addEventListener('click', () => {
      const prev = parseInt(btn.getAttribute('data-prev-step'), 10);
      if (!isNaN(prev)) showStep(prev);
    });
  });

  const worksheetForm = document.getElementById('worksheetForm');
  const worksheetSubmitBtn = document.getElementById('worksheetSubmitBtn');
  const worksheetLoadingOverlay = document.getElementById('worksheetLoadingOverlay');

  if (worksheetForm) {
    worksheetForm.addEventListener('submit', function (e) {
      const selectedType = document.querySelector('input[name="worksheet_type"]:checked')?.value;
      let isValid = true;

      if (selectedType === 'reading' && storySelect && !storySelect.value) isValid = false;

      if (isValid) {
        if (worksheetSubmitBtn) worksheetSubmitBtn.disabled = true;
        if (worksheetLoadingOverlay) worksheetLoadingOverlay.classList.remove('d-none');
      } else {
        e.preventDefault();
        if (selectedType === 'reading' && storySelect) storySelect.reportValidity();
      }
    });
  }

  // Tab persistence
  const activeTab = '{{ active_tab }}';
  const fragment = '{{ fragment }}';

  let tabIdToShow = null;
  if (activeTab === 'assigned') tabIdToShow = 'assigned-tab';
  else if (activeTab === 'submitted' || fragment) tabIdToShow = 'submitted-tab';
  else tabIdToShow = 'assign-tab';

  if (tabIdToShow) {
    const tabEl = document.getElementById(tabIdToShow);
    if (tabEl && window.bootstrap && bootstrap.Tab) new bootstrap.Tab(tabEl).show();
  }

  // Copy join code
  const copyBtn = document.getElementById('copyJoinCodeBtn');
  if (copyBtn) {
    copyBtn.addEventListener('click', async () => {
      const txt = copyBtn.getAttribute('data-copy-text') || '';
      try {
        await navigator.clipboard.writeText(txt);
        copyBtn.innerHTML = '<i class="bi bi-check2 me-1"></i> Copied';
        setTimeout(() => {
          copyBtn.innerHTML = '<i class="bi bi-clipboard me-1"></i> Copy';
        }, 900);
      } catch (e) {
        // fallback
        const ta = document.createElement('textarea');
        ta.value = txt;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        ta.remove();
      }
    });
  }
})();
</script>

<style>
/* --- V7 ADMIN COLOR PALETTE & VARIABLES --- */
:root {
  --coral-main: #ff6b6b;
  --coral-light: #ffd7cc;
  --coral-dark: #cc5555;
  --success-v7: #10b981;
  --danger-v7: #ef4444;
  --warning-v7: #f59e0b;
  --light-soft-blue-v7: #ffece5;
  --soft-yellow-v7: #fff7e5;
  --table-padding-v2: 1.5rem;
}

/* Fonts */
.admin-title-v7, .admin-text-title, .admin-text-button { font-family: 'Baloo 2', cursive; font-weight: 700; }
.admin-text-body, .admin-text-label, .admin-text-tag { font-family: 'Fredoka', 'Nunito', sans-serif; }
.admin-title-v7 { font-size: 2.25rem; color: var(--coral-dark); }
.admin-text-title { font-size: 1.5rem; }
.admin-text-label { font-weight: 600 !important; }
.admin-text-button { font-weight: 600 !important; }

.text-coral-dark { color: var(--coral-dark) !important; }
.text-success-v7 { color: var(--success-v7) !important; }
.text-danger-v7 { color: var(--danger-v7) !important; }
.text-warning-v7 { color: var(--warning-v7) !important; }
.bg-light-soft-blue-v7 { background-color: var(--light-soft-blue-v7) !important; }

.admin-stories-wrap-v2 { max-width: 1300px; margin-inline: auto; }

/* Header pill icon */
.admin-pill-icon-v7{
  width:52px;height:52px;border-radius:1.25rem;
  background:linear-gradient(135deg,var(--coral-main),var(--coral-dark));
  display:inline-flex;align-items:center;justify-content:center;
  font-size:1.75rem;color:#fff;
  box-shadow:0 0.5rem 1rem rgba(255,107,107,.4);
}

/* Buttons */
.btn-action-primary-v7{
  background-color:var(--coral-main); border-color:var(--coral-main); color:#fff;
  font-weight:600; padding:.5rem 1.2rem; transition:all .2s;
  box-shadow:0 4px 8px rgba(255,107,107,.3);
}
.btn-action-primary-v7:hover{
  background-color:#e86060; border-color:#e86060;
  transform:translateY(-2px);
  box-shadow:0 6px 12px rgba(255,107,107,.4);
}
.btn-action-outline-v7{
  color:var(--coral-dark); border-color:var(--coral-light); background-color:#fff;
  transition:all .2s; font-weight:600; padding:.4rem 1rem;
}
.btn-action-outline-v7:hover{
  background-color:#ffece5; border-color:var(--coral-main); color:var(--coral-dark);
}

/* Class selector */
.class-select-v7{
  min-width: 220px;
  border: 1px solid var(--coral-light);
}
.class-select-v7:focus{
  box-shadow:0 0 0 .25rem rgba(255,107,107,.25);
  border-color:var(--coral-main);
}

/* Join code pill */
.joincode-pill{
  display:inline-flex; align-items:center; gap:.55rem;
  background:linear-gradient(90deg,#ffece5,#fff7e5);
  border:1px solid var(--coral-light);
  padding:.4rem .8rem;
  border-radius:999px;
}
.joincode-label{
  font-size:.72rem; letter-spacing:.08em;
  font-weight:800; color:var(--coral-dark);
}
.joincode-value{
  font-weight:800;
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  color:#0b1220;
}

/* Table container */
.admin-table-shell-v7{
  border-radius:1.5rem; overflow:hidden;
  border:2px solid var(--coral-light);
  background:#fff;
  box-shadow:0 .5rem 1.5rem rgba(255,107,107,.15);
}
.table-padding-outer{ padding:1.5rem !important; }

/* Table head */
.story-table-v7 thead{
  background:linear-gradient(90deg,#ffece5,#fff7e5);
  border-bottom:2px solid var(--coral-light);
}
.story-table-v7 thead th{
  border-bottom:0; font-weight:700; text-transform:uppercase;
  letter-spacing:.05em; font-size:.75rem; color:var(--coral-dark);
}
.table-th-padding{ padding-top:1.2rem !important; padding-bottom:1.2rem !important; }
.table-td-padding{ padding-top:var(--table-padding-v2) !important; padding-bottom:var(--table-padding-v2) !important; }

/* Table rows */
.story-table-v7 tbody tr td{ border-top-color:rgba(0,0,0,.08); }
.story-table-v7 tbody tr{ transition:background-color .15s ease, transform .15s ease; }
.story-table-v7 tbody tr:hover{ background-color:var(--soft-yellow-v7); transform:scale(1.005); }

/* Status pills */
.status-pill{
  padding:.3rem .8rem; border-radius:1rem; font-size:.75rem;
  font-weight:700; letter-spacing:.02em;
}

/* Modal-style list for students */
.admin-student-list-v7{
  max-height:220px; overflow-y:auto;
  background:#fcfcfc; border:1px solid #eee;
  padding:1rem !important; border-radius:1rem !important;
}

/* Inputs */
.form-check-input{ border-radius:.45em; border-width:2px; }
.form-check-input:focus{
  box-shadow:0 0 0 .25rem rgba(255,107,107,.3);
  border-color:var(--coral-main);
}
.form-check-input:checked{ background-color:var(--coral-main); border-color:var(--coral-main); }
.form-check-input[type="radio"]{ border-radius:50%; }

/* Loading overlay spinner color */
#worksheetLoadingOverlay .spinner-grow{ color:var(--coral-main) !important; }

/* Accordion styling */
.accordion-item{ border:none; margin-bottom:.75rem; border-radius:1rem; }
.accordion-button{
  background-color:#fff; border-radius:1rem !important;
  border:1px solid var(--coral-light);
  transition:background-color .2s, box-shadow .2s;
  padding:1.25rem 1.5rem; font-size:1.1rem; color:var(--coral-dark);
}
.accordion-button:not(.collapsed){
  background-color:var(--soft-yellow-v7); color:var(--coral-dark);
  box-shadow:none; border-bottom-left-radius:0 !important; border-bottom-right-radius:0 !important;
  border-bottom:1px solid var(--coral-light);
}
.accordion-button:focus{ box-shadow:0 0 0 .25rem rgba(255,107,107,.3); }
.accordion-body{
  background:#fff; border:1px solid var(--coral-light); border-top:none;
  border-bottom-left-radius:1rem; border-bottom-right-radius:1rem;
}

/* Nav tabs styling */
.nav-pills .nav-item{ padding:0; }
.nav-pills .nav-link{
  font-family:'Baloo 2', cursive;
  font-weight:600; border-radius:999px;
  padding:.5rem 1.2rem; color:var(--coral-dark);
  border:1px solid var(--coral-light);
  background:#fff; transition:all .2s;
}
.nav-pills .nav-link:hover:not(.active){
  background-color:var(--soft-yellow-v7);
  border-color:var(--coral-main);
  color:var(--coral-dark);
}
.nav-pills .nav-link.active,
.nav-pills .nav-link.active:hover{
  color:#fff; background:var(--coral-main); border-color:var(--coral-main);
  box-shadow:0 4px 8px rgba(255,107,107,.3);
}

/* Stepper */
.worksheet-stepper{ border-radius:999px; background:#fff7ef; padding:.6rem .9rem; }
.step-circle{
  width:28px;height:28px;border-radius:999px;border:2px solid #fbbfbd;
  display:inline-flex;align-items:center;justify-content:center;
  font-size:.8rem;font-weight:700;color:#f97373;background:#fff;transition:all .2s;
}
.step-circle-active{
  background:var(--coral-main); border-color:var(--coral-main); color:#fff;
  box-shadow:0 .3rem .8rem rgba(255,107,107,.4);
}
.step-line{ height:2px; background:linear-gradient(90deg,#fed7d7,#fecaca); }

/* Step panes fade */
.worksheet-step{ opacity:0; display:none; transition:opacity .22s ease; }
.worksheet-step.active{ display:block; opacity:1; }
.worksheet-step.fading-out{ display:block; opacity:0; }
</style>

{% endblock %}
