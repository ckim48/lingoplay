{% extends "base2.html" %}
{% block title %}Class Analytics · LexiTale{% endblock %}

{% block content %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&family=Baloo+2:wght=700;800&display=swap" rel="stylesheet">

<div class="analytics-page py-3 py-md-4 container">

  <div class="d-flex flex-wrap justify-content-between align-items-center mb-4 pb-2">
    <div>
      <h1 class="fw-bolder mb-1 page-main-title text-coral-dark" style="font-size: 2.5rem;">
        <i class="bi bi-graph-up-arrow me-2"></i> Class Performance Dashboard
      </h1>
      <p class="text-muted small mb-0 page-sub-text">
        Aggregated data comparing L1 vs L2 learner performance (Mock Data).
      </p>
    </div>
    <div class="badge page-pill page-sub-text">
      <i class="bi bi-person-circle me-1"></i> Teacher View
    </div>
  </div>

  <div class="row g-3 g-md-4 mb-4">

    {# 1. Word Scramble Score #}
    <div class="col-md-6"><div class="chart-card chart-bubble h-100"><div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h6 class="mb-0 chart-title">Word Scramble Accuracy</h6>
        <span class="small text-muted page-sub-text">L1 vs L2 (%)</span>
      </div>
      <div class="chart-box"><canvas id="chartScramble"></canvas></div>
    </div></div></div>

    {# 2. MCQ Score vs Attempts #}
    <div class="col-md-6"><div class="chart-card chart-bubble h-100"><div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h6 class="mb-0 chart-title">Reading Performance</h6>
        <span class="small text-muted page-sub-text">Score & Attempts</span>
      </div>
      <div class="chart-box"><canvas id="chartMCQ"></canvas></div>
    </div></div></div>

    {# 3. Writing Score #}
    <div class="col-md-6"><div class="chart-card chart-bubble h-100"><div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h6 class="mb-0 chart-title">Writing Assignment Score</h6>
        <span class="small text-muted page-sub-text">Avg score (%)</span>
      </div>
      <div class="chart-box"><canvas id="chartWriting"></canvas></div>
    </div></div></div>

    {# 4. Overall Engagement (Radar) #}
    <div class="col-md-6"><div class="chart-card chart-bubble h-100"><div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h6 class="mb-0 chart-title">Overall Engagement Profile</h6>
        <span class="small text-muted page-sub-text">Metrics comparison (Radar)</span>
      </div>
      <div class="chart-box"><canvas id="chartEngagement"></canvas></div>
    </div></div></div>
  </div>

  <div class="row g-3 g-md-4 mb-4">

    {# 5. Progress Over Time (Line Chart) #}
    <div class="col-md-6"><div class="chart-card chart-bubble h-100"><div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h6 class="mb-0 chart-title">Score Progress Over Time</h6>
        <span class="small text-muted page-sub-text">Weekly MCQ Score</span>
      </div>
      <div class="chart-box"><canvas id="chartProgress"></canvas></div>
    </div></div></div>

    {# 6. Top 10 Dictionary Searches #}
    <div class="col-md-6"><div class="chart-card chart-bubble h-100"><div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h6 class="mb-0 chart-title">Top 10 Dictionary Searches</h6>
        <div class="aa-toggle-group btn-group btn-group-sm" role="group" aria-label="Toggle L1 / L2">
          <button type="button" class="btn aa-toggle-pill active" data-dataset="L1">L1</button>
          <button type="button" class="btn aa-toggle-pill" data-dataset="L2">L2</button>
        </div>
      </div>
      <div class="chart-box"><canvas id="chartDictTop"></canvas></div>
    </div></div></div>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Palette
const V7_COLORS = {
  coralMain: '#ff6b6b',
  coralLight: '#ffd7cc',
  coralDark: '#cc5555',
  ink: '#111827',
  muted: '#6b7280',
  secondary: '#065f46',
  secondaryLight: '#d1fae5',
  cardBorder: '#fcece4',
  bgGameLight: '#fffcf8'
};

const MOCK_QUERY_TOPICS = [
  { query: 'imagination', cnt: 55 }, { query: 'happy', cnt: 48 }, { query: 'magic', cnt: 42 },
  { query: 'adventure', cnt: 35 }, { query: 'explore', cnt: 31 }, { query: 'dragon', cnt: 28 },
  { query: 'listen', cnt: 24 }, { query: 'ocean', cnt: 20 }, { query: 'jump', cnt: 18 }, { query: 'planet', cnt: 16 }
];

Chart.defaults.color = V7_COLORS.ink;
Chart.defaults.font.family = "'Fredoka', 'Nunito', sans-serif";
Chart.defaults.font.weight = '500';

const chartGlobalOptions = {
  responsive: true,
  maintainAspectRatio: false,
  animation: { duration: 0 },
  plugins: {
    legend: {
      labels: {
        font: { family: "'Fredoka', 'Nunito', sans-serif", size: 14, weight: '500' },
        color: V7_COLORS.ink
      },
      position: 'bottom'
    },
    tooltip: {
      bodyFont: { family: "'Fredoka', 'Nunito', sans-serif", weight: '500' },
      titleFont: { family: "'Baloo 2', cursive", weight: '700' },
      backgroundColor: 'rgba(255, 252, 248, 0.95)',
      titleColor: V7_COLORS.coralMain,
      bodyColor: V7_COLORS.ink,
      borderColor: V7_COLORS.cardBorder,
      borderWidth: 1,
      borderRadius: 8,
      padding: 12
    }
  },
  scales: {
    x: { ticks: { color: V7_COLORS.muted }, grid: { color: V7_COLORS.cardBorder } },
    y: { ticks: { color: V7_COLORS.muted }, grid: { color: V7_COLORS.cardBorder } },
    r: {
      ticks: { backdropColor: V7_COLORS.bgGameLight, color: V7_COLORS.muted },
      pointLabels: { color: V7_COLORS.ink, font: { family: "'Baloo 2', cursive", weight: '600', size: 13 } },
      grid: { color: V7_COLORS.cardBorder }
    }
  }
};

const datasetL1 = {
  backgroundColor: V7_COLORS.coralMain,
  borderColor: V7_COLORS.coralMain,
  borderWidth: 2,
  borderRadius: 6,
  hoverBackgroundColor: V7_COLORS.coralMain,
  label: "L1"
};
const datasetL2 = {
  backgroundColor: V7_COLORS.secondary,
  borderColor: V7_COLORS.secondary,
  borderWidth: 2,
  borderRadius: 6,
  hoverBackgroundColor: V7_COLORS.secondary,
  label: "L2"
};

const radarDatasetL1 = {
  backgroundColor: 'rgba(255, 107, 107, 0.2)',
  borderColor: V7_COLORS.coralMain,
  pointBackgroundColor: V7_COLORS.coralMain,
  pointBorderColor: '#fff',
  pointHoverBackgroundColor: '#fff',
  pointHoverBorderColor: V7_COLORS.coralMain,
  borderWidth: 2,
  label: "L1"
};
const radarDatasetL2 = {
  backgroundColor: 'rgba(6, 95, 70, 0.2)',
  borderColor: V7_COLORS.secondary,
  pointBackgroundColor: V7_COLORS.secondary,
  pointBorderColor: '#fff',
  pointHoverBackgroundColor: '#fff',
  pointHoverBorderColor: V7_COLORS.secondary,
  borderWidth: 2,
  label: "L2"
};

document.addEventListener("DOMContentLoaded", function() {
  const groups = {{ group_list|tojson|safe }};

  function safeNum(v) {
    const n = Number(v);
    return Number.isFinite(n) ? n : 0;
  }

  function getGroup(code) {
    return groups.find(g => g.code === code) || {};
  }

  let L1 = getGroup("L1");
  let L2 = getGroup("L2");
  const labelGroups = ["L1", "L2"];

  if (!L1.code) L1 = {code: "L1", scramble_accuracy: 75, mcq_avg_score: 80, mcq_avg_attempts: 1.5, writing_avg_score: 65, top_queries: []};
  if (!L2.code) L2 = {code: "L2", scramble_accuracy: 60, mcq_avg_score: 70, mcq_avg_attempts: 2.1, writing_avg_score: 55, top_queries: []};

  function baseOptions(extra = {}) {
    return Object.assign({}, chartGlobalOptions, extra);
  }

  // 1. Word Scramble accuracy (FIXED: Single dataset with color array)
  const ctxScramble = document.getElementById("chartScramble");
  if (ctxScramble) {
    new Chart(ctxScramble.getContext("2d"), {
      type: "bar",
      data: {
        labels: labelGroups,
        datasets: [
          {
            label: "Accuracy (%)",
            data: [safeNum(L1.scramble_accuracy), safeNum(L2.scramble_accuracy)],
            backgroundColor: [V7_COLORS.coralMain, V7_COLORS.secondary],
            borderRadius: 6
          }
        ]
      },
      options: baseOptions({
        scales: {
          y: { beginAtZero: true, max: 100, title: { display: true, text: 'Accuracy (%)' } },
          x: { grid: { display: false } }
        },
        plugins: {
          legend: { display: false }
        }
      })
    });
  }


// 2. Reading Performance (MCQ) – centered bars per group
const ctxMCQ = document.getElementById("chartMCQ");
if (ctxMCQ) {
  const l1Score = safeNum(L1.mcq_avg_score);
  const l2Score = safeNum(L2.mcq_avg_score);
  const l1Attempts = safeNum(L1.mcq_avg_attempts);
  const l2Attempts = safeNum(L2.mcq_avg_attempts);

  new Chart(ctxMCQ.getContext("2d"), {
    type: "bar",
    data: {
      labels: labelGroups,   // ["L1", "L2"]
      datasets: [
        {
          label: "Score (%)",
          data: [l1Score, l2Score],
          backgroundColor: [V7_COLORS.coralMain, V7_COLORS.secondary],
          borderRadius: 6,
          yAxisID: "y-score"
        },
        {
          label: "Attempts",
          data: [l1Attempts, l2Attempts],
          backgroundColor: ["#ffc8c8", "#c6f6d5"],
          borderRadius: 6,
          yAxisID: "y-attempts"
        }
      ]
    },
    options: baseOptions({
      plugins: {
        tooltip: {
          callbacks: {
            label: function (ctx) {
              const label = ctx.dataset.label || "";
              const isScore = ctx.dataset.yAxisID === "y-score";
              return label + ": " + ctx.parsed.y.toFixed(1) + (isScore ? "%" : "");
            }
          }
        }
      },
      scales: {
        x: {
          grid: { display: false },
          // default grouping is fine; this just tightens spacing a bit
          categoryPercentage: 0.7,
          barPercentage: 0.9
        },
        "y-score": {
          position: "left",
          beginAtZero: true,
          max: 100,
          title: { display: true, text: "Score (%)" }
        },
        "y-attempts": {
          position: "right",
          beginAtZero: true,
          max: 5,
          grid: { drawOnChartArea: false },
          title: { display: true, text: "Attempts" }
        }
      }
    })
  });
}


  // 3. Writing scores (FIXED: Single dataset with color array)
  const ctxWriting = document.getElementById("chartWriting");
  if (ctxWriting) {
    new Chart(ctxWriting.getContext("2d"), {
      type: "bar",
      data: {
        labels: labelGroups,
        datasets: [
          {
            label: "Avg Score (%)",
            data: [safeNum(L1.writing_avg_score), safeNum(L2.writing_avg_score)],
            backgroundColor: [V7_COLORS.coralMain, V7_COLORS.secondary],
            borderRadius: 6
          }
        ]
      },
      options: baseOptions({
        scales: {
          y: { beginAtZero: true, max: 100, title: { display: true, text: 'Score (%)' } },
          x: { grid: { display: false } }
        },
        plugins: {
          legend: { display: false }
        }
      })
    });
  }

  // 4. Engagement radar
  const ctxEngagement = document.getElementById("chartEngagement");
  if (ctxEngagement) {
    const radarDatasets = [
      Object.assign({}, radarDatasetL1, {
        data: [
          safeNum(L1.scramble_accuracy),
          safeNum(L1.mcq_avg_score),
          safeNum(L1.writing_avg_score)
        ]
      }),
      Object.assign({}, radarDatasetL2, {
        data: [
          safeNum(L2.scramble_accuracy),
          safeNum(L2.mcq_avg_score),
          safeNum(L2.writing_avg_score)
        ]
      })
    ];

    new Chart(ctxEngagement.getContext("2d"), {
      type: "radar",
      data: {
        labels: ["Scramble", "MCQ", "Writing"],
        datasets: radarDatasets
      },
      options: baseOptions({
        elements: { line: { tension: 0.1 } },
        scales: {
          r: { beginAtZero: true, max: 100 }
        }
      })
    });
  }

  // 5. Progress over time
  const ctxProgress = document.getElementById("chartProgress");
  if (ctxProgress) {
    const weeks = ["W1", "W2", "W3", "W4", "W5"];
    const baseL1 = safeNum(L1.mcq_avg_score) || 80;
    const baseL2 = safeNum(L2.mcq_avg_score) || 70;

    const l1Series = [
      Math.max(0, Math.min(100, baseL1 - 4)),
      Math.max(0, Math.min(100, baseL1 - 2)),
      Math.max(0, Math.min(100, baseL1)),
      Math.max(0, Math.min(100, baseL1 + 2)),
      Math.max(0, Math.min(100, baseL1 + 3))
    ];
    const l2Series = [
      Math.max(0, Math.min(100, baseL2 - 5)),
      Math.max(0, Math.min(100, baseL2 - 3)),
      Math.max(0, Math.min(100, baseL2)),
      Math.max(0, Math.min(100, baseL2 + 2)),
      Math.max(0, Math.min(100, baseL2 + 4))
    ];

    new Chart(ctxProgress.getContext("2d"), {
      type: "line",
      data: {
        labels: weeks,
        datasets: [
          {
            label: "L1 MCQ Avg (%)",
            data: l1Series,
            borderColor: V7_COLORS.coralMain,
            backgroundColor: "rgba(255,107,107,0.15)",
            tension: 0.3,
            fill: true,
            pointRadius: 3,
            pointBackgroundColor: V7_COLORS.coralMain
          },
          {
            label: "L2 MCQ Avg (%)",
            data: l2Series,
            borderColor: V7_COLORS.secondary,
            backgroundColor: "rgba(6,95,70,0.15)",
            tension: 0.3,
            fill: true,
            pointRadius: 3,
            pointBackgroundColor: V7_COLORS.secondary
          }
        ]
      },
      options: baseOptions({
        scales: {
          y: { beginAtZero: true, max: 100, title: { display: true, text: 'Score (%)' } },
          x: { grid: { display: false } }
        }
      })
    });
  }

  // 6. Dictionary top words (FIXED: Added stacked: true)
  const ctxDictTop = document.getElementById("chartDictTop");
  let dictChart = null;

  if (ctxDictTop) {
    const l1Top = Array.isArray(L1.top_queries) ? L1.top_queries : [];
    const l2Top = Array.isArray(L2.top_queries) ? L2.top_queries : [];
    const wordMap = new Map();

    MOCK_QUERY_TOPICS.forEach(item => {
      const key = item.query;
      if (!wordMap.has(key)) {
        wordMap.set(key, { word: key, l1: 0, l2: 0 });
      }
      wordMap.get(key).l1 = safeNum(item.cnt) + Math.floor(Math.random() * 10) + 20;
      wordMap.get(key).l2 = Math.max(5, safeNum(item.cnt) + Math.floor(Math.random() * 8));
    });

    const merged = Array.from(wordMap.values());
    merged.sort((a, b) => (b.l1 + b.l2) - (a.l1 + a.l2));
    const top10 = merged.slice(0, 10);
    const labels = top10.map(x => x.word);
    const l1Counts = top10.map(x => x.l1);
    const l2Counts = top10.map(x => x.l2);

    const datasets = [
      Object.assign({}, datasetL1, {
        label: 'L1',
        data: l1Counts,
        hidden: false
      }),
      Object.assign({}, datasetL2, {
        label: 'L2',
        data: l2Counts,
        hidden: true
      })
    ];

    dictChart = new Chart(ctxDictTop.getContext("2d"), {
      type: "bar",
      data: { labels, datasets },
      options: baseOptions({
        indexAxis: "y",
        scales: {
          x: {
            beginAtZero: true,
            grid: { display: false },
            title: { display: true, text: 'Search Count' },
            stacked: true
          },
          y: {
            ticks: { color: V7_COLORS.ink },
            stacked: true
          }
        },
        plugins: {
          legend: { display: true, position: 'bottom' }
        }
      })
    });

    const toggleButtons = document.querySelectorAll('.aa-toggle-pill[data-dataset]');
    toggleButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const name = btn.getAttribute('data-dataset');
        const dsIndex = dictChart.data.datasets.findIndex(d => d.label === name);
        if (dsIndex === -1) return;

        const visibleCount = dictChart.data.datasets.filter(d => !d.hidden).length;
        const isCurrentlyActive = btn.classList.contains('active');
        const isHidingLast = (visibleCount === 1) && isCurrentlyActive;
        if (isHidingLast) return;

        if (isCurrentlyActive) {
          btn.classList.remove('active');
          dictChart.data.datasets[dsIndex].hidden = true;
        } else {
          btn.classList.add('active');
          dictChart.data.datasets[dsIndex].hidden = false;
        }
        dictChart.update();
      });
    });
  }
});
</script>

<style>
:root {
  --coral-main: #ff6b6b;
  --coral-light: #ffd7cc;
  --coral-dark: #cc5555;
  --ink: #111827;
  --muted: #6b7280;
  --paper: #ffffff;
  --shadow-card: 0 8px 20px rgba(255, 107, 107, 0.1), 0 4px 8px rgba(0, 0, 0, 0.05);
  --card-border: #fcece4;
  --secondary: #065f46;
}

.page-main-title {
  font-family: 'Baloo 2', cursive;
  font-weight: 800;
  color: var(--ink);
}
.page-sub-text {
  font-family: 'Fredoka', 'Nunito', sans-serif;
  font-weight: 500;
}
.chart-title {
  font-family: 'Baloo 2', cursive;
  font-weight: 700;
  color: var(--coral-dark);
  font-size: 1.5rem !important;
}

.chart-card {
  border-radius: 1.5rem;
  padding: 1.2rem 1.2rem;
  background: var(--paper);
  box-shadow: var(--shadow-card);
  transition: transform .2s ease, box-shadow .2s ease;
  border: 2px solid var(--coral-light);
  position: relative;
  overflow: hidden;
}
.chart-card::before {
  content: "";
  position: absolute;
  inset: 0;
  background:
    radial-gradient(circle at -10% -20%, var(--coral-light), transparent 60%),
    radial-gradient(circle at 110% 120%, rgba(255, 230, 230, 0.9), transparent 55%);
  opacity: 0.7;
  z-index: -1;
}
.chart-card:hover {
  transform: translateY(-4px) rotateZ(-0.3deg);
  box-shadow: 0 1rem 2.5rem rgba(255, 107, 107, 0.25);
}

.page-pill {
  background: #ffede6;
  color: var(--coral-main);
  font-size: 0.8rem;
  font-weight: 700;
  letter-spacing: 0.05em;
  text-transform: uppercase;
  padding: 0.3rem 0.8rem;
  border-radius: 999px;
  white-space: nowrap;
}

.aa-toggle-pill {
  font-family: 'Fredoka', 'Nunito', sans-serif;
  font-weight: 600;
  background-color: #fcece4;
  border: none;
  color: var(--coral-dark);
  font-size: 0.9rem;
  padding: 0.3rem 0.7rem;
  border-radius: 999px !important;
  margin: 0 2px;
  transition: all 0.2s;
}
.aa-toggle-pill.active {
  background-color: var(--coral-main);
  color: var(--paper);
  box-shadow: 0 2px 4px rgba(255, 107, 107, 0.4);
}
.aa-toggle-group .btn {
  border-radius: 999px !important;
}

.chart-box {
  height: 250px;
}
@media (min-width: 768px) {
  .chart-box {
    height: 300px;
  }
}
</style>
{% endblock %}