{% extends "base2.html" %}
{% block title %}Class Analytics · EduWeaver Admin{% endblock %}

{% block content %}
<div class="container mt-4 admin-analytics">
  <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
    <div>
      <h3 class="fw-bold mb-1 text-aa-heading">
        Class Analytics
      </h3>
      <p class="text-aa-muted mb-0">
        Compare L1 vs L2 learners and drill down into a single student.
      </p>
    </div>
    <div class="badge bg-aa-pill text-wrap">
      <span class="me-1">●</span> Teacher view
    </div>
  </div>

  <!-- Nav Tabs -->
  <ul class="nav nav-tabs mb-3 aa-nav-tabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="tab-overview-tab"
              data-bs-toggle="tab" data-bs-target="#tab-overview"
              type="button" role="tab" aria-controls="tab-overview"
              aria-selected="true">
        L1 vs L2 Overview
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="tab-student-tab"
              data-bs-toggle="tab" data-bs-target="#tab-student"
              type="button" role="tab" aria-controls="tab-student"
              aria-selected="false">
        Single Student
      </button>
    </li>
  </ul>

  <div class="tab-content">
    <!-- ===================== TAB 1: OVERVIEW ===================== -->
    <div class="tab-pane fade show active" id="tab-overview" role="tabpanel"
         aria-labelledby="tab-overview-tab">

      <!-- CHART ROW: L1 vs L2 -->
      <div class="row g-3 mb-4">
        <div class="col-md-6">
          <div class="card border-0 shadow-sm aa-card h-100">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="fw-bold mb-0">Assignments · L1 vs L2</h6>
                <span class="small text-aa-muted">Avg score & completion</span>
              </div>
              <canvas id="aaAssignmentsChart" height="180"></canvas>
            </div>
          </div>
        </div>

        <div class="col-md-6">
          <div class="card border-0 shadow-sm aa-card h-100">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="fw-bold mb-0">Practice · L1 vs L2</h6>
                <span class="small text-aa-muted">Scramble & dictionary</span>
              </div>
              <canvas id="aaPracticeChart" height="180"></canvas>
            </div>
          </div>
        </div>
      </div>
      <!-- END CHART ROW -->

      <div class="row g-3 mb-3">
        {% for g in group_list %}
        <div class="col-md-6">
          <div class="card border-0 shadow-sm aa-card h-100">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <div>
                  <div class="badge aa-pill-label">
                    {{ g.code }}
                  </div>
                  <h5 class="fw-bold mb-1">{{ g.label }}</h5>
                  <div class="small text-aa-muted">
                    {{ g.student_count }} student{{ g.student_count != 1 and 's' or '' }}
                  </div>
                </div>
                <div class="aa-big-number text-end">
                  {% if g.assignments_avg_score %}
                  {{ "%.1f"|format(g.assignments_avg_score) }}%
                  {% else %}
                  –
                  {% endif %}
                  <div class="aa-big-caption">Avg. Assignment Score</div>
                </div>
              </div>

              <div class="row g-3 small mt-1">
                <div class="col-6">
                  <div class="aa-metric-label">Assignments</div>
                  <div class="d-flex align-items-center justify-content-between">
                    <span class="fw-semibold">
                      {{ g.assignments_completed }}/{{ g.assignments_total }}
                    </span>
                    <span class="text-aa-muted">
                      {% if g.assignments_total %}
                        {{ "%.0f"|format(100 * g.assignments_completed / g.assignments_total) }}% completed
                      {% else %}
                        No data
                      {% endif %}
                    </span>
                  </div>
                  <div class="progress aa-progress mt-1">
                    <div class="progress-bar aa-progress-bar"
                         role="progressbar"
                         style="width: {{ g.assignments_total and (100 * g.assignments_completed / g.assignments_total) or 0 }}%"
                         aria-valuenow="{{ g.assignments_total and (100 * g.assignments_completed / g.assignments_total) or 0 }}"
                         aria-valuemin="0" aria-valuemax="100"></div>
                  </div>
                  <div class="small text-aa-muted mt-1">
                    Avg attempts: {{ "%.1f"|format(g.assignments_avg_attempts or 0) }}
                  </div>
                </div>

                <div class="col-6">
                  <div class="aa-metric-label">Word Scramble</div>
                  <div class="d-flex align-items-center justify-content-between">
                    <span class="fw-semibold">{{ g.scramble_sessions }}</span>
                    <span class="text-aa-muted">
                      {% if g.scramble_total_questions %}
                        {{ "%.1f"|format(g.scramble_accuracy) }}% correct
                      {% else %}
                        No sessions yet
                      {% endif %}
                    </span>
                  </div>
                  <div class="progress aa-progress mt-1">
                    <div class="progress-bar aa-progress-bar-soft"
                         role="progressbar"
                         style="width: {{ g.scramble_accuracy or 0 }}%"
                         aria-valuenow="{{ g.scramble_accuracy or 0 }}"
                         aria-valuemin="0" aria-valuemax="100"></div>
                  </div>
                  <div class="small text-aa-muted mt-1">
                    Correct: {{ g.scramble_total_correct }}/{{ g.scramble_total_questions }}
                  </div>
                </div>
              </div>

              <hr class="my-3">

              <div class="row g-3 small">
                <div class="col-6">
                  <div class="aa-metric-label mb-1">Dictionary Lookups</div>
                  <div class="fw-semibold">{{ g.dict_lookups }}</div>
                  <div class="text-aa-muted">
                    Across {{ g.student_count or 0 }} student{{ g.student_count != 1 and 's' or '' }}
                  </div>
                </div>
                <div class="col-6">
                  <div class="aa-metric-label mb-1">Top Keywords</div>
                  {% if g.top_queries %}
                    <ul class="aa-keyword-list">
                      {% for q in g.top_queries %}
                      <li>
                        <span class="aa-keyword">{{ q.query }}</span>
                        <span class="aa-keyword-count">{{ q.cnt }}</span>
                      </li>
                      {% endfor %}
                    </ul>
                  {% else %}
                    <div class="text-aa-muted fst-italic">No lookups yet.</div>
                  {% endif %}
                </div>
              </div>

            </div>
          </div>
        </div>
        {% endfor %}
      </div>

      <div class="alert alert-light border-aa-soft mt-2 small" role="alert">
        Hint: You can encourage more L2 students to use the dictionary during reading activities,
        or assign extra scramble sessions if accuracy is low.
      </div>
    </div>

    <!-- ===================== TAB 2: SINGLE STUDENT ===================== -->
    <div class="tab-pane fade" id="tab-student" role="tabpanel"
         aria-labelledby="tab-student-tab">

      <form method="get" action="{{ url_for('admin_analytics') }}"
            class="row g-2 align-items-end mb-3">
        <div class="col-md-4">
          <label class="form-label small text-aa-muted">Select student</label>
          <select name="user_id" class="form-select">
            {% for s in students %}
            <option value="{{ s.id }}"
                    {% if selected_user and s.id == selected_user.id %}selected{% endif %}>
              {{ s.username }}{% if s.is_english_native == 1 %} · L1{% elif s.is_english_native == 0 %} · L2{% endif %}
            </option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-2">
          <button type="submit" class="btn btn-aa w-100">View</button>
        </div>
      </form>

      {% if not selected_user %}
      <div class="alert alert-warning small">
        No students found yet. Ask students to register first.
      </div>
      {% else %}
      <div class="row g-3">
        <!-- Student summary card -->
        <div class="col-lg-4">
          <div class="card border-0 shadow-sm aa-card h-100">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <div class="badge aa-pill-label">
                    {{ selected_user.username }}
                  </div>
                  <h5 class="fw-bold mb-1">
                    {{ selected_user.username }}
                  </h5>
                  <div class="small text-aa-muted">
                    {{ selected_user.email }}
                  </div>
                  <div class="small text-aa-muted mt-1">
                    Group:
                    {% if selected_user.is_english_native == 1 %}
                      L1 · Native English
                    {% elif selected_user.is_english_native == 0 %}
                      L2 · Non-native
                    {% else %}
                      Not set
                    {% endif %}
                  </div>
                </div>
              </div>

              {% if student_assign_stats %}
              <hr class="my-3">
              <div class="small">
                <div class="aa-metric-label">Assignments</div>
                <div class="fw-semibold">
                  {{ student_assign_stats.total }} total,
                  {{ student_assign_stats.completed }} submitted
                </div>
                <div class="text-aa-muted">
                  Avg score:
                  {% if student_assign_stats.avg_score %}
                    {{ "%.1f"|format(student_assign_stats.avg_score) }}%
                  {% else %}
                    –
                  {% endif %}
                  · Avg attempts:
                  {{ "%.1f"|format(student_assign_stats.avg_attempts or 0) }}
                </div>

                {% if student_assign_stats.by_type %}
                <div class="mt-2">
                  {% for t, info in student_assign_stats.by_type.items() %}
                  <div class="d-flex justify-content-between">
                    <span class="text-aa-muted">
                      {{ t|capitalize }}
                    </span>
                    <span>
                      {{ info.completed }}/{{ info.count }} submitted
                    </span>
                  </div>
                  {% endfor %}
                </div>
                {% endif %}
              </div>
              {% else %}
              <hr class="my-3">
              <div class="small text-aa-muted">
                No assignments for this student yet.
              </div>
              {% endif %}

              {% if student_scramble_summary %}
              <hr class="my-3">
              <div class="small">
                <div class="aa-metric-label">Word Scramble</div>
                <div class="fw-semibold">
                  {{ student_scramble_summary.sessions }} session{{ student_scramble_summary.sessions != 1 and 's' or '' }}
                </div>
                <div class="text-aa-muted">
                  Correct: {{ student_scramble_summary.total_correct }}/{{ student_scramble_summary.total_questions }}
                  {% if student_scramble_summary.total_questions %}
                    ({{ "%.1f"|format(student_scramble_summary.accuracy) }}%)
                  {% endif %}
                </div>
              </div>
              {% endif %}
            </div>
          </div>
        </div>

        <!-- Assignments list -->
        <div class="col-lg-4">
          <div class="card border-0 shadow-sm aa-card h-100">
            <div class="card-body">
              <h6 class="fw-bold mb-2">Recent Assignments</h6>
              {% if student_assign_list %}
              <div class="aa-list small">
                {% for a in student_assign_list[:8] %}
                <div class="aa-list-row">
                  <div>
                    <div class="fw-semibold">
                      {{ a.assignment_title or "Untitled" }}
                    </div>
                    <div class="text-aa-muted">
                      Type: {{ a.assignment_type or "?" }} ·
                      {% if a.status == "submitted" %}
                        Submitted
                      {% else %}
                        Pending
                      {% endif %}
                    </div>
                  </div>
                  <div class="text-end">
                    {% if a.score is not none %}
                      <div class="fw-semibold">
                        {{ "%.0f"|format(a.score) }}%
                      </div>
                    {% else %}
                      <div class="text-aa-muted">–</div>
                    {% endif %}
                    <div class="text-aa-muted">
                      tries: {{ a.attempt_count or 0 }}
                    </div>
                  </div>
                </div>
                {% endfor %}
              </div>
              {% else %}
              <div class="small text-aa-muted">
                No assignments recorded.
              </div>
              {% endif %}
            </div>
          </div>
        </div>

        <!-- Dict & scramble sessions -->
        <div class="col-lg-4">
          <div class="card border-0 shadow-sm aa-card h-100">
            <div class="card-body">
              <h6 class="fw-bold mb-2">Dictionary & Scramble Details</h6>

              <div class="small mb-3">
                <div class="aa-metric-label mb-1">Recent Dictionary Lookups</div>
                {% if student_lookups %}
                <ul class="aa-keyword-list">
                  {% for l in student_lookups %}
                  <li class="justify-content-between">
                    <span class="aa-keyword">{{ l.query }}</span>
                    <span class="aa-keyword-count">
                      {{ l.created_at|dt("%m-%d") }}
                    </span>
                  </li>
                  {% endfor %}
                </ul>
                {% else %}
                <div class="text-aa-muted fst-italic">
                  No lookups yet.
                </div>
                {% endif %}
              </div>

              {% if student_scramble_sessions %}
              <div class="small">
                <div class="aa-metric-label mb-1">Last Scramble Sessions</div>
                <div class="aa-list small">
                  {% for s in student_scramble_sessions %}
                  <div class="aa-list-row">
                    <div>
                      <div class="text-aa-muted">
                        Session #{{ s.id }}
                      </div>
                    </div>
                    <div class="text-end">
                      <div>
                        {{ s.correct_count }}/{{ s.total }} correct
                      </div>
                    </div>
                  </div>
                  {% endfor %}
                </div>
              </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<style>
/* Palette: soft peach/orange, matching EduWeaverPlay */
.admin-analytics {
  font-family: "Nunito", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
}

.text-aa-heading { color: #402b2b; }
.text-aa-muted   { color: #8b8b9b; }

.badge.bg-aa-pill{
  background: #ffe2c8;
  color: #7a4130;
  border-radius: 999px;
  font-weight: 600;
}

/* Tabs */
.aa-nav-tabs .nav-link{
  border: none;
  border-bottom: 2px solid transparent;
  font-weight: 600;
  color: #b38064;
}
.aa-nav-tabs .nav-link.active{
  color: #f97316;
  border-color: #f97316;
  background-color: #fff7ec;
}

/* Cards */
.aa-card{
  border-radius: 18px;
  background: #ffffff;
  border: 1px solid #f3e1d4;
}
.border-aa-soft{
  border-color: #f3e1d4 !important;
}

/* Main metric */
.aa-big-number{
  font-size: 1.8rem;
  font-weight: 800;
  color: #f97316;
}
.aa-big-caption{
  font-size: 0.75rem;
  color: #a78b7c;
  text-transform: uppercase;
  letter-spacing: .08em;
}

/* Labels / text */
.aa-metric-label{
  font-size: 0.75rem;
  text-transform: uppercase;
  letter-spacing: .08em;
  color: #a78b7c;
}

/* Progress bars */
.aa-progress{
  height: 6px;
  background-color: #ffe9d7;
  border-radius: 999px;
}
.aa-progress-bar{
  background: linear-gradient(90deg, #f97316, #fb923c);
}
.aa-progress-bar-soft{
  background: linear-gradient(90deg, #fbbf24, #f97316);
}

/* Pill for L1/L2 labels */
.aa-pill-label{
  background: #fff1df;
  color: #b45309;
  border-radius: 999px;
  padding: 0.1rem .6rem;
  font-size: 0.7rem;
}

/* Keyword chips */
.aa-keyword-list{
  list-style: none;
  padding-left: 0;
  margin: 0;
}
.aa-keyword-list li{
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: .4rem;
  padding: .2rem 0;
  font-size: .85rem;
}
.aa-keyword{
  background: #fff7ed;
  border-radius: 999px;
  padding: 0.15rem .6rem;
  border: 1px solid #fed7aa;
}
.aa-keyword-count{
  font-size: 0.75rem;
  color: #a78b7c;
}

/* Simple list rows */
.aa-list{
  border-top: 1px dashed #f4d2b8;
}
.aa-list-row{
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  gap: .5rem;
  padding: .4rem 0;
  border-bottom: 1px dashed #f4d2b8;
}
.btn-aa{
  background-color: #f97316;
  color: #fff;
  border-radius: 999px;
  border: none;
}
.btn-aa:hover{
  background-color: #ea580c;
  color: #fff;
}
</style>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(function() {
  // We know group_list[0] = L1, group_list[1] = L2 from the view
  const l1 = {
    avgScore: {{ group_list[0].assignments_avg_score or 0 }},
    completed: {{ group_list[0].assignments_completed or 0 }},
    totalAssign: {{ group_list[0].assignments_total or 0 }},
    scrambleAccuracy: {{ group_list[0].scramble_accuracy or 0 }},
    dictLookups: {{ group_list[0].dict_lookups or 0 }},
    studentCount: {{ group_list[0].student_count or 0 }}
  };
  const l2 = {
    avgScore: {{ group_list[1].assignments_avg_score or 0 }},
    completed: {{ group_list[1].assignments_completed or 0 }},
    totalAssign: {{ group_list[1].assignments_total or 0 }},
    scrambleAccuracy: {{ group_list[1].scramble_accuracy or 0 }},
    dictLookups: {{ group_list[1].dict_lookups or 0 }},
    studentCount: {{ group_list[1].student_count or 0 }}
  };

  const labels = ['L1', 'L2'];

  // Helpers
  function completionPct(group) {
    return group.totalAssign ? (100 * group.completed / group.totalAssign) : 0;
  }
  function avgLookupsPerStudent(group) {
    return group.studentCount ? (group.dictLookups / group.studentCount) : 0;
  }

  // --- Assignments chart ---
  const assignCtx = document.getElementById('aaAssignmentsChart');
  if (assignCtx) {
    new Chart(assignCtx.getContext('2d'), {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [
          {
            label: 'Avg score (%)',
            data: [l1.avgScore, l2.avgScore],
            backgroundColor: '#f97316'
          },
          {
            label: 'Completion (%)',
            data: [completionPct(l1), completionPct(l2)],
            backgroundColor: '#fed7aa'
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            labels: { color: '#7a5540', font: { size: 11 } }
          }
        },
        scales: {
          x: {
            ticks: { color: '#b38064' },
            grid: { display: false }
          },
          y: {
            beginAtZero: true,
            max: 100,
            ticks: { color: '#b38064' },
            grid: { color: '#ffe9d7' }
          }
        }
      }
    });
  }

  // --- Practice chart (scramble + dict) ---
  const practiceCtx = document.getElementById('aaPracticeChart');
  if (practiceCtx) {
    new Chart(practiceCtx.getContext('2d'), {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [
          {
            label: 'Scramble accuracy (%)',
            data: [l1.scrambleAccuracy, l2.scrambleAccuracy],
            backgroundColor: '#fb923c'
          },
          {
            label: 'Avg dict lookups / student',
            data: [avgLookupsPerStudent(l1), avgLookupsPerStudent(l2)],
            backgroundColor: '#facc15'
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            labels: { color: '#7a5540', font: { size: 11 } }
          }
        },
        scales: {
          x: {
            ticks: { color: '#b38064' },
            grid: { display: false }
          },
          y: {
            beginAtZero: true,
            ticks: { color: '#b38064' },
            grid: { color: '#ffe9d7' }
          }
        }
      }
    });
  }
})();
</script>
{% endblock %}
