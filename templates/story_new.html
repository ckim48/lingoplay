{% extends "base2.html" %}
{% block title %}AI Story Generator · LexiTale{% endblock %}

{% block content %}
<style>
  /* --- Original Design Variables & Typography --- */
  @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&family=Nunito:wght@400;600&family=Baloo+2:wght@500;700&display=swap');

  :root {
    --sun-50: #fff9e6;
    --sun-300: #ffd569;
    --coral-500: #ff6b6b;
    --teal-300: #7ad3c8;
    --teal-500: #22b3aa;
    --lp-border: #e5eaf3;
    /* Helper for the new toggle border */
    --coral-light: #ffd7cc;
  }

  body {
    font-family: 'Fredoka', 'Nunito', system-ui, -apple-system, sans-serif;
    background: radial-gradient(circle at top, #fffaf3 0, #fffdf8 40%, #ffffff 100%);
  }

  /* Titles & Text */
  .main-story-title {
    font-family: "Baloo 2", system-ui;
    font-weight: 700 !important;
    font-size: clamp(1.8rem, 3.5vw, 2.8rem);
    color: #333;
  }
  .lead-subtext {
    font-size: 1.15rem;
    color: #6b7280 !important;
  }
  .story-text-body {
    font-family: 'Fredoka', 'Nunito', sans-serif;
    font-weight: 400;
  }
  .story-inner {
    max-width: 720px;
  }

  /* Cards & Shell */
  .story-shell {
    background: #fffaf3;
    position: relative;
  }
  .lp-card-modern {
    border-radius: 28px;
    background: radial-gradient(circle at top, #fffaf3 0, #fffdf8 40%, #ffffff 100%);
  }
  .step-card {
    border-radius: 20px;
    background: #fffdf6;
    border: 2px solid rgba(254, 215, 170, .9);
    box-shadow: 0 4px 10px rgba(148, 163, 184, .15);
  }

  /* Wizard Steps */
  .step-label {
    font-size: .9rem;
    font-weight: 600;
    color: #475569;
    margin-bottom: 0.25rem;
  }
  .wizard-dot {
    width: 44px; height: 44px;
    border-radius: 999px;
    border: 3px solid var(--lp-border);
    display: flex; align-items: center; justify-content: center;
    font-size: 1.2rem; font-weight: 700; color: #9ca3af;
    background: #fff;
    transition: .18s ease;
  }
  .wizard-dot.active {
    border-color: var(--coral-500);
    background: var(--sun-50);
    color: var(--coral-500);
  }
  .wizard-dot.completed {
    background: var(--teal-500);
    border-color: var(--teal-500);
    color: #fff;
  }
  .wizard-line {
    height: 4px;
    background: var(--lp-border);
    border-radius: 999px;
    transition: .2s ease;
  }
  .wizard-line.filled {
    background: linear-gradient(90deg, var(--sun-300), var(--teal-500));
  }
  .wizard-item {
    display: flex; flex-direction: column; align-items: center;
  }
  .wizard-item-center { min-width: 100px; }
  .wizard-label {
    font-family: 'Fredoka', 'Nunito', sans-serif;
    font-size: 0.95rem; font-weight: 500; white-space: nowrap;
  }

  /* Inputs */
  .lp-input .input-group-text {
    border-radius: 1.25rem 0 0 1.25rem;
    background: #f1f5f9;
    color: var(--coral-500);
    font-size: 1.25rem;
  }
  .lp-input .form-control,
  .lp-input .form-select {
    border-radius: 1.25rem;
    padding: 0.6rem 1rem;
    font-size: 1.1rem;
  }
  .lp-input .form-control {
    border-radius: 0 1.25rem 1.25rem 0;
  }

  /* Buttons */
  .btn-rand {
    border-radius: 0 1.25rem 1.25rem 0;
    border: 0;
    background: var(--sun-300);
    color: #1f2937;
    font-weight: 700;
    padding: 0 .95rem;
    display: flex; align-items: center; gap: .25rem;
    transition: transform .15s ease, filter .15s ease;
  }
  .btn-rand:hover { transform: translateY(-1px); filter: brightness(.98); }
  .btn-rand:active { transform: translateY(0); }

  .btn-sky-solid {
    background: var(--coral-500);
    border-color: var(--coral-500);
    border-radius: 999px;
    box-shadow: 0 8px 18px rgba(255, 107, 107, .35);
    font-family: "Baloo 2", system-ui;
    font-weight: 700;
    color: white;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }
  .btn-sky-solid:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 20px rgba(255, 107, 107, .45);
  }
  .btn-outline-secondary {
    border-radius: 999px;
    font-weight: 600;
  }
  .btn-lg {
    padding: 0.75rem 1.5rem;
    font-size: 1.1rem;
  }

  /* Loading Overlay */
  .gen-overlay {
    position: fixed; inset: 0;
    display: grid; place-items: center;
    background: rgba(15, 23, 42, .45);
    backdrop-filter: blur(5px);
    z-index: 2000;
    opacity: 0; visibility: hidden;
    transition: opacity 0.3s;
  }
  .gen-overlay[aria-hidden="false"] {
    opacity: 1; visibility: visible;
  }
  .rainbow-spinner-box {
    text-align: center;
    padding: 2.5rem 3rem;
    border-radius: 1.5rem;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
  }
  .rainbow-spinner {
    width: 80px; height: 80px;
    border: 10px solid transparent;
    border-top-color: #ff6b6b;
    border-right-color: #ffd93d;
    border-bottom-color: #6bcb77;
    border-left-color: #4d96ff;
    animation: rainbowSpin 1.1s linear infinite;
    box-shadow: 0 6px 16px rgba(0, 0, 0, .3);
  }
  @keyframes rainbowSpin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  .rainbow-text {
    text-shadow: 0 2px 8px rgba(0, 0, 0, .45);
    font-family: 'Baloo 2', cursive;
  }

  /* Specific Styles for the new Toggle (Integrated with original design) */
  .border-dashed { border-style: dashed !important; }
  .border-coral-light { border-color: var(--coral-light) !important; }
  .text-coral-500 { color: var(--coral-500) !important; }
</style>

<div class="card border-0 lp-card-modern overflow-hidden mt-4 story-shell">
  <div class="card-body p-3 p-md-4 p-lg-5 position-relative">
    <div class="story-inner mx-auto">

      <div class="mb-4">
        <h1 class="mb-1 fw-semibold main-story-title">AI Story Generator</h1>
        <p class="text-muted story-text-body lead-subtext mb-0">Make a story together in three tiny steps.</p>
      </div>

      <form method="post" id="storyForm">
        <input type="hidden" name="language" value="en">

        <div class="wizard-indicator d-flex align-items-center justify-content-between mb-3 mb-md-4">
          <div class="wizard-item text-center">
            <div class="wizard-dot active"><span>1</span></div>
            <div class="wizard-label mt-1">Basics</div>
          </div>
          <div class="wizard-line flex-grow-1 mx-1 mx-md-2"></div>
          <div class="wizard-item text-center wizard-item-center">
            <div class="wizard-dot"><span>2</span></div>
            <div class="wizard-label mt-1">Story Setup</div>
          </div>
          <div class="wizard-line flex-grow-1 mx-1 mx-md-2"></div>
          <div class="wizard-item text-center">
            <div class="wizard-dot"><span>3</span></div>
            <div class="wizard-label mt-1">Options</div>
          </div>
        </div>

        <div class="wizard-step" data-step="1">
          <div class="step-card p-3 p-md-4 mb-2">
            <div class="mb-3">
              <label class="form-label step-label">Title</label>
              <div class="input-group input-group-lg lp-input">
                <span class="input-group-text"><i class="bi bi-journal-text"></i></span>
                <input name="title" class="form-control" placeholder="Story title" required>
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label step-label">Author</label>
              <div class="input-group input-group-lg lp-input">
                <span class="input-group-text"><i class="bi bi-person"></i></span>
                <input name="author_name" class="form-control" placeholder="Name">
              </div>
            </div>
            <div class="mt-3">
              <label class="form-label step-label">Phonics / Vocabulary</label>
              <div class="input-group input-group-lg lp-input">
                <span class="input-group-text"><i class="bi bi-mic"></i></span>
                <input id="phonicsInput" name="prompt" class="form-control" placeholder="e.g., sh, ship" required>
                <button type="button" class="btn btn-rand" id="randPhonicsBtn">
                  <i class="bi bi-shuffle me-1"></i> Random
                </button>
              </div>
              <div class="form-text text-muted story-text-body mt-1">
                Tap Random for a quick phonics/word idea for young learners.
              </div>
            </div>
          </div>
        </div>

        <div class="wizard-step d-none" data-step="2">
          <div class="step-card p-3 p-md-4 mb-2">
            <div class="mb-3">
              <label class="form-label step-label">English Level</label>
              <select name="english_level" class="form-select form-select-lg lp-input">
                <option value="beginner" selected>Beginner</option>
                <option value="intermediate">Intermediate</option>
                <option value="advanced">Advanced</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label step-label">Story Type</label>
              <select name="story_type" class="form-select form-select-lg lp-input">
                <option value="adventure" selected>Adventure</option>
                <option value="everyday-life">Everyday life</option>
                <option value="feelings">Feelings / emotions</option>
                <option value="mystery">Mystery / puzzle</option>
                <option value="fantasy">Fantasy / magic</option>
                <option value="school-life">School life</option>
              </select>
            </div>
            <div class="mt-3">
              <label class="form-label step-label">Share To</label>
              <select name="share_class_id" class="form-select form-select-lg lp-input">
                <option value="" selected>All (Library)</option>
                {% if my_classes %}
                  {% for c in my_classes %}
                    <option value="{{ c.id }}">{{ c.name }}</option>
                  {% endfor %}
                {% endif %}
              </select>
            </div>
          </div>
        </div>

        <div class="wizard-step d-none" data-step="3">
          <div class="step-card p-3 p-md-4 mb-2">
            <div class="mb-3">
              <label class="form-label step-label">Emotion Tone</label>
              <select name="emotion_tone" class="form-select form-select-lg lp-input">
                <option value="warm-and-happy" selected>Warm and happy</option>
                <option value="calm-and-peaceful">Calm and peaceful</option>
                <option value="excited-and-fun">Excited and fun</option>
                <option value="worried-but-hopeful">A little worried but hopeful</option>
                <option value="brave-and-growing">Brave and growing</option>
              </select>
            </div>
            <div class="mb-4">
              <label class="form-label step-label">Tense</label>
              <select name="tense" class="form-select form-select-lg lp-input">
                <option value="present-simple" selected>Present simple (e.g., He walks)</option>
                <option value="past-simple">Past simple (e.g., He walked)</option>
                <option value="present-progressive">Present progressive (e.g., He is walking)</option>
              </select>
            </div>

            <hr class="my-4" style="opacity: 0.1; border-color: var(--coral-500);">

            <div class="p-3 rounded-4 border-2 border-dashed border-coral-light bg-white">
              <div class="form-check form-switch d-flex align-items-center gap-3 p-0">
                <div class="flex-grow-1">
                  <label class="form-check-label fw-bold d-block mb-1" for="genImagesMode" style="color:#333;">
                    <i class="bi bi-images me-1 text-coral-500"></i> Full Illustration Mode
                  </label>
                  <small class="text-muted">Generate a unique picture for every page of the story instead of just the cover.</small>
                </div>
                <input class="form-check-input ms-0" type="checkbox" name="gen_images_mode" value="all" id="genImagesMode" style="width: 3em; height: 1.5em; cursor: pointer;">
              </div>
              <div class="mt-2 p-2 rounded-3 bg-light border small text-muted">
                <i class="bi bi-info-circle me-1"></i> <strong>Note:</strong> Generating all pages takes about 30–60 seconds to finish.
              </div>
            </div>

          </div>
        </div>

        <div class="d-flex flex-wrap gap-2 justify-content-end mt-3 mt-md-4">
          <button type="button" class="btn btn-outline-secondary btn-lg px-4" id="wizardPrev" disabled>
            <i class="bi bi-arrow-left-short me-1"></i> Back
          </button>
          <button type="button" class="btn btn-sky-solid btn-lg px-4" id="genBtn">
            <span class="label-next">Next <i class="bi bi-arrow-right-short ms-1"></i></span>
            <span class="label-generate d-none">Generate <i class="bi bi-stars ms-1"></i></span>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<div id="genOverlay" class="gen-overlay" aria-hidden="true">
  <div class="rainbow-spinner-box">
    <div class="rainbow-spinner"></div>
    <h6 class="mt-3 fw-semibold text-white rainbow-text main-story-title">Creating your story...</h6>
    <p class="text-white-50 small mb-0 mt-2" id="loaderSubtext">This usually takes about few minutes.</p>
  </div>
</div>

<script>
(function(){
  const form = document.getElementById('storyForm');
  const overlay = document.getElementById('genOverlay');
  const genBtn = document.getElementById('genBtn');
  const prevBtn = document.getElementById('wizardPrev');
  const loaderSubtext = document.getElementById('loaderSubtext');
  const imageToggle = document.getElementById('genImagesMode');

  const steps = Array.from(document.querySelectorAll('.wizard-step'));
  const dots  = Array.from(document.querySelectorAll('.wizard-dot'));
  const lines = Array.from(document.querySelectorAll('.wizard-line'));

  const labelNext     = genBtn.querySelector('.label-next');
  const labelGenerate = genBtn.querySelector('.label-generate');

  let current = 0;

  function update(){
    steps.forEach((step,i)=> step.classList.toggle('d-none', i!==current));
    dots.forEach((dot,i)=>{
      dot.classList.toggle('active', i===current);
      dot.classList.toggle('completed', i<current);
    });
    lines.forEach((line,i)=> line.classList.toggle('filled', i<current));

    prevBtn.disabled = current===0;

    const last = current===steps.length-1;
    labelNext.classList.toggle('d-none', last);
    labelGenerate.classList.toggle('d-none', !last);
  }

  genBtn.addEventListener('click', () => {
    if (current === steps.length - 1) {
      // Final Step: Validation & Submit
      if (form.checkValidity()) {
        // Update loading text based on toggle
        if (imageToggle && imageToggle.checked) {
          loaderSubtext.innerText = "Drawing all pages... this takes about few minutes.";
        } else {
          loaderSubtext.innerText = "This usually takes about few minutes.";
        }

        // Show overlay & submit
        genBtn.disabled = true;
        overlay.setAttribute('aria-hidden', 'false');
        form.submit();
      } else {
        form.reportValidity();
      }
    } else {
      // Go to next step
      current++;
      update();
    }
  });

  prevBtn.addEventListener('click', ()=>{
    if(current > 0){
      current--;
      update();
    }
  });

  // --- Random Phonics Logic ---
  const phonicsInput = document.getElementById('phonicsInput');
  const randBtn = document.getElementById('randPhonicsBtn');
  const levelSelect = document.querySelector('select[name="english_level"]');

  const POOL = {
    beginner: ["a, at", "i, it", "o, on", "sh, ship", "ch, chip", "at, cat", "sun", "hat"],
    intermediate: ["ai, rain", "ee, sheep", "oa, boat", "ar, star", "blend: tr, tree", "because", "together"],
    advanced: ["tion, action", "ph, phone", "kn, knight", "ough, though", "curious", "discovery"]
  };

  if(randBtn){
    randBtn.addEventListener('click', () => {
      const lvl = levelSelect.value || "beginner";
      const list = POOL[lvl] || POOL.beginner;
      phonicsInput.value = list[Math.floor(Math.random() * list.length)];
      phonicsInput.focus();
    });
  }

  update();
})();
</script>
{% endblock %}