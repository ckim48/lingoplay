{% extends "base2.html" %}
{% block title %}AI Story Generator Â· EduWeaverPlay{% endblock %}

{% block content %}

<div class="card border-0 lp-card-modern overflow-hidden mt-4 story-shell">
  <div class="card-body p-3 p-md-4 p-lg-5 position-relative">
    <div class="story-inner mx-auto">

      <div class="mb-4">
        <h1 class="mb-1 fw-semibold main-story-title">AI Story Generator</h1>
        <p class="text-muted story-text-body lead-subtext mb-0">Make a story together in three tiny steps.</p>
      </div>

      <form method="post" id="storyForm">
        <input type="hidden" name="language" value="en">

        <!-- Wizard indicator -->
        <div class="wizard-indicator d-flex align-items-center justify-content-between mb-3 mb-md-4">
          <div class="wizard-item text-center">
            <div class="wizard-dot active"><span>1</span></div>
            <div class="wizard-label mt-1">Basics</div>
          </div>

          <div class="wizard-line flex-grow-1 mx-1 mx-md-2"></div>

          <div class="wizard-item text-center wizard-item-center">
            <div class="wizard-dot"><span>2</span></div>
            <div class="wizard-label mt-1">Story Setup</div>
          </div>

          <div class="wizard-line flex-grow-1 mx-1 mx-md-2"></div>

          <div class="wizard-item text-center">
            <div class="wizard-dot"><span>3</span></div>
            <div class="wizard-label mt-1">Options</div>
          </div>
        </div>

        <!-- STEP 1: ONE INPUT PER ROW -->
        <div class="wizard-step" data-step="1">
          <div class="step-card p-3 p-md-4 mb-2">
            <!-- Title -->
            <div class="mb-3">
              <label class="form-label step-label">Title</label>
              <div class="input-group input-group-lg lp-input">
                <span class="input-group-text"><i class="bi bi-journal-text"></i></span>
                <input name="title" class="form-control" placeholder="Story title">
              </div>
            </div>

            <!-- Author -->
            <div class="mb-3">
              <label class="form-label step-label">Author</label>
              <div class="input-group input-group-lg lp-input">
                <span class="input-group-text"><i class="bi bi-person"></i></span>
                <input name="author_name" class="form-control" placeholder="Name">
              </div>
            </div>

            <!-- Phonics / Vocabulary -->
            <div class="mt-3">
              <label class="form-label step-label">Phonics / Vocabulary</label>
              <div class="input-group input-group-lg lp-input">
                <span class="input-group-text"><i class="bi bi-mic"></i></span>
                <input name="prompt" class="form-control" placeholder="e.g., sh, ship">
              </div>
            </div>
          </div>
        </div>

        <!-- STEP 2: ONE SELECT PER ROW -->
        <div class="wizard-step d-none" data-step="2">
          <div class="step-card p-3 p-md-4 mb-2">
            <!-- English Level -->
            <div class="mb-3">
              <label class="form-label step-label">
                English Level (for young students)
              </label>
              <select name="english_level" class="form-select form-select-lg lp-input">
                <option value="beginner" selected>Beginner</option>
                <option value="intermediate">Intermediate</option>
                <option value="advanced">Advanced</option>
              </select>
            </div>

            <!-- Story Type -->
            <div class="mb-3">
              <label class="form-label step-label">
                Story Type
              </label>
              <select name="story_type" class="form-select form-select-lg lp-input">
                <option value="adventure" selected>Adventure</option>
                <option value="everyday-life">Everyday life</option>
                <option value="feelings">Feelings / emotions</option>
                <option value="mystery">Mystery / puzzle</option>
                <option value="fantasy">Fantasy / magic</option>
                <option value="school-life">School life</option>
              </select>
            </div>

            <!-- Setting -->
<!--            <div class="mb-3">-->
<!--              <label class="form-label step-label">-->
<!--                Setting (story background)-->
<!--              </label>-->
<!--              <select name="setting" class="form-select form-select-lg lp-input">-->
<!--                <option value="forest" selected>Forest</option>-->
<!--                <option value="school">School</option>-->
<!--                <option value="seaside">Seaside / beach</option>-->
<!--                <option value="city-park">City park</option>-->
<!--                <option value="home">Home</option>-->
<!--                <option value="space">Space</option>-->
<!--              </select>-->
<!--            </div>-->

            <!-- Main Characters -->
<!--            <div class="mb-3">-->
<!--              <label class="form-label step-label">-->
<!--                Main Characters-->
<!--              </label>-->
<!--              <select name="character_kind" class="form-select form-select-lg lp-input">-->
<!--                <option value="children" selected>Children / students</option>-->
<!--                <option value="animals">Animal friends</option>-->
<!--                <option value="family">Family</option>-->
<!--                <option value="imaginary-friends">Imaginary friends</option>-->
<!--                <option value="mixed">Mixed (people + animals / imaginary)</option>-->
<!--              </select>-->
<!--            </div>-->

            <!-- Emotion Tone -->
            <div class="mb-3">
              <label class="form-label step-label">
                Emotion Tone
              </label>
              <select name="emotion_tone" class="form-select form-select-lg lp-input">
                <option value="warm-and-happy" selected>Warm and happy</option>
                <option value="calm-and-peaceful">Calm and peaceful</option>
                <option value="excited-and-fun">Excited and fun</option>
                <option value="worried-but-hopeful">A little worried but hopeful</option>
                <option value="brave-and-growing">Brave and growing</option>
              </select>
            </div>

            <!-- Tense -->
            <div class="mb-0">
              <label class="form-label step-label">
                Tense
              </label>
              <select name="tense" class="form-select form-select-lg lp-input">
                <option value="present-simple" selected>Present simple (e.g., He walks)</option>
                <option value="past-simple">Past simple (e.g., He walked)</option>
                <option value="present-progressive">Present progressive (e.g., He is walking)</option>
              </select>
            </div>
          </div>
        </div>

        <!-- STEP 3: ONE TOGGLE PER ROW -->
        <div class="wizard-step d-none" data-step="3">
          <div class="step-card p-3 p-md-4 mb-2">
            <div class="row g-3">

              <div class="col-12">
                <div class="toggle-row d-flex align-items-center justify-content-between px-3 py-2">
                  <div class="d-flex align-items-center gap-3">
                    <div class="toggle-icon-wrap">
                      <i class="bi bi-pencil-square"></i>
                    </div>
                    <div>
                      <div class="toggle-title">Student ending</div>
                      <div class="toggle-sub story-text-body">Students write the ending</div>
                    </div>
                  </div>

                  <div class="form-check form-switch lp-switch mb-0">
                    <input class="form-check-input" type="checkbox" id="studentFinish" name="student_finish" value="1" checked>
                  </div>
                </div>
              </div>

              <div class="col-12">
                <div class="toggle-row d-flex align-items-center justify-content-between px-3 py-2">
                  <div class="d-flex align-items-center gap-3">
                    <div class="toggle-icon-wrap toggle-icon-cover">
                      <i class="bi bi-image"></i>
                    </div>
                    <div>
                      <div class="toggle-title">Cover image</div>
                      <div class="toggle-sub story-text-body">Create a kid-friendly cover</div>
                    </div>
                  </div>

                  <div class="form-check form-switch lp-switch mb-0">
                    <input class="form-check-input" type="checkbox" id="genImage" name="gen_image" value="1">
                  </div>
                </div>
              </div>

            </div>
          </div>
        </div>

        <!-- Buttons -->
        <div class="d-flex flex-wrap gap-2 justify-content-end mt-3 mt-md-4">
          <button type="button" class="btn btn-outline-secondary btn-lg px-4" id="wizardPrev" disabled>
            <i class="bi bi-arrow-left-short me-1"></i> Back
          </button>

          <button type="button" class="btn btn-sky-solid btn-lg px-4" id="genBtn">
            <span class="label-next">
              Next <i class="bi bi-arrow-right-short ms-1"></i>
            </span>
            <span class="label-generate d-none">
              Generate <i class="bi bi-stars ms-1"></i>
            </span>
          </button>
        </div>

      </form>
    </div>
  </div>
</div>

<!-- Overlay -->
<div id="genOverlay" class="gen-overlay" aria-hidden="true">
  <div class="rainbow-spinner-box">
    <div class="rainbow-spinner"></div>
    <h6 class="mt-3 fw-semibold text-white rainbow-text main-story-title">Creating your story...</h6>
  </div>
</div>

<!-- Modal -->
<div class="modal fade" id="generatedModal" tabindex="-1" aria-labelledby="generatedModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4">
      <div class="modal-header border-0">
        <h5 class="modal-title main-story-title small-title" id="generatedModalLabel">Story ready!</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body pt-0 story-text-body">
        Your story has been generated. What would you like to do next?
      </div>
      <div class="modal-footer border-0 d-flex flex-wrap gap-2 justify-content-end">
        <a href="{{ url_for('library') }}" class="btn btn-outline-secondary btn-lg">
          Go to Library
        </a>
        <a id="goFinishBtn" href="{{ url_for('index') }}" class="btn btn-sky-solid btn-lg">
          Finish the Story
        </a>
      </div>
    </div>
  </div>
</div>

<style>
@import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&family=Nunito:wght@400;600&family=Baloo+2:wght@500;700&display=swap');

body{
  font-family:'Fredoka', 'Nunito', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  background: radial-gradient(circle at top, #fffaf3 0, #fffdf8 40%, #ffffff 100%);
}

/* Title */
.main-story-title {
  font-family:"Baloo 2", system-ui;
  font-weight: 700 !important;
  font-size: clamp(1.8rem, 3.5vw, 2.8rem);
  color: #333;
}
.lead-subtext {
  font-size: 1.15rem;
  color: #6b7280 !important;
}
.story-title{
  font-family:"Baloo 2", system-ui;
  font-weight: 700 !important;
}
.story-text-body {
  font-family:'Fredoka', 'Nunito', sans-serif;
  font-weight: 400;
}

.story-inner{
  max-width:720px;
}

:root{
  --sun-50:#fff9e6;
  --sun-300:#ffd569;
  --coral-500:#ff6b6b;
  --teal-300:#7ad3c8;
  --teal-500:#22b3aa;
  --lp-border:#e5eaf3;
}

/* Shell */
.story-shell{
  background:#fffaf3;
  position: relative;
}

.lp-card-modern{
  border-radius:28px;
  background:radial-gradient(circle at top, #fffaf3 0, #fffdf8 40%, #ffffff 100%);
}

/* Step card */
.step-card{
  border-radius:20px;
  background:#fffdf6;
  border:2px solid rgba(254,215,170,.9);
  box-shadow:0 4px 10px rgba(148,163,184,.15);
}

/* Labels */
.step-label{
  font-size:.9rem;
  font-weight:600;
  color:#475569;
  margin-bottom: 0.25rem;
}

/* Wizard */
.wizard-dot{
  width:44px;height:44px;
  border-radius:999px;
  border:3px solid var(--lp-border);
  display:flex;align-items:center;justify-content:center;
  font-size:1.2rem;
  font-weight:700;color:#9ca3af;
  background:#fff;
  transition:.18s ease;
}
.wizard-dot.active{
  border-color:var(--coral-500);
  background:var(--sun-50);
  color:var(--coral-500);
}
.wizard-dot.completed{
  background:var(--teal-500);
  border-color:var(--teal-500);
  color:#fff;
}
.wizard-line{
  height:4px;
  background:var(--lp-border);
  border-radius:999px;
  transition:.2s ease;
}
.wizard-line.filled{
  background:linear-gradient(90deg,var(--sun-300),var(--teal-500));
}

.wizard-item {
  display: flex;
  flex-direction: column;
  align-items: center;
}
.wizard-item-center {
  min-width: 100px;
}
.wizard-label {
  font-family: 'Fredoka', 'Nunito', sans-serif;
  font-size: 0.95rem;
  font-weight: 500;
  white-space: nowrap;
}

/* Inputs */
.lp-input .input-group-text{
  border-radius:1.25rem 0 0 1.25rem;
  background:#f1f5f9;
  color:var(--coral-500);
  font-size:1.25rem;
}
.lp-input .form-control,
.lp-input .form-select{
  border-radius:1.25rem;
  padding: 0.6rem 1rem;
  font-size: 1.1rem;
}
.lp-input .form-control{
  border-radius:0 1.25rem 1.25rem 0;
}

/* Toggles */
.toggle-row{
  border-radius:18px;
  background:#fff;
  border:2px solid rgba(254,215,170,.9);
  padding: 0.75rem 1rem;
  box-shadow: 0 1px 3px rgba(0,0,0,0.08);
}
.toggle-icon-wrap{
  width:40px;height:40px;
  border-radius:999px;
  background:#fee2e2;
  display:flex;align-items:center;justify-content:center;
  color:#fb7185;
  font-size: 1.2rem;
}
.toggle-icon-cover{
  background:#ccfbf1;
  color:#0f766e;
}
.toggle-title{
  font-size:1.1rem;font-weight:600;
  line-height: 1.1;
}
.toggle-sub{
  font-size:.85rem;
  color:#6b7280;
}

/* Switch */
.lp-switch .form-check-input{
  width:3.5rem;height:1.8rem;
  background:#e5e7eb;
  border-color:#e5e7eb;
  border-radius:999px;
  position:relative;
}
.lp-switch .form-check-input::before{
  inset:4px auto 4px 4px;
  width:1.4rem;
}
.lp-switch .form-check-input:checked{
  background:linear-gradient(90deg,#22c55e,#14b8a6);
}
.lp-switch .form-check-input:checked::before{
  inset:4px 4px 4px auto;
}

/* Buttons */
.btn-sky-solid{
  background:var(--coral-500);
  border-color:var(--coral-500);
  border-radius:999px;
  box-shadow:0 8px 18px rgba(255,107,107,.35);
  font-family:"Baloo 2", system-ui;
  font-weight: 700;
  color: white;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}
.btn-sky-solid:hover {
  transform: translateY(-2px);
  box-shadow: 0 10px 20px rgba(255,107,107,.45);
}
.btn-outline-secondary {
  border-radius: 999px;
  font-weight: 600;
}
.btn-lg {
  padding: 0.75rem 1.5rem;
  font-size: 1.1rem;
}

/* Overlay + spinner */
.gen-overlay{
  position:fixed;
  inset:0;
  display:grid;
  place-items:center;
  background:rgba(15,23,42,.45);
  backdrop-filter:blur(5px);
  z-index:2000;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.3s;
}
.gen-overlay[aria-hidden="false"] {
  opacity: 1;
  visibility: visible;
}
.rainbow-spinner-box{
  text-align:center;
  padding:2.5rem 3rem;
  border-radius:1.5rem;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}
.rainbow-spinner{
  width:80px;
  height:80px;
  border:10px solid transparent;
  border-top-color:#ff6b6b;
  border-right-color:#ffd93d;
  border-bottom-color:#6bcb77;
  border-left-color:#4d96ff;
  animation:rainbowSpin 1.1s linear infinite;
  box-shadow:0 6px 16px rgba(0,0,0,.3);
}
@keyframes rainbowSpin{
  0%{ transform:rotate(0deg); }
  100%{ transform:rotate(360deg); }
}
.rainbow-text{
  text-shadow:0 2px 8px rgba(0,0,0,.45);
  font-family: 'Baloo 2', cursive;
}

/* Modal */
.modal-content {
  background: #fffdf8;
  border: 2px solid #ffefe2;
  box-shadow: 0 12px 25px rgba(0, 0, 0, 0.15);
}
.modal-title.small-title {
  font-size: 1.5rem;
}
.modal-footer {
  padding-top: 0;
}
</style>

<script>
(function(){
  const form = document.getElementById('storyForm');
  const overlay = document.getElementById('genOverlay');
  const genBtn = document.getElementById('genBtn');
  const prevBtn = document.getElementById('wizardPrev');

  const steps = Array.from(document.querySelectorAll('.wizard-step'));
  const dots  = Array.from(document.querySelectorAll('.wizard-dot'));
  const lines = Array.from(document.querySelectorAll('.wizard-line'));

  const labelNext     = genBtn.querySelector('.label-next');
  const labelGenerate = genBtn.querySelector('.label-generate');

  let current = 0;

  function update(){
    steps.forEach((step,i)=> step.classList.toggle('d-none', i!==current));
    dots.forEach((dot,i)=>{
      dot.classList.toggle('active', i===current);
      dot.classList.toggle('completed', i<current);
    });
    lines.forEach((line,i)=> line.classList.toggle('filled', i<current));

    prevBtn.disabled = current===0;

    const last = current===steps.length-1;
    labelNext.classList.toggle('d-none', last);
    labelGenerate.classList.toggle('d-none', !last);
  }

  genBtn.addEventListener('click', ()=>{
    if(current === steps.length-1){
      form.requestSubmit();
    } else {
      current++;
      update();
    }
  });

  prevBtn.addEventListener('click', ()=>{
    if(current>0){
      current--;
      update();
    }
  });

  form.addEventListener('submit', ()=>{
    genBtn.disabled = true;
    overlay.setAttribute('aria-hidden', 'false');
  });

  update();

  // After redirect, show modal if ?generated=1
  const params = new URLSearchParams(window.location.search);
  if (params.get('generated') === '1') {
    const modalEl = document.getElementById('generatedModal');
    const goBtn = document.getElementById('goFinishBtn');
    const finishUrl = params.get('finish_url');

    if (finishUrl) goBtn.href = finishUrl;

    const showModal = () => {
      overlay.setAttribute('aria-hidden', 'true');
      if (window.bootstrap?.Modal) {
        new window.bootstrap.Modal(modalEl, { backdrop: 'static' }).show();
      }
    };

    if (document.readyState !== 'loading') showModal();
    else document.addEventListener('DOMContentLoaded', showModal, { once: true });
  }
})();
</script>

{% endblock %}
